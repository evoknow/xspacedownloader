{% extends "base.html" %}

{% block title %}XSpace Downloader - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4>Download X Space</h4>
            </div>
            <div class="card-body">
                <p class="lead">
                    Enter an X space URL to download. The download will be processed in the background, and you will receive an update when it's complete.
                </p>
                
                <form action="{{ url_for('submit_space') }}" method="POST" class="mt-4">
                    <div class="mb-3">
                        <label for="space_url" class="form-label">X Space URL</label>
                        <input type="url" class="form-control" id="space_url" name="space_url" 
                               placeholder="https://x.com/i/spaces/1dRJZEpyjlNGB" required>
                        <div class="form-text">
                            Enter the full URL of the X space you want to download.
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Submit for Download</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4>Download Queue Status</h4>
            </div>
            <div class="card-body">
                <div id="queue-status">
                    <p>Loading queue status...</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% if completed_spaces %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Recently Downloaded Spaces</h4>
                <a href="{{ url_for('all_spaces') }}" class="btn btn-outline-primary btn-sm">View All</a>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for job in completed_spaces %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <a href="{{ url_for('space_page', space_id=job.space_id) }}" class="text-decoration-none">
                                <h5 class="mb-1">
                                    {{ job.title if job.title else job.space_id }}
                                </h5>
                            </a>
                            <div class="d-flex align-items-center gap-2">
                                <small class="text-muted relative-time" data-datetime="{{ job.updated_at }}">{{ job.updated_at }}</small>
                                {% if job.playback_cnt or job.download_cnt %}
                                <small class="text-muted">
                                    {% if job.playback_cnt %}<i class="bi bi-play-circle" title="Plays"></i> {{ job.playback_cnt }}{% endif %}
                                    {% if job.download_cnt %}<i class="bi bi-download" title="Downloads"></i> {{ job.download_cnt }}{% endif %}
                                </small>
                                {% endif %}
                                <div class="d-flex gap-1">
                                    {% if job.has_transcript %}
                                    <span class="badge bg-info" data-bs-toggle="tooltip" data-bs-placement="top" title="Transcript available">
                                        <i class="bi bi-mic-fill"></i>
                                    </span>
                                    {% endif %}
                                    {% if job.has_translation %}
                                    <span class="badge bg-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Translation(s) available">
                                        <i class="bi bi-translate"></i>
                                    </span>
                                    {% endif %}
                                    {% if job.has_summary %}
                                    <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" data-bs-placement="top" title="Summary available">
                                        <i class="bi bi-lightbulb-fill"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <a href="{{ url_for('space_page', space_id=job.space_id) }}" class="btn btn-success btn-sm d-none d-sm-inline-block">
                                <i class="bi bi-play-circle"></i> Listen
                            </a>
                            <a href="{{ url_for('space_page', space_id=job.space_id) }}" class="btn btn-success btn-sm d-inline-block d-sm-none" title="Listen">
                                <i class="bi bi-play-circle"></i>
                            </a>
                            <a href="/download/{{ job.space_id }}?attachment=1" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Download MP3">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Function to update the queue status
    function updateQueueStatus() {
        fetch('/api/queue')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('queue-status').innerHTML = 
                        `<div class="alert alert-danger">Error loading queue status: ${data.error}</div>`;
                    return;
                }
                
                const statusHtml = `
                    <p>Currently <strong>${data.active}</strong> active downloads out of maximum ${data.max_concurrent}.</p>
                    <p>There are <strong>${data.pending}</strong> pending downloads in the queue.</p>
                `;
                
                document.getElementById('queue-status').innerHTML = statusHtml;
            })
            .catch(error => {
                console.error('Error fetching queue status:', error);
                document.getElementById('queue-status').innerHTML = 
                    `<div class="alert alert-danger">Error loading queue status. Please try again later.</div>`;
            });
    }
    
    // Function to convert datetime to relative time
    function timeAgo(datetime) {
        const date = new Date(datetime);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        
        const intervals = {
            year: 31536000,
            month: 2592000,
            week: 604800,
            day: 86400,
            hour: 3600,
            minute: 60
        };
        
        if (seconds < 60) {
            return 'just now';
        }
        
        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = Math.floor(seconds / secondsInUnit);
            if (interval >= 1) {
                return interval === 1 ? `1 ${unit} ago` : `${interval} ${unit}s ago`;
            }
        }
        
        return datetime; // fallback to original
    }
    
    // Function to update all relative times
    function updateRelativeTimes() {
        document.querySelectorAll('.relative-time').forEach(el => {
            const datetime = el.getAttribute('data-datetime');
            if (datetime) {
                el.textContent = timeAgo(datetime);
                el.title = datetime; // Show full date on hover
            }
        });
    }
    
    // Update status when page loads
    document.addEventListener('DOMContentLoaded', () => {
        updateQueueStatus();
        
        // Update every 30 seconds
        setInterval(updateQueueStatus, 30000);
        
        // Update relative times
        updateRelativeTimes();
        
        // Update relative times every minute
        setInterval(updateRelativeTimes, 60000);
        
        // Initialize Bootstrap tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    });
</script>
{% endblock %}