{% extends "base.html" %}

{% block title %}{{ space.title if space.title else space.space_id }} - XSpace Downloader{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>{{ space.title if space.title else "Space " + space.space_id }}</h4>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm">Back to Home</a>
            </div>
            <div class="card-body">
                <div class="space-details mb-4">
                    <h5>Space Details</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Space ID:</span>
                            <span class="badge bg-secondary rounded-pill">{{ space.space_id }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Space URL:</span>
                            <a href="{{ space.space_url }}" target="_blank" rel="noopener" class="text-truncate ms-2" 
                               style="max-width: 400px; display: inline-block;">{{ space.space_url }}</a>
                        </li>
                        {% if space.created_at %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Added on:</span>
                            <span>{{ space.created_at }}</span>
                        </li>
                        {% endif %}
                        {% if space.status %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Status:</span>
                            <span class="badge 
                                {% if space.status == 'completed' %}bg-success
                                {% elif space.status == 'downloading' %}bg-info
                                {% elif space.status == 'pending' %}bg-warning
                                {% elif space.status == 'failed' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ space.status|title }}
                            </span>
                        </li>
                        {% endif %}
                        {% if file_path %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>File Size:</span>
                            <span>{{ file_size|filesizeformat }}</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                {# Check if file exists, regardless of status #}
                {% if file_path is defined and file_path %}
                <div class="audio-player mb-4">
                    <h5>Audio Player</h5>
                    <div class="card">
                        <div class="card-header bg-primary bg-opacity-25">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ space.title if space.title else "Space " + space.space_id }}</span>
                                <div>
                                    <button id="transcribe-btn" class="btn btn-info btn-sm me-2" {% if space.transcripts %}data-has-transcript="true"{% endif %}>
                                        <i class="bi bi-file-earmark-text"></i> Transcribe
                                    </button>
                                    <a href="/download/{{ space.space_id }}?attachment=1" class="btn btn-primary btn-sm">
                                        <i class="bi bi-download"></i> Download
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <audio id="audio-player" controls class="w-100">
                                <source src="/download/{{ space.space_id }}" type="{{ content_type|default('audio/mpeg') }}">
                                Your browser does not support the audio element.
                            </audio>
                            
                            <div class="mt-3 d-flex justify-content-between flex-wrap">
                                <div class="me-3 mb-2">
                                    <label for="playback-speed" class="form-label">
                                        <i class="bi bi-speedometer2"></i> Playback Speed
                                    </label>
                                    <select id="playback-speed" class="form-select form-select-sm" style="width: auto;">
                                        <option value="0.50">0.50x</option>
                                        <option value="0.75">0.75x</option>
                                        <option value="1.00" selected>1.00x</option>
                                        <option value="1.25">1.25x</option>
                                        <option value="1.50">1.50x</option>
                                        <option value="1.75">1.75x</option>
                                        <option value="2.00">2.00x</option>
                                        <option value="2.50">2.50x</option>
                                        <option value="3.00">3.00x</option>
                                    </select>
                                </div>
                                
                                <div class="me-3 mb-2">
                                    <label for="volume" class="form-label">
                                        <i class="bi bi-volume-up"></i> Volume
                                    </label>
                                    <input type="range" class="form-range" min="0" max="1" step="0.05" id="volume" value="1">
                                </div>
                                
                                <div class="mb-2">
                                    <button id="skip-forward" class="btn btn-sm btn-outline-secondary me-1" title="Skip forward 30 seconds">
                                        <i class="bi bi-skip-forward"></i> 30s
                                    </button>
                                    <button id="skip-backward" class="btn btn-sm btn-outline-secondary" title="Skip backward 15 seconds">
                                        <i class="bi bi-skip-backward"></i> 15s
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transcript Section -->
                <div id="transcript-section" class="mb-4" style="display: {% if space.transcripts %}block{% else %}none{% endif %};">
                    <h5>Transcript</h5>
                    <div class="card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span>Audio Transcript</span>
                                    {% if space.transcripts %}
                                    <select id="language-selector" class="form-select form-select-sm ms-3" style="width: auto;">
                                        {% for transcript in space.transcripts %}
                                        <option value="{{ transcript.id }}">{{ transcript.language }}</option>
                                        {% endfor %}
                                    </select>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="input-group me-2 d-inline-flex" style="width: auto;">
                                        <select id="translate-target-lang" class="form-select form-select-sm">
                                            <option value="" selected>Translate to...</option>
                                            <option value="en">English</option>
                                            <option value="es">Spanish</option>
                                            <option value="fr">French</option>
                                            <option value="de">German</option>
                                            <option value="it">Italian</option>
                                            <option value="pt">Portuguese</option>
                                            <option value="bn">Bengali</option>
                                            <option value="zh">Chinese</option>
                                            <option value="ja">Japanese</option>
                                            <option value="ru">Russian</option>
                                        </select>
                                        <button id="translate-btn" class="btn btn-sm btn-outline-info">
                                            <i class="bi bi-translate"></i> Translate
                                        </button>
                                    </div>
                                    <button id="summarize-btn" class="btn btn-sm btn-outline-warning me-2">
                                        <i class="bi bi-file-earmark-text"></i> Summarize
                                    </button>
                                    <button id="transcript-copy-btn" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                    <button id="transcript-download-btn" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-download"></i> Download
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="transcript-content" class="transcript-text p-3" style="max-height: 400px; overflow-y: auto;">
                                {% if space.transcripts %}
                                <div class="transcript-loader text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading transcript...</p>
                                </div>
                                {% else %}
                                <div class="text-center py-4">
                                    <p class="text-muted">No transcript available yet. Click the Transcribe button to generate one.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% elif space._file_missing or ((file_path is not defined or not file_path) and space.status == 'completed') %}
                <div class="alert alert-warning">
                    <h5>File Missing</h5>
                    <p>The audio file for this space is not available. It might have been deleted or moved.</p>
                    <form action="{{ url_for('submit_space') }}" method="POST">
                        <input type="hidden" name="space_url" value="{{ space.space_url }}">
                        <button type="submit" class="btn btn-primary">Download Again</button>
                    </form>
                </div>
                {% elif space.status != 'completed' %}
                <div id="download-status-container" class="alert alert-info">
                    <h5>Download Status</h5>
                    {% if space.status == 'downloading' or space.status == 'in_progress' %}
                    <p id="download-message">This space is currently being downloaded. You'll be able to listen to it once the download is complete.</p>
                    <p id="download-progress">Current progress: <span id="progress-percent">{{ space.download_cnt }}</span>%</p>
                    <div class="progress" style="height: 20px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ space.download_cnt }}%;"
                             aria-valuenow="{{ space.download_cnt }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ space.download_cnt }}%
                        </div>
                    </div>
                    <div id="progress-size" class="mt-2">
                        {% if job and job.progress_in_size %}
                            Downloaded {{ job.progress_in_size|filesizeformat }} ({{ (job.progress_in_size / 1048576)|round(2) }} MB)
                        {% else %}
                            Waiting for download to start...
                        {% endif %}
                    </div>
                    {% elif space.status == 'pending' %}
                    <p id="download-message">This space is in the download queue. The download will start automatically.</p>
                    <div id="progress-container" class="d-none">
                        <p id="download-progress">Current progress: <span id="progress-percent">0</span>%</p>
                        <div class="progress" style="height: 20px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%;"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <div id="progress-size" class="mt-2">Waiting for download to start...</div>
                    </div>
                    {% elif space.status == 'failed' %}
                    <p id="download-message">The download for this space failed. You can try downloading it again.</p>
                    <form action="{{ url_for('submit_space') }}" method="POST">
                        <input type="hidden" name="space_url" value="{{ space.space_url }}">
                        <button type="submit" class="btn btn-primary">Try Downloading Again</button>
                    </form>
                    {% else %}
                    <p id="download-message">This space has status: {{ space.status }}</p>
                    <form action="{{ url_for('submit_space') }}" method="POST">
                        <input type="hidden" name="space_url" value="{{ space.space_url }}">
                        <button type="submit" class="btn btn-primary">Try Downloading</button>
                    </form>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <p>The audio file for this space is not available. It might have been deleted or moved.</p>
                    <a href="{{ url_for('submit_space') }}?space_url={{ space.space_url|urlencode }}" class="btn btn-primary">
                        Download Again
                    </a>
                </div>
                {% endif %}
                
                {% if job %}
                <div class="job-details mt-4">
                    <h5>Download Job Details</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Job ID:</span>
                            <span class="badge bg-secondary rounded-pill">{{ job.id }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Started:</span>
                            <span>{{ job.start_time }}</span>
                        </li>
                        {% if job.end_time %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Completed:</span>
                            <span>{{ job.end_time }}</span>
                        </li>
                        {% endif %}
                        {% if job.progress_in_size %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Download Size:</span>
                            <span>{{ job.progress_in_size|filesizeformat }} ({{ (job.progress_in_size / 1048576)|round(2) }} MB)</span>
                        </li>
                        {% endif %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>File Type:</span>
                            <span>{{ job.file_type }}</span>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audioPlayer = document.getElementById('audio-player');
        const spaceId = '{{ space.space_id }}';
        const spaceStatus = '{{ space.status }}';
        
        // Language code to name mapping
        const languageNames = {
            'en': 'English',
            'es': 'Spanish', 
            'fr': 'French',
            'de': 'German',
            'it': 'Italian',
            'pt': 'Portuguese',
            'hi': 'Hindi',
            'bn': 'Bengali',
            'ar': 'Arabic',
            'zh': 'Chinese',
            'ja': 'Japanese',
            'ko': 'Korean',
            'ru': 'Russian'
        };
        
        // Function to get language name from code
        function getLanguageName(code) {
            return languageNames[code] || code;
        }
        
        // Audio player setup
        if (audioPlayer) {
            // Playback speed control
            const playbackSpeed = document.getElementById('playback-speed');
            playbackSpeed.addEventListener('change', function() {
                audioPlayer.playbackRate = parseFloat(this.value);
            });
            
            // Volume control
            const volume = document.getElementById('volume');
            volume.addEventListener('input', function() {
                audioPlayer.volume = this.value;
            });
            
            // Remember playback position
            const storageKey = 'xspace_position_' + spaceId;
            
            // Load saved position
            const savedPosition = localStorage.getItem(storageKey);
            if (savedPosition) {
                audioPlayer.currentTime = parseFloat(savedPosition);
            }
            
            // Save position every 5 seconds
            setInterval(() => {
                if (!audioPlayer.paused) {
                    localStorage.setItem(storageKey, audioPlayer.currentTime.toString());
                }
            }, 5000);
            
            // Save position on pause/stop
            audioPlayer.addEventListener('pause', () => {
                localStorage.setItem(storageKey, audioPlayer.currentTime.toString());
            });
            
            // Save speed preference
            const speedKey = 'xspace_speed';
            const savedSpeed = localStorage.getItem(speedKey);
            if (savedSpeed) {
                audioPlayer.playbackRate = parseFloat(savedSpeed);
                playbackSpeed.value = savedSpeed;
            }
            
            playbackSpeed.addEventListener('change', function() {
                localStorage.setItem(speedKey, this.value);
            });
            
            // Skip forward/backward buttons
            const skipForward = document.getElementById('skip-forward');
            const skipBackward = document.getElementById('skip-backward');
            
            if (skipForward) {
                skipForward.addEventListener('click', function() {
                    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 30, audioPlayer.duration);
                });
            }
            
            if (skipBackward) {
                skipBackward.addEventListener('click', function() {
                    audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 15, 0);
                });
            }
            
            // Add time display element
            audioPlayer.addEventListener('loadedmetadata', function() {
                if (!document.getElementById('time-display')) {
                    const timeDisplay = document.createElement('div');
                    timeDisplay.id = 'time-display';
                    timeDisplay.className = 'mt-2 text-muted small';
                    audioPlayer.parentNode.insertBefore(timeDisplay, audioPlayer.nextSibling);
                }
                updateTimeDisplay();
            });
            
            audioPlayer.addEventListener('timeupdate', updateTimeDisplay);
            
            function updateTimeDisplay() {
                const timeDisplay = document.getElementById('time-display');
                if (timeDisplay && !isNaN(audioPlayer.duration)) {
                    const currentMinutes = Math.floor(audioPlayer.currentTime / 60);
                    const currentSeconds = Math.floor(audioPlayer.currentTime % 60);
                    const durationMinutes = Math.floor(audioPlayer.duration / 60);
                    const durationSeconds = Math.floor(audioPlayer.duration % 60);
                    
                    timeDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
                }
            }
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Only if audio player is in view
                const rect = audioPlayer.getBoundingClientRect();
                const isInView = (rect.top >= 0 && rect.bottom <= window.innerHeight);
                
                if (isInView) {
                    // Right arrow - skip forward 30s
                    if (e.key === 'ArrowRight') {
                        audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 30, audioPlayer.duration);
                    }
                    
                    // Left arrow - skip backward 15s
                    if (e.key === 'ArrowLeft') {
                        audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 15, 0);
                    }
                    
                    // Space - play/pause (only if no input is focused)
                    if (e.key === ' ' && document.activeElement.tagName !== 'INPUT' && 
                        document.activeElement.tagName !== 'TEXTAREA' && 
                        document.activeElement.tagName !== 'SELECT') {
                        e.preventDefault();
                        if (audioPlayer.paused) {
                            audioPlayer.play();
                        } else {
                            audioPlayer.pause();
                        }
                    }
                }
            });
        }
        
        // Transcription functionality
        const transcribeBtn = document.getElementById('transcribe-btn');
        const transcriptSection = document.getElementById('transcript-section');
        const transcriptContent = document.getElementById('transcript-content');
        
        // Summary functionality
        const summarizeBtn = document.getElementById('summarize-btn');
        
        // Store the full transcript text in JavaScript variable (more reliable than HTML attributes)
        let fullTranscriptText = '';
        
        // Simple toast notification function
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 350px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add to body
            document.body.appendChild(toast);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 4000);
        }
        
        if (transcribeBtn) {
            transcribeBtn.addEventListener('click', function() {
                // Disable button during transcription
                transcribeBtn.disabled = true;
                transcribeBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Transcribing...';
                
                // Request permissions for notifications
                if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
                
                // Make API request to start transcription directly with English defaults
                fetch(`/api/transcribe/${spaceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        language: 'en',
                        model: 'base',
                        detect_language: false,
                        translate_to: null,
                        overwrite: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Show error
                        alert('Transcription failed: ' + data.error);
                        // Reset button
                        transcribeBtn.disabled = false;
                        transcribeBtn.innerHTML = '<i class="bi bi-mic"></i> Transcribe';
                        return;
                    }
                    
                    if (data.from_database && data.transcript_id) {
                        // Transcript already exists in database - show it immediately
                        console.log('Using existing transcript from database (transcript_id:', data.transcript_id, ')');
                        transcribeBtn.disabled = false;
                        transcribeBtn.innerHTML = '<i class="bi bi-mic"></i> Transcribe';
                        
                        // Load and show the transcript
                        loadTranscript(data.transcript_id);
                        transcriptSection.style.display = 'block';
                        
                        // Show success notification for database retrieval
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('Transcript Loaded', {
                                body: 'Existing transcript loaded from database',
                                icon: '/static/favicon.ico'
                            });
                        }
                        
                        // Show toast/alert for immediate feedback
                        showToast('Transcript loaded from database', 'success');
                        
                    } else if (data.job_id) {
                        // Start polling for progress - new transcription
                        console.log('Starting new transcription with job ID:', data.job_id);
                        const jobId = data.job_id;
                        pollTranscriptionProgress(jobId);
                        
                    } else if (data.transcript_id) {
                        // Fallback: transcription completed immediately (shouldn't happen with new flow)
                        transcribeBtn.disabled = false;
                        transcribeBtn.innerHTML = '<i class="bi bi-mic"></i> Transcribe';
                        
                        // Load and show the transcript
                        loadTranscript(data.transcript_id);
                        transcriptSection.style.display = 'block';
                        
                        // Show success notification
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('Transcription Complete', {
                                body: 'The transcript is ready to view.',
                                icon: '/static/favicon.ico'
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while starting transcription.');
                    // Reset button
                    transcribeBtn.disabled = false;
                    transcribeBtn.innerHTML = '<i class="bi bi-mic"></i> Transcribe';
                });
            });
        }
        
        // Function to load transcript content
        function loadTranscript(transcriptId) {
            fetch(`/api/transcript/${transcriptId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        transcriptContent.innerHTML = `
                            <div class="alert alert-danger">
                                ${data.error}
                            </div>
                        `;
                    } else {
                        // Store the full transcript text in JavaScript variable (safer than HTML attributes)
                        fullTranscriptText = data.transcript;
                        
                        // Format text for display
                        const formattedText = data.transcript.replace(/\n/g, '</p><p>');
                        
                        transcriptContent.innerHTML = `
                            <div class="transcript-text">
                                <p>${formattedText}</p>
                            </div>
                        `;
                        
                        // Clear any previous translation selection
                        document.getElementById('translate-target-lang').value = '';
                        
                        // Store the source language code
                        transcriptContent.setAttribute('data-source-lang', data.language ? data.language.split('-')[0] : 'en');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    transcriptContent.innerHTML = `
                        <div class="alert alert-danger">
                            An error occurred while loading the transcript.
                        </div>
                    `;
                });
        }
        
        // Function to check translation service availability
        function checkTranslationService() {
            return new Promise((resolve, reject) => {
                // Simple health check request to the translation API
                fetch('/api/translate/info', { 
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        reject(new Error('Translation service unavailable'));
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.available) {
                        resolve(data);
                    } else {
                        reject(new Error('Translation service configuration issue'));
                    }
                })
                .catch(error => {
                    reject(error);
                });
            });
        }
        
        // Function to reset transcript view to original content
        function resetTranscriptView() {
            const originalText = fullTranscriptText || transcriptContent.getAttribute('data-original-text') || '';
            const formattedOriginalText = originalText.replace(/\n/g, '</p><p>');
            transcriptContent.innerHTML = `
                <div class="transcript-text">
                    <p>${formattedOriginalText}</p>
                </div>
            `;
            // Reset the translation dropdown
            document.getElementById('translate-target-lang').value = '';
        }
        
        // Function to translate transcript content
        function translateTranscript(sourceText, sourceLang, targetLang) {
            // Show loading indicator
            transcriptContent.innerHTML = `
                <div class="transcript-loader text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Translating...</span>
                    </div>
                    <p class="mt-2">Translating to ${getLanguageName(targetLang)}...</p>
                </div>
            `;
            
            // First check if translation service is available
            checkTranslationService()
                .catch(error => {
                    // Service check failed, show a helpful message
                    transcriptContent.innerHTML = `
                        <div class="alert alert-danger">
                            <div><i class="bi bi-exclamation-triangle-fill me-2"></i> Translation service is not available</div>
                            <p class="mt-2 mb-0">
                                <strong>Self-hosted mode:</strong> Make sure LibreTranslate is properly configured 
                                in <code>mainconfig.json</code> and the service is running.
                                Check <code>COMPONENTS.md</code> for setup instructions.
                            </p>
                        </div>
                    `;
                    // Rethrow to stop the translation process
                    throw error;
                })
                .then(() => {
                    // If service is available, proceed with the translation
                        return fetch('/api/translate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: sourceText,
                            source_lang: sourceLang,
                            target_lang: targetLang,
                            space_id: spaceId
                        })
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        let errorMessage = data.error;
                        let helpText = '';
                        let setupInstructions = '';
                        
                        // Check for specific error types from our enhanced backend
                        if (data.details && data.details.setup_instructions) {
                            setupInstructions = `
                                <div class="mt-3 card border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="bi bi-info-circle-fill me-2"></i>Setup Instructions
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Option 1:</strong> ${data.details.setup_instructions.option1}</p>
                                        <p class="mb-0"><strong>Option 2:</strong> ${data.details.setup_instructions.option2}</p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (data.details && data.details.suggestion) {
                            helpText = `
                                <p class="mt-2 mb-0">
                                    <strong>Suggestion:</strong> ${data.details.suggestion}
                                </p>
                            `;
                        }
                        
                        // Check for common error patterns
                        if (errorMessage.includes('API key required') || errorMessage.includes('Authentication') || 
                            errorMessage.includes('authentication') || errorMessage.includes('requires API key')) {
                            // Only show LibreTranslate setup if we're actually in self-hosted mode
                            if (info && info.self_hosted && info.provider === "None") {
                                errorMessage = 'Translation API key is required or self-hosted setup needed';
                                helpText = `
                                    <p class="mt-2 mb-0">
                                        <strong>Quick Fix:</strong> Run <code>./setup_libretranslate_no_docker.sh</code> in your terminal
                                        to set up a free local translation server (no Docker required).
                                    </p>
                                `;
                            } else {
                                errorMessage = 'Translation failed due to API configuration';
                                helpText = `
                                    <p class="mt-2 mb-0">
                                        The AI translation service encountered an error. This may be temporary.
                                    </p>
                                `;
                            }
                        } else if (errorMessage.includes('connection refused') || errorMessage.includes('not found') || 
                                  errorMessage.includes('unreachable') || errorMessage.includes('unavailable')) {
                            errorMessage = 'Translation service is not available';
                            helpText = `
                                <p class="mt-2 mb-0">
                                    <strong>Self-hosted mode:</strong> You need to start your LibreTranslate server.
                                    Run these commands to start it:
                                    <code>cd libretranslate && source venv/bin/activate && libretranslate --host localhost --port 5000</code>
                                </p>
                            `;
                        }
                        
                        transcriptContent.innerHTML = `
                            <div class="alert alert-danger">
                                <div><i class="bi bi-exclamation-triangle-fill me-2"></i> <strong>Translation Error:</strong> ${errorMessage}</div>
                                ${helpText}
                                ${setupInstructions}
                                <div class="mt-3">
                                    <a href="javascript:void(0)" onclick="resetTranscriptView()" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-arrow-return-left"></i> Return to Original Text
                                    </a>
                                    <a href="/TRANSLATION.md" target="_blank" class="btn btn-sm btn-outline-info ms-2">
                                        <i class="bi bi-question-circle"></i> View Translation Documentation
                                    </a>
                                </div>
                            </div>
                        `;
                    } else {
                        // Format and display the translated text
                        const formattedText = data.translated_text.replace(/\n/g, '</p><p>');
                        transcriptContent.innerHTML = `
                            <div class="transcript-text translated">
                                <div class="alert alert-info mb-3">
                                    <small>
                                        <i class="bi bi-info-circle"></i> 
                                        This transcript has been translated from ${getLanguageName(data.source_lang)} to ${getLanguageName(data.target_lang)}.
                                        <a href="#" id="show-original">Show original</a>
                                    </small>
                                </div>
                                <p>${formattedText}</p>
                            </div>
                        `;
                    
                        // Store original text in a more reliable way
                        transcriptContent.setAttribute('data-original-text', sourceText);
                        
                        // Add event listener to "Show original" link
                        document.getElementById('show-original').addEventListener('click', function(e) {
                            e.preventDefault();
                            const originalText = fullTranscriptText || transcriptContent.getAttribute('data-original-text');
                            const formattedOriginalText = originalText.replace(/\n/g, '</p><p>');
                            transcriptContent.innerHTML = `
                                <div class="transcript-text">
                                    <div class="alert alert-success mb-3">
                                        <small>
                                            <i class="bi bi-check-circle"></i> 
                                            Showing original transcript.
                                        </small>
                                    </div>
                                    <p>${formattedOriginalText}</p>
                                </div>
                            `;
                            // Reset the translation dropdown
                            document.getElementById('translate-target-lang').value = '';
                        });
                    }
                })
                .catch(error => {
                    console.error('Error translating:', error);
                    transcriptContent.innerHTML = `
                        <div class="alert alert-danger">
                            <div><i class="bi bi-exclamation-triangle-fill me-2"></i> Translation failed</div>
                            <p class="mt-2 mb-0">An unexpected error occurred during translation. Please try again later.</p>
                        </div>
                    `;
                });
        }
        
        // Set up language selector
        const languageSelector = document.getElementById('language-selector');
        if (languageSelector) {
            languageSelector.addEventListener('change', function() {
                loadTranscript(this.value);
            });
            
            // Load initial transcript
            if (languageSelector.options.length > 0) {
                loadTranscript(languageSelector.value);
            }
        }
        
        // Set up transcript copy button
        const copyBtn = document.getElementById('transcript-copy-btn');
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                const text = transcriptContent.innerText;
                navigator.clipboard.writeText(text).then(
                    function() {
                        // Temporarily change button text to show success
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="bi bi-check"></i> Copied!';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                        }, 2000);
                    },
                    function(err) {
                        console.error('Could not copy text: ', err);
                        alert('Failed to copy transcript to clipboard');
                    }
                );
            });
        }
        
        // Function to poll transcription progress for direct transcription
        function pollTranscriptionProgress(jobId) {
            const pollInterval = setInterval(function() {
                fetch(`/api/transcript_job/${jobId}`)
                    .then(response => response.json())
                    .then(jobData => {
                        // Update button text with progress
                        if (jobData.progress) {
                            transcribeBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Transcribing... ${jobData.progress}%`;
                        }
                        
                        if (jobData.status === 'completed') {
                            // Stop polling
                            clearInterval(pollInterval);
                            
                            // Reset button
                            transcribeBtn.disabled = false;
                            transcribeBtn.innerHTML = '<i class="bi bi-mic"></i> Transcribe';
                            
                            // Show transcript section
                            transcriptSection.style.display = 'block';
                            
                            // Load transcript if available
                            if (jobData.result && jobData.result.transcript_id) {
                                loadTranscript(jobData.result.transcript_id);
                                
                                // Update language selector
                                const langSelector = document.getElementById('language-selector');
                                if (langSelector) {
                                    // Check if option already exists
                                    let optionExists = false;
                                    for (let i = 0; i < langSelector.options.length; i++) {
                                        if (langSelector.options[i].value == jobData.result.transcript_id) {
                                            optionExists = true;
                                            langSelector.selectedIndex = i;
                                            break;
                                        }
                                    }
                                    
                                    if (!optionExists) {
                                        // Add new option
                                        const option = document.createElement('option');
                                        option.value = jobData.result.transcript_id;
                                        option.text = jobData.result.language;
                                        option.selected = true;
                                        langSelector.appendChild(option);
                                    }
                                }
                            }
                            
                            // Show notification
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification('Transcription Complete', {
                                    body: 'The audio has been successfully transcribed.',
                                    icon: '/static/favicon.ico'
                                });
                            }
                        } else if (jobData.status === 'failed') {
                            // Stop polling
                            clearInterval(pollInterval);
                            
                            // Reset button
                            transcribeBtn.disabled = false;
                            transcribeBtn.innerHTML = '<i class="bi bi-mic"></i> Transcribe';
                            
                            // Show error
                            alert('Transcription failed: ' + (jobData.error || 'Unknown error occurred'));
                        }
                    })
                    .catch(error => {
                        console.error('Error polling transcription progress:', error);
                        // Continue polling on network errors
                    });
            }, 2000); // Poll every 2 seconds
        }
        
        // Set up translation functionality
        const translateBtn = document.getElementById('translate-btn');
        const translateSelect = document.getElementById('translate-target-lang');
        
        if (translateBtn && translateSelect) {
            translateBtn.addEventListener('click', function() {
                const targetLang = translateSelect.value;
                
                if (!targetLang) {
                    alert('Please select a language to translate to');
                    return;
                }
                
                // Get source language from data attribute or fallback to 'en'
                const sourceLang = transcriptContent.getAttribute('data-source-lang') || 'en';
                
                // Skip if source and target are the same
                if (sourceLang === targetLang) {
                    alert('Source and target languages are the same');
                    return;
                }
                
                // Get original text from JavaScript variable (most reliable)
                let sourceText = fullTranscriptText;
                
                // Fallback to data attributes if JavaScript variable is empty
                if (!sourceText) {
                    sourceText = transcriptContent.getAttribute('data-original-text');
                }
                
                // If still not found, try from the transcript text div
                if (!sourceText) {
                    const transcriptTextDiv = transcriptContent.querySelector('.transcript-text');
                    if (transcriptTextDiv && transcriptTextDiv.hasAttribute('data-original-text')) {
                        sourceText = transcriptTextDiv.getAttribute('data-original-text');
                    }
                }
                
                // Final fallback to current text content
                if (!sourceText) {
                    sourceText = transcriptContent.innerText.replace(/\s+/g, ' ').trim();
                }
                
                if (!sourceText) {
                    alert('No text to translate');
                    return;
                }
                
                // Debug logging
                console.log('Translation request - Text length:', sourceText.length);
                console.log('First 200 chars:', sourceText.substring(0, 200));
                console.log('Last 200 chars:', sourceText.substring(sourceText.length - 200));
                
                // Check translation service info first
                fetch('/api/translate/info')
                    .then(response => response.json())
                    .then(info => {
                        // Only show resource warning for self-hosted mode without AI APIs
                        const isAiAvailable = info.api_key_configured && info.provider !== "None";
                        const isLargeText = sourceText.length > 10000;
                        
                        if (isLargeText && !isAiAvailable && info.self_hosted) {
                            // Only warn for self-hosted mode without AI APIs
                            if (!confirm('The transcript is quite large (' + Math.round(sourceText.length/1000) + 'K characters). ' +
                                      'In self-hosted mode, this might cause issues if your server has limited resources. Continue anyway?')) {
                                return;
                            }
                        }
                        
                        // Proceed with translation
                        performTranslation(sourceText, sourceLang, targetLang);
                    })
                    .catch(error => {
                        console.warn('Could not check translation service info:', error);
                        // Proceed anyway if we can't check
                        performTranslation(sourceText, sourceLang, targetLang);
                    });
            });
        }
        
        // Helper function for translation
        function performTranslation(sourceText, sourceLang, targetLang) {
            // Call translation function
            translateTranscript(sourceText, sourceLang, targetLang);
        }
        
        // Set up summarize button
        if (summarizeBtn) {
            summarizeBtn.addEventListener('click', function() {
                // Get the current transcript ID from the language selector
                const languageSelector = document.getElementById('language-selector');
                if (!languageSelector || !languageSelector.value) {
                    showToast('Please select a transcript first', 'warning');
                    return;
                }
                
                const transcriptId = languageSelector.value;
                
                // Disable button and show loading state
                summarizeBtn.disabled = true;
                summarizeBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Summarizing...';
                
                // Make API request to get or generate summary
                fetch(`/api/transcript/${transcriptId}/summary`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        max_length: 200,  // Default to 200 words
                        force_regenerate: false
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Reset button
                    summarizeBtn.disabled = false;
                    summarizeBtn.innerHTML = '<i class="bi bi-file-earmark-text"></i> Summarize';
                    
                    if (data.success) {
                        // Show summary in a modal or alert
                        showSummaryModal(data);
                        
                        // Show appropriate toast message
                        if (data.from_database) {
                            showToast('Summary loaded from database', 'success');
                        } else {
                            showToast('Summary generated successfully', 'success');
                        }
                        
                    } else {
                        console.error('Summary failed:', data.error);
                        showToast('Summary failed: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Reset button
                    summarizeBtn.disabled = false;
                    summarizeBtn.innerHTML = '<i class="bi bi-file-earmark-text"></i> Summarize';
                    showToast('Error generating summary: ' + error.message, 'danger');
                });
            });
        }
        
        // Function to show summary as slideshow
        function showSummaryModal(data) {
            // Parse summary into bullet points or sentences
            const summaryPoints = parseSummaryIntoPoints(data.summary);
            
            // Store summary data globally
            window.currentSummaryData = data;
            window.summaryPoints = summaryPoints;
            window.currentSlide = 0;
            
            // Create slideshow HTML
            const slideshowHtml = `
                <div id="summarySlideshow" class="summary-slideshow">
                    <!-- Overlay background -->
                    <div class="slideshow-overlay" id="slideshow-overlay"></div>
                    
                    <!-- Main slideshow container -->
                    <div class="slideshow-container">
                        <!-- Header -->
                        <div class="slideshow-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">
                                        <i class="bi bi-file-earmark-text"></i> Transcript Summary
                                        ${data.from_database ? '<span class="badge bg-success ms-2">From Database</span>' : '<span class="badge bg-primary ms-2">AI Generated</span>'}
                                    </h5>
                                    <small class="text-muted">
                                        Language: ${data.language} | 
                                        ${summaryPoints.length} points |
                                        ${data.summary_length.toLocaleString()} chars
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" id="close-slideshow-btn">
                                    <i class="bi bi-x-lg"></i> Close
                                </button>
                            </div>
                        </div>
                        
                        <!-- Slide content -->
                        <div class="slideshow-content">
                            <div class="slide-counter">
                                <span id="slide-counter-text">1 / ${summaryPoints.length}</span>
                            </div>
                            
                            <div class="slide-area" id="slide-area">
                                <!-- Slides will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Navigation -->
                        <div class="slideshow-navigation">
                            <button class="btn btn-outline-primary" id="prev-slide">
                                <i class="bi bi-chevron-left"></i> Previous
                            </button>
                            
                            <div class="slide-indicators" id="slide-indicators">
                                <!-- Indicators will be populated here -->
                            </div>
                            
                            <button class="btn btn-outline-primary" id="next-slide">
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Actions -->
                        <div class="slideshow-actions">
                            <button class="btn btn-sm btn-outline-secondary" id="copy-summary-btn">
                                <i class="bi bi-clipboard"></i> Copy All
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="download-summary-btn">
                                <i class="bi bi-download"></i> Download
                            </button>
                            <button class="btn btn-sm btn-outline-info" id="autoplay-btn">
                                <i class="bi bi-play"></i> <span id="autoplay-text">Auto Play</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add CSS for slideshow
            const slideshowCSS = `
                <style>
                .summary-slideshow {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .slideshow-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(5px);
                }
                
                .slideshow-container {
                    position: relative;
                    width: 90%;
                    max-width: 800px;
                    height: 80%;
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                }
                
                .slideshow-header {
                    padding: 20px 25px 15px;
                    border-bottom: 1px solid #dee2e6;
                    background: #f8f9fa;
                }
                
                .slideshow-content {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    min-height: 0;
                }
                
                .slide-counter {
                    padding: 15px 25px 10px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #6c757d;
                    border-bottom: 1px solid #e9ecef;
                }
                
                .slide-area {
                    flex: 1;
                    padding: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    overflow-y: auto;
                    background: linear-gradient(45deg, #f0f2f5 0%, #e8ebf0 100%);
                }
                
                .slide {
                    display: none;
                    font-size: 1.4rem;
                    line-height: 1.8;
                    font-weight: 500;
                    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    animation: slideIn 0.6s ease-in-out;
                    max-width: 90%;
                    min-height: 200px;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    position: relative;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                }
                
                .slide.active {
                    display: flex;
                }
                
                .slide::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: inherit;
                    border-radius: inherit;
                    filter: blur(20px);
                    opacity: 0.3;
                    z-index: -1;
                }
                
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(30px) scale(0.95);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }
                
                .slideshow-navigation {
                    padding: 15px 25px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-top: 1px solid #dee2e6;
                    background: #f8f9fa;
                }
                
                .slide-indicators {
                    display: flex;
                    gap: 8px;
                }
                
                .slide-indicator {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: #dee2e6;
                    cursor: pointer;
                    transition: all 0.3s ease;
                }
                
                .slide-indicator.active {
                    background: #007bff;
                    transform: scale(1.2);
                }
                
                .slideshow-actions {
                    padding: 15px 25px;
                    display: flex;
                    justify-content: center;
                    gap: 10px;
                    border-top: 1px solid #dee2e6;
                }
                
                @media (max-width: 768px) {
                    .slideshow-container {
                        width: 95%;
                        height: 85%;
                    }
                    
                    .slide-area {
                        padding: 20px 20px;
                        font-size: 1.1rem;
                    }
                    
                    .slideshow-navigation {
                        flex-direction: column;
                        gap: 15px;
                    }
                    
                    .slideshow-actions {
                        flex-wrap: wrap;
                        gap: 8px;
                    }
                }
                </style>
            `;
            
            // Remove any existing slideshow
            const existingSlideshow = document.getElementById('summarySlideshow');
            if (existingSlideshow) {
                existingSlideshow.remove();
            }
            
            // Add CSS and slideshow to body
            document.head.insertAdjacentHTML('beforeend', slideshowCSS);
            document.body.insertAdjacentHTML('beforeend', slideshowHtml);
            
            // Initialize slideshow
            initializeSlideshow();
            
            // Add keyboard navigation
            document.addEventListener('keydown', handleSlideshowKeyboard);
            
            // Make sure functions are globally available for any inline calls
            window.toggleAutoplay = toggleAutoplay;
            window.copySummaryToClipboard = copySummaryToClipboard;
            window.downloadSummary = downloadSummary;
            window.changeSlide = changeSlide;
            window.goToSlide = goToSlide;
            window.closeSummarySlideshow = closeSummarySlideshow;
        }
        
        // Function to parse summary into individual points
        function parseSummaryIntoPoints(summary) {
            // Split by bullet points, numbered lists, or sentences
            let points = [];
            
            // First, try to split by bullet points or numbered lists
            if (summary.includes('') || summary.includes('*') || summary.includes('-')) {
                points = summary.split(/[*-]\s+/).filter(point => point.trim().length > 0);
            } else if (/^\d+\./.test(summary)) {
                points = summary.split(/\d+\.\s+/).filter(point => point.trim().length > 0);
            } else {
                // Fall back to sentences
                points = summary.split(/[.!?]+/).filter(point => point.trim().length > 20);
            }
            
            // Clean up points and ensure each is substantial
            points = points.map(point => point.trim().replace(/\n+/g, ' '))
                          .filter(point => point.length > 10)
                          .map(point => {
                              // Add period if missing
                              if (!point.match(/[.!?]$/)) {
                                  point += '.';
                              }
                              return point;
                          });
            
            // If we have too few points, create them artificially
            if (points.length < 3) {
                const sentences = summary.split(/[.!?]+/).filter(s => s.trim().length > 15);
                if (sentences.length > 1) {
                    points = sentences.map(s => s.trim()).filter(s => s.length > 0);
                } else {
                    // Single block - split into chunks
                    const words = summary.trim().split(' ');
                    const chunkSize = Math.ceil(words.length / 3);
                    points = [];
                    for (let i = 0; i < words.length; i += chunkSize) {
                        const chunk = words.slice(i, i + chunkSize).join(' ');
                        if (chunk.trim().length > 10) {
                            points.push(chunk.trim() + (chunk.match(/[.!?]$/) ? '' : '.'));
                        }
                    }
                }
            }
            
            return points.length > 0 ? points : [summary];
        }
        
        // Initialize slideshow functionality
        function initializeSlideshow() {
            console.log('Initializing slideshow with', window.summaryPoints.length, 'points');
            
            const slideArea = document.getElementById('slide-area');
            const slideIndicators = document.getElementById('slide-indicators');
            
            if (!slideArea || !slideIndicators) {
                console.error('Slide area or indicators not found');
                return;
            }
            
            // Clear existing content
            slideArea.innerHTML = '';
            slideIndicators.innerHTML = '';
            
            // Create slides with background themes
            window.summaryPoints.forEach((point, index) => {
                console.log('Creating slide', index, 'with content:', point.substring(0, 50) + '...');
                // Create slide
                const slide = document.createElement('div');
                slide.className = `slide ${index === 0 ? 'active' : ''}`;
                slide.innerHTML = point;
                
                // Add background gradient based on slide index
                const backgroundStyle = getSlideBackground(index);
                slide.style.background = backgroundStyle;
                slide.style.borderRadius = '15px';
                slide.style.padding = '40px';
                slide.style.margin = '20px';
                slide.style.boxShadow = '0 8px 32px rgba(0,0,0,0.1)';
                slide.style.color = getTextColorForBackground(index);
                
                slideArea.appendChild(slide);
                
                // Create indicator
                const indicator = document.createElement('div');
                indicator.className = `slide-indicator ${index === 0 ? 'active' : ''}`;
                indicator.addEventListener('click', () => {
                    console.log('Indicator clicked for slide', index);
                    goToSlide(index);
                });
                slideIndicators.appendChild(indicator);
            });
            
            // Add event listeners to all buttons
            setTimeout(() => {
                const prevBtn = document.getElementById('prev-slide');
                const nextBtn = document.getElementById('next-slide');
                const copyBtn = document.getElementById('copy-summary-btn');
                const downloadBtn = document.getElementById('download-summary-btn');
                const autoplayBtn = document.getElementById('autoplay-btn');
                
                if (prevBtn) {
                    prevBtn.removeAttribute('onclick'); // Remove any inline onclick
                    prevBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        changeSlide(-1);
                    });
                }
                if (nextBtn) {
                    nextBtn.removeAttribute('onclick');
                    nextBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        changeSlide(1);
                    });
                }
                if (copyBtn) {
                    copyBtn.removeAttribute('onclick');
                    copyBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        copySummaryToClipboard();
                    });
                }
                if (downloadBtn) {
                    downloadBtn.removeAttribute('onclick');
                    downloadBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        downloadSummary();
                    });
                }
                if (autoplayBtn) {
                    autoplayBtn.removeAttribute('onclick');
                    autoplayBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleAutoplay();
                    });
                }
                
                // Add overlay click handler
                const overlay = document.getElementById('slideshow-overlay');
                if (overlay) {
                    overlay.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        closeSummarySlideshow();
                    });
                }
                
                // Add close button handler
                const closeBtn = document.getElementById('close-slideshow-btn');
                if (closeBtn) {
                    closeBtn.removeAttribute('onclick');
                    closeBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        closeSummarySlideshow();
                    });
                }
            }, 100); // Small delay to ensure DOM is ready
            
            // Update navigation buttons
            updateNavigationButtons();
        }
        
        // Get background gradient for slide based on content
        function getSlideBackground(index) {
            // Analyze the content to determine theme
            const slideContent = window.summaryPoints[index].toLowerCase();
            const themeBackgrounds = getThemeBasedBackground(slideContent);
            
            if (themeBackgrounds.length > 0) {
                return themeBackgrounds[index % themeBackgrounds.length];
            }
            
            // Fallback to beautiful gradient collection
            const backgrounds = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', // Purple-Blue (Tech)
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', // Pink-Red (Creative)
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', // Blue (Business)
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', // Green (Health/Nature)
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', // Pink-Yellow (Energy)
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', // Mint-Pink (Soft)
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)', // Coral-Pink (Warm)
                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)', // Peach (Friendly)
                'linear-gradient(135deg, #ff8177 0%, #ff867a 0%, #ff8c7f 21%, #f99185 52%, #cf556c 78%, #b12a5b 100%)', // Sunset
                'linear-gradient(135deg, #ebbba7 0%, #cfc7f8 100%)', // Lavender
                'linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%)', // Cloud-Sky
                'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)', // Ocean Blue
                'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)', // Magenta
                'linear-gradient(135deg, #fdcb6e 0%, #e17055 100%)', // Orange-Red
                'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)' // Purple
            ];
            
            return backgrounds[index % backgrounds.length];
        }
        
        // Get theme-based backgrounds based on content analysis
        function getThemeBasedBackground(content) {
            // Technology themes
            if (content.match(/\b(technology|tech|software|app|digital|AI|artificial intelligence|machine learning|coding|programming|data|algorithm|computer|internet|web|mobile|startup|innovation)\b/i)) {
                return [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)',
                    'linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%)'
                ];
            }
            
            // Business/Finance themes
            if (content.match(/\b(business|finance|money|investment|market|economy|profit|revenue|growth|strategy|company|corporate|leadership|management|sales)\b/i)) {
                return [
                    'linear-gradient(135deg, #2d3436 0%, #636e72 100%)',
                    'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)',
                    'linear-gradient(135deg, #00b894 0%, #00cec9 100%)',
                    'linear-gradient(135deg, #fdcb6e 0%, #e17055 100%)'
                ];
            }
            
            // Health/Wellness themes
            if (content.match(/\b(health|wellness|fitness|medical|doctor|hospital|therapy|nutrition|exercise|mental|physical|healing|medicine|treatment)\b/i)) {
                return [
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                    'linear-gradient(135deg, #81ecec 0%, #74b9ff 100%)',
                    'linear-gradient(135deg, #55efc4 0%, #81ecec 100%)'
                ];
            }
            
            // Creative/Art themes
            if (content.match(/\b(art|creative|design|music|painting|drawing|photography|writing|artist|creative|aesthetic|beauty|color|visual)\b/i)) {
                return [
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                    'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)'
                ];
            }
            
            // Education/Learning themes
            if (content.match(/\b(education|learning|school|university|student|teacher|knowledge|study|research|academic|science|discovery|book|reading)\b/i)) {
                return [
                    'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                    'linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%)',
                    'linear-gradient(135deg, #ebbba7 0%, #cfc7f8 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
                ];
            }
            
            // Travel/Adventure themes
            if (content.match(/\b(travel|adventure|journey|explore|destination|vacation|trip|world|country|culture|experience|discover)\b/i)) {
                return [
                    'linear-gradient(135deg, #ff8177 0%, #ff867a 0%, #ff8c7f 21%, #f99185 52%, #cf556c 78%, #b12a5b 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                    'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)'
                ];
            }
            
            // Food/Cooking themes
            if (content.match(/\b(food|cooking|recipe|restaurant|chef|cuisine|meal|delicious|flavor|taste|kitchen|dining|ingredient)\b/i)) {
                return [
                    'linear-gradient(135deg, #fdcb6e 0%, #e17055 100%)',
                    'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
                ];
            }
            
            return []; // Return empty array if no theme matches
        }
        
        // Get appropriate text color for background
        function getTextColorForBackground(index) {
            // Alternate between white and dark text based on background
            const lightBackgrounds = [5, 6, 7, 10]; // Indices of lighter backgrounds
            
            if (lightBackgrounds.includes(index % 15)) {
                return '#2d3436'; // Dark text for light backgrounds
            } else {
                return '#ffffff'; // White text for dark backgrounds
            }
        }
        
        // Change slide function
        function changeSlide(direction) {
            console.log('changeSlide called with direction:', direction, 'current slide:', window.currentSlide);
            const newSlide = window.currentSlide + direction;
            
            if (newSlide >= 0 && newSlide < window.summaryPoints.length) {
                goToSlide(newSlide);
            } else {
                console.log('Cannot change slide - out of bounds:', newSlide, 'max:', window.summaryPoints.length - 1);
            }
        }
        
        // Go to specific slide
        function goToSlide(slideIndex) {
            console.log('goToSlide called with index:', slideIndex);
            
            // Update current slide
            window.currentSlide = slideIndex;
            
            // Update slides
            const slides = document.querySelectorAll('#summarySlideshow .slide');
            const indicators = document.querySelectorAll('#summarySlideshow .slide-indicator');
            
            console.log('Found slides:', slides.length, 'indicators:', indicators.length);
            
            slides.forEach((slide, index) => {
                if (index === slideIndex) {
                    slide.classList.add('active');
                    console.log('Activated slide', index);
                } else {
                    slide.classList.remove('active');
                }
            });
            
            indicators.forEach((indicator, index) => {
                if (index === slideIndex) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
            
            // Update counter
            const counterElement = document.getElementById('slide-counter-text');
            if (counterElement) {
                counterElement.textContent = `${slideIndex + 1} / ${window.summaryPoints.length}`;
            }
            
            // Update navigation buttons
            updateNavigationButtons();
        }
        
        // Update navigation button states
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-slide');
            const nextBtn = document.getElementById('next-slide');
            
            if (prevBtn) prevBtn.disabled = window.currentSlide === 0;
            if (nextBtn) nextBtn.disabled = window.currentSlide === window.summaryPoints.length - 1;
        }
        
        // Handle keyboard navigation
        function handleSlideshowKeyboard(event) {
            if (!document.getElementById('summarySlideshow')) return;
            
            switch(event.key) {
                case 'ArrowLeft':
                case 'ArrowUp':
                    event.preventDefault();
                    changeSlide(-1);
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                case ' ':
                    event.preventDefault();
                    changeSlide(1);
                    break;
                case 'Escape':
                    event.preventDefault();
                    closeSummarySlideshow();
                    break;
                case 'Home':
                    event.preventDefault();
                    goToSlide(0);
                    break;
                case 'End':
                    event.preventDefault();
                    goToSlide(window.summaryPoints.length - 1);
                    break;
            }
        }
        
        // Close slideshow
        function closeSummarySlideshow() {
            const slideshow = document.getElementById('summarySlideshow');
            if (slideshow) {
                slideshow.remove();
            }
            
            // Remove keyboard listener
            document.removeEventListener('keydown', handleSlideshowKeyboard);
            
            // Clean up global variables
            delete window.currentSummaryData;
            delete window.summaryPoints;
            delete window.currentSlide;
            delete window.autoplayInterval;
        }
        
        // Autoplay functionality
        function toggleAutoplay() {
            const autoplayText = document.querySelector('#autoplay-text');
            const autoplayIcon = document.querySelector('#autoplay-btn i');
            
            if (window.autoplayInterval) {
                // Stop autoplay
                clearInterval(window.autoplayInterval);
                delete window.autoplayInterval;
                if (autoplayText) autoplayText.textContent = 'Auto Play';
                if (autoplayIcon) autoplayIcon.className = 'bi bi-play';
            } else {
                // Start autoplay
                window.autoplayInterval = setInterval(() => {
                    if (window.currentSlide < window.summaryPoints.length - 1) {
                        changeSlide(1);
                    } else {
                        // Loop back to start
                        goToSlide(0);
                    }
                }, 4000); // 4 seconds per slide
                
                if (autoplayText) autoplayText.textContent = 'Stop';
                if (autoplayIcon) autoplayIcon.className = 'bi bi-pause';
            }
        }
        
        // Function to copy summary to clipboard
        function copySummaryToClipboard() {
            if (window.currentSummaryData) {
                navigator.clipboard.writeText(window.currentSummaryData.summary).then(() => {
                    showToast('Summary copied to clipboard', 'success');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('Failed to copy summary', 'danger');
                });
            }
        }
        
        // Function to download summary
        function downloadSummary() {
            if (window.currentSummaryData) {
                const blob = new Blob([window.currentSummaryData.summary], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `summary_${window.currentSummaryData.space_id}_${window.currentSummaryData.language}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        // Set up transcript download button
        const downloadBtn = document.getElementById('transcript-download-btn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                const text = transcriptContent.innerText;
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transcript_${spaceId}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
        
        // Download status tracking
        if (spaceStatus === 'pending' || spaceStatus === 'downloading' || spaceStatus === 'in_progress') {
            // Function to format file size
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
            
            // Function to update download status
            function updateDownloadStatus() {
                $.ajax({
                    url: '/api/space_status/' + spaceId,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        // If file exists and status is completed, reload the page
                        if (data.file_exists && data.status === 'completed') {
                            window.location.reload();
                            return;
                        }
                        
                        // Update status based on job data
                        if (data.job_status === 'in_progress' || data.job_status === 'downloading') {
                            // Show progress container if it's hidden
                            $('#progress-container').removeClass('d-none');
                            
                            // Update progress bar
                            const percent = data.progress_in_percent || 0;
                            $('#progress-bar').css('width', percent + '%');
                            $('#progress-bar').attr('aria-valuenow', percent);
                            $('#progress-bar').text(percent + '%');
                            $('#progress-percent').text(percent);
                            
                            // Update download size
                            if (data.progress_in_size) {
                                const sizeMB = (data.progress_in_size / (1024*1024)).toFixed(2);
                                $('#progress-size').text(`Downloaded ${formatBytes(data.progress_in_size)} (${sizeMB} MB)`);
                            }
                            
                            // Update message
                            $('#download-message').text('This space is currently being downloaded. You\'ll be able to listen to it once the download is complete.');
                        } 
                        else if (data.job_status === 'pending') {
                            $('#download-message').text('This space is in the download queue. The download will start automatically.');
                        }
                        else if (data.job_status === 'failed') {
                            // Update container class
                            $('#download-status-container').removeClass('alert-info').addClass('alert-danger');
                            
                            // Use the user-friendly error message from the backend
                            let errorMessage = data.error_message || 'The download for this space failed for an unknown reason.';
                            
                            // Update the message
                            $('#download-message').html(errorMessage + '<br><br>You can try downloading it again later.');
                            
                            // Show a try again button
                            if (!$('#try-again-btn').length) {
                                const tryAgainBtn = $('<a>', {
                                    href: "{{ url_for('submit_space') }}?space_url={{ space.space_url|urlencode }}",
                                    class: 'btn btn-primary mt-3',
                                    id: 'try-again-btn',
                                    text: 'Try Downloading Again'
                                });
                                $('#download-message').after(tryAgainBtn);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching space status:', error);
                    }
                });
            }
            
            // Update status when page loads
            updateDownloadStatus();
            
            // Variable to store the interval ID so we can clear it
            let statusInterval;
            
            // Function to check status and decide whether to continue polling
            function checkStatusAndUpdate() {
                $.ajax({
                    url: '/api/space_status/' + spaceId,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        // If the download is complete or failed, stop polling
                        if ((data.status === 'completed' || data.file_exists) || 
                            data.status === 'failed' || 
                            data.progress_in_percent >= 100) {
                            console.log('Download complete or failed, stopping automatic updates');
                            clearInterval(statusInterval);
                            
                            // Perform one final update
                            updateDownloadStatus();
                            
                            // If file exists and status is completed, reload after a short delay
                            if (data.file_exists && data.status === 'completed') {
                                setTimeout(function() {
                                    window.location.reload();
                                }, 1000);
                            }
                        } else {
                            // Still in progress, continue with normal updates
                            updateDownloadStatus();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error checking space status:', error);
                        // Continue with normal updates even on error
                        updateDownloadStatus();
                    }
                });
            }
            
            // Set interval for updates (every 5 seconds)
            statusInterval = setInterval(checkStatusAndUpdate, 5000);
        }
    });
</script>
{% endblock %}