{% extends "base.html" %}

{% block title %}{{ space.title if space.title else space.space_id }} - XSpace Downloader{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>{{ space.title if space.title else "Space " + space.space_id }}</h4>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-sm">Back to Home</a>
            </div>
            <div class="card-body">
                <div class="space-details mb-4">
                    <h5>Space Details</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Space ID:</span>
                            <span class="badge bg-secondary rounded-pill">{{ space.space_id }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Space URL:</span>
                            <a href="{{ space.space_url }}" target="_blank" rel="noopener" class="text-truncate ms-2" 
                               style="max-width: 400px; display: inline-block;">{{ space.space_url }}</a>
                        </li>
                        {% if space.created_at %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Added on:</span>
                            <span>{{ space.created_at }}</span>
                        </li>
                        {% endif %}
                        {% if space.status %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Status:</span>
                            <span class="badge 
                                {% if space.status == 'completed' %}bg-success
                                {% elif space.status == 'downloading' %}bg-info
                                {% elif space.status == 'pending' %}bg-warning
                                {% elif space.status == 'failed' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ space.status|title }}
                            </span>
                        </li>
                        {% endif %}
                        {% if file_path %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>File Size:</span>
                            <span>{{ file_size|filesizeformat }}</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                
                {# Check if file exists, regardless of status #}
                {% if file_path is defined and file_path %}
                <div class="audio-player mb-4">
                    <h5>Audio Player</h5>
                    <div class="card">
                        <div class="card-header bg-primary bg-opacity-25">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>{{ space.title if space.title else "Space " + space.space_id }}</span>
                                <a href="/download/{{ space.space_id }}?attachment=1" class="btn btn-primary btn-sm">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <audio id="audio-player" controls class="w-100">
                                <source src="/download/{{ space.space_id }}" type="{{ content_type|default('audio/mpeg') }}">
                                Your browser does not support the audio element.
                            </audio>
                            
                            <div class="mt-3 d-flex justify-content-between flex-wrap">
                                <div class="me-3 mb-2">
                                    <label for="playback-speed" class="form-label">
                                        <i class="bi bi-speedometer2"></i> Playback Speed
                                    </label>
                                    <select id="playback-speed" class="form-select form-select-sm" style="width: auto;">
                                        <option value="0.50">0.50x</option>
                                        <option value="0.75">0.75x</option>
                                        <option value="1.00" selected>1.00x</option>
                                        <option value="1.25">1.25x</option>
                                        <option value="1.50">1.50x</option>
                                        <option value="1.75">1.75x</option>
                                        <option value="2.00">2.00x</option>
                                        <option value="2.50">2.50x</option>
                                        <option value="3.00">3.00x</option>
                                    </select>
                                </div>
                                
                                <div class="me-3 mb-2">
                                    <label for="volume" class="form-label">
                                        <i class="bi bi-volume-up"></i> Volume
                                    </label>
                                    <input type="range" class="form-range" min="0" max="1" step="0.05" id="volume" value="1">
                                </div>
                                
                                <div class="mb-2">
                                    <button id="skip-forward" class="btn btn-sm btn-outline-secondary me-1" title="Skip forward 30 seconds">
                                        <i class="bi bi-skip-forward"></i> 30s
                                    </button>
                                    <button id="skip-backward" class="btn btn-sm btn-outline-secondary" title="Skip backward 15 seconds">
                                        <i class="bi bi-skip-backward"></i> 15s
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% elif space._file_missing or ((file_path is not defined or not file_path) and space.status == 'completed') %}
                <div class="alert alert-warning">
                    <h5>File Missing</h5>
                    <p>The audio file for this space is not available. It might have been deleted or moved.</p>
                    <form action="{{ url_for('submit_space') }}" method="POST">
                        <input type="hidden" name="space_url" value="{{ space.space_url }}">
                        <button type="submit" class="btn btn-primary">Download Again</button>
                    </form>
                </div>
                {% elif space.status != 'completed' %}
                <div id="download-status-container" class="alert alert-info">
                    <h5>Download Status</h5>
                    {% if space.status == 'downloading' or space.status == 'in_progress' %}
                    <p id="download-message">This space is currently being downloaded. You'll be able to listen to it once the download is complete.</p>
                    <p id="download-progress">Current progress: <span id="progress-percent">{{ space.download_cnt }}</span>%</p>
                    <div class="progress" style="height: 20px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ space.download_cnt }}%;"
                             aria-valuenow="{{ space.download_cnt }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ space.download_cnt }}%
                        </div>
                    </div>
                    <div id="progress-size" class="mt-2">
                        {% if job and job.progress_in_size %}
                            Downloaded {{ job.progress_in_size|filesizeformat }}
                        {% else %}
                            Waiting for download to start...
                        {% endif %}
                    </div>
                    {% elif space.status == 'pending' %}
                    <p id="download-message">This space is in the download queue. The download will start automatically.</p>
                    <div id="progress-container" class="d-none">
                        <p id="download-progress">Current progress: <span id="progress-percent">0</span>%</p>
                        <div class="progress" style="height: 20px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%;"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <div id="progress-size" class="mt-2">Waiting for download to start...</div>
                    </div>
                    {% elif space.status == 'failed' %}
                    <p id="download-message">The download for this space failed. You can try downloading it again.</p>
                    <form action="{{ url_for('submit_space') }}" method="POST">
                        <input type="hidden" name="space_url" value="{{ space.space_url }}">
                        <button type="submit" class="btn btn-primary">Try Downloading Again</button>
                    </form>
                    {% else %}
                    <p id="download-message">This space has status: {{ space.status }}</p>
                    <form action="{{ url_for('submit_space') }}" method="POST">
                        <input type="hidden" name="space_url" value="{{ space.space_url }}">
                        <button type="submit" class="btn btn-primary">Try Downloading</button>
                    </form>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <p>The audio file for this space is not available. It might have been deleted or moved.</p>
                    <a href="{{ url_for('submit_space') }}?space_url={{ space.space_url|urlencode }}" class="btn btn-primary">
                        Download Again
                    </a>
                </div>
                {% endif %}
                
                {% if job %}
                <div class="job-details mt-4">
                    <h5>Download Job Details</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Job ID:</span>
                            <span class="badge bg-secondary rounded-pill">{{ job.id }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Started:</span>
                            <span>{{ job.start_time }}</span>
                        </li>
                        {% if job.end_time %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Completed:</span>
                            <span>{{ job.end_time }}</span>
                        </li>
                        {% endif %}
                        {% if job.progress_in_size %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Download Size:</span>
                            <span>{{ job.progress_in_size|filesizeformat }}</span>
                        </li>
                        {% endif %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>File Type:</span>
                            <span>{{ job.file_type }}</span>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audioPlayer = document.getElementById('audio-player');
        const spaceId = '{{ space.space_id }}';
        const spaceStatus = '{{ space.status }}';
        
        // Audio player setup
        if (audioPlayer) {
            // Playback speed control
            const playbackSpeed = document.getElementById('playback-speed');
            playbackSpeed.addEventListener('change', function() {
                audioPlayer.playbackRate = parseFloat(this.value);
            });
            
            // Volume control
            const volume = document.getElementById('volume');
            volume.addEventListener('input', function() {
                audioPlayer.volume = this.value;
            });
            
            // Remember playback position
            const storageKey = 'xspace_position_' + spaceId;
            
            // Load saved position
            const savedPosition = localStorage.getItem(storageKey);
            if (savedPosition) {
                audioPlayer.currentTime = parseFloat(savedPosition);
            }
            
            // Save position every 5 seconds
            setInterval(() => {
                if (!audioPlayer.paused) {
                    localStorage.setItem(storageKey, audioPlayer.currentTime.toString());
                }
            }, 5000);
            
            // Save position on pause/stop
            audioPlayer.addEventListener('pause', () => {
                localStorage.setItem(storageKey, audioPlayer.currentTime.toString());
            });
            
            // Save speed preference
            const speedKey = 'xspace_speed';
            const savedSpeed = localStorage.getItem(speedKey);
            if (savedSpeed) {
                audioPlayer.playbackRate = parseFloat(savedSpeed);
                playbackSpeed.value = savedSpeed;
            }
            
            playbackSpeed.addEventListener('change', function() {
                localStorage.setItem(speedKey, this.value);
            });
            
            // Skip forward/backward buttons
            const skipForward = document.getElementById('skip-forward');
            const skipBackward = document.getElementById('skip-backward');
            
            if (skipForward) {
                skipForward.addEventListener('click', function() {
                    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 30, audioPlayer.duration);
                });
            }
            
            if (skipBackward) {
                skipBackward.addEventListener('click', function() {
                    audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 15, 0);
                });
            }
            
            // Add time display element
            audioPlayer.addEventListener('loadedmetadata', function() {
                if (!document.getElementById('time-display')) {
                    const timeDisplay = document.createElement('div');
                    timeDisplay.id = 'time-display';
                    timeDisplay.className = 'mt-2 text-muted small';
                    audioPlayer.parentNode.insertBefore(timeDisplay, audioPlayer.nextSibling);
                }
                updateTimeDisplay();
            });
            
            audioPlayer.addEventListener('timeupdate', updateTimeDisplay);
            
            function updateTimeDisplay() {
                const timeDisplay = document.getElementById('time-display');
                if (timeDisplay && !isNaN(audioPlayer.duration)) {
                    const currentMinutes = Math.floor(audioPlayer.currentTime / 60);
                    const currentSeconds = Math.floor(audioPlayer.currentTime % 60);
                    const durationMinutes = Math.floor(audioPlayer.duration / 60);
                    const durationSeconds = Math.floor(audioPlayer.duration % 60);
                    
                    timeDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
                }
            }
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Only if audio player is in view
                const rect = audioPlayer.getBoundingClientRect();
                const isInView = (rect.top >= 0 && rect.bottom <= window.innerHeight);
                
                if (isInView) {
                    // Right arrow - skip forward 30s
                    if (e.key === 'ArrowRight') {
                        audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 30, audioPlayer.duration);
                    }
                    
                    // Left arrow - skip backward 15s
                    if (e.key === 'ArrowLeft') {
                        audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 15, 0);
                    }
                    
                    // Space - play/pause (only if no input is focused)
                    if (e.key === ' ' && document.activeElement.tagName !== 'INPUT' && 
                        document.activeElement.tagName !== 'TEXTAREA' && 
                        document.activeElement.tagName !== 'SELECT') {
                        e.preventDefault();
                        if (audioPlayer.paused) {
                            audioPlayer.play();
                        } else {
                            audioPlayer.pause();
                        }
                    }
                }
            });
        }
        
        // Download status tracking
        if (spaceStatus === 'pending' || spaceStatus === 'downloading' || spaceStatus === 'in_progress') {
            // Function to format file size
            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }
            
            // Function to update download status
            function updateDownloadStatus() {
                $.ajax({
                    url: '/api/space_status/' + spaceId,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        // If file exists and status is completed, reload the page
                        if (data.file_exists && data.status === 'completed') {
                            window.location.reload();
                            return;
                        }
                        
                        // Update status based on job data
                        if (data.job_status === 'in_progress' || data.job_status === 'downloading') {
                            // Show progress container if it's hidden
                            $('#progress-container').removeClass('d-none');
                            
                            // Update progress bar
                            const percent = data.progress_in_percent || 0;
                            $('#progress-bar').css('width', percent + '%');
                            $('#progress-bar').attr('aria-valuenow', percent);
                            $('#progress-bar').text(percent + '%');
                            $('#progress-percent').text(percent);
                            
                            // Update download size
                            if (data.progress_in_size) {
                                $('#progress-size').text('Downloaded ' + formatBytes(data.progress_in_size));
                            }
                            
                            // Update message
                            $('#download-message').text('This space is currently being downloaded. You\'ll be able to listen to it once the download is complete.');
                        } 
                        else if (data.job_status === 'pending') {
                            $('#download-message').text('This space is in the download queue. The download will start automatically.');
                        }
                        else if (data.job_status === 'failed') {
                            // Update container class
                            $('#download-status-container').removeClass('alert-info').addClass('alert-danger');
                            
                            // Basic message
                            let errorMessage = 'The download for this space failed.';
                            
                            // Add specific error details if available
                            if (data.error_message) {
                                // Extract the most relevant part - remove technical details
                                let userFriendlyError = data.error_message;
                                
                                // For "not found" errors, give more specific message
                                if (data.error_message.includes('not found') || 
                                    data.error_message.includes('404') ||
                                    data.error_message.includes('unavailable')) {
                                    userFriendlyError = 'This space seems to be unavailable or may no longer exist.';
                                }
                                // For network errors, simplify the message
                                else if (data.error_message.includes('network error') || 
                                         data.error_message.includes('connection')) {
                                    userFriendlyError = 'There was a network issue while trying to download this space.';
                                }
                                
                                errorMessage += ' Error: ' + userFriendlyError;
                            }
                            
                            // Update the message
                            $('#download-message').html(errorMessage + '<br><br>You can try downloading it again later.');
                            
                            // Show a try again button
                            if (!$('#try-again-btn').length) {
                                const tryAgainBtn = $('<a>', {
                                    href: "{{ url_for('submit_space') }}?space_url={{ space.space_url|urlencode }}",
                                    class: 'btn btn-primary mt-3',
                                    id: 'try-again-btn',
                                    text: 'Try Downloading Again'
                                });
                                $('#download-message').after(tryAgainBtn);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching space status:', error);
                    }
                });
            }
            
            // Update status when page loads
            updateDownloadStatus();
            
            // Variable to store the interval ID so we can clear it
            let statusInterval;
            
            // Function to check status and decide whether to continue polling
            function checkStatusAndUpdate() {
                $.ajax({
                    url: '/api/space_status/' + spaceId,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        // If the download is complete or failed, stop polling
                        if ((data.status === 'completed' || data.file_exists) || 
                            data.status === 'failed' || 
                            data.progress_in_percent >= 100) {
                            console.log('Download complete or failed, stopping automatic updates');
                            clearInterval(statusInterval);
                            
                            // Perform one final update
                            updateDownloadStatus();
                            
                            // If file exists and status is completed, reload after a short delay
                            if (data.file_exists && data.status === 'completed') {
                                setTimeout(function() {
                                    window.location.reload();
                                }, 1000);
                            }
                        } else {
                            // Still in progress, continue with normal updates
                            updateDownloadStatus();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error checking space status:', error);
                        // Continue with normal updates even on error
                        updateDownloadStatus();
                    }
                });
            }
            
            // Set interval for updates (every 5 seconds)
            statusInterval = setInterval(checkStatusAndUpdate, 5000);
        }
    });
</script>
{% endblock %}