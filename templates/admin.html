{% extends "base.html" %}

{% block title %}Admin Dashboard - XSpace Downloader{% endblock %}

{% block head %}
<style>
.spin {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-speedometer2"></i> Admin Dashboard
    </h1>
    
    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-people-fill"></i> Total Users
                    </h5>
                    <h2 class="mb-0">{{ total_users }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-collection-play-fill"></i> Total Spaces
                    </h5>
                    <h2 class="mb-0">{{ total_spaces }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-download"></i> Total Downloads
                    </h5>
                    <h2 class="mb-0">{{ total_downloads }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-play-circle-fill"></i> Total Plays
                    </h5>
                    <h2 class="mb-0">{{ total_plays }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Monitoring -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-cpu"></i> System Resources
                        <span class="badge bg-success ms-2" id="systemStatus">Monitoring...</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- CPU Usage -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">
                                        <i class="bi bi-cpu"></i> CPU Usage
                                    </h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="cpuProgress" style="width: 0%">0%</div>
                                    </div>
                                    <small class="text-muted" id="cpuDetails">Loading...</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Memory Usage -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">
                                        <i class="bi bi-memory"></i> Memory Usage
                                    </h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="memoryProgress" style="width: 0%">0%</div>
                                    </div>
                                    <small class="text-muted" id="memoryDetails">Loading...</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- GPU Usage -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">
                                        <i class="bi bi-gpu-card"></i> GPU Usage
                                    </h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="gpuProgress" style="width: 0%">0%</div>
                                    </div>
                                    <small class="text-muted" id="gpuDetails">Loading...</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Disk Usage -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">
                                        <i class="bi bi-hdd"></i> Disk Usage
                                    </h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="diskProgress" style="width: 0%">0%</div>
                                    </div>
                                    <small class="text-muted" id="diskDetails">Loading...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                <i class="bi bi-people"></i> Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="spaces-tab" data-bs-toggle="tab" data-bs-target="#spaces" type="button" role="tab">
                <i class="bi bi-collection-play"></i> Spaces
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button" role="tab">
                <i class="bi bi-list-ol"></i> Queue
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
                <i class="bi bi-graph-up"></i> Statistics
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                <i class="bi bi-gear"></i> Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                <i class="bi bi-file-text"></i> Logs
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sql-tab" data-bs-toggle="tab" data-bs-target="#sql" type="button" role="tab">
                <i class="bi bi-database"></i> SQL
            </button>
        </li>
        {% if is_localhost %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="development-tab" data-bs-toggle="tab" data-bs-target="#development" type="button" role="tab">
                <i class="bi bi-code-slash text-warning"></i> Development
            </button>
        </li>
        {% endif %}
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="adminTabContent">
        <!-- Users Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title">Manage Users</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="userSearch" placeholder="Search by email...">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchUsers()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Admin</th>
                                    <th>Country</th>
                                    <th>Logins</th>
                                    <th>Spaces</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                                <tr>
                                    <td colspan="9" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination justify-content-center" id="usersPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Spaces Tab -->
        <div class="tab-pane fade" id="spaces" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title">Manage Spaces</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="spaceSearch" placeholder="Search spaces...">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchSpaces()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Host</th>
                                    <th>User</th>
                                    <th>Downloads</th>
                                    <th>Plays</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spacesList">
                                <tr>
                                    <td colspan="7" class="text-center">Loading spaces...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination justify-content-center" id="spacesPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Queue Management Tab -->
        <div class="tab-pane fade" id="queue" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title">
                                <i class="bi bi-list-task"></i> Queue Management
                            </h5>
                            <p class="text-muted">Manage all queue types: downloads, transcriptions, translations, and video generation</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-outline-primary" onclick="refreshAllQueues()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Queue Type Tabs -->
                    <ul class="nav nav-pills mb-4" id="queueTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="download-queue-tab" data-bs-toggle="pill" 
                                    data-bs-target="#download-queue" type="button" role="tab">
                                <i class="bi bi-download"></i> Downloads
                                <span class="badge bg-secondary ms-1" id="downloadQueueBadge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="transcription-queue-tab" data-bs-toggle="pill" 
                                    data-bs-target="#transcription-queue" type="button" role="tab">
                                <i class="bi bi-mic"></i> Transcriptions
                                <span class="badge bg-secondary ms-1" id="transcriptionQueueBadge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="translation-queue-tab" data-bs-toggle="pill" 
                                    data-bs-target="#translation-queue" type="button" role="tab">
                                <i class="bi bi-translate"></i> Translations
                                <span class="badge bg-secondary ms-1" id="translationQueueBadge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="video-queue-tab" data-bs-toggle="pill" 
                                    data-bs-target="#video-queue" type="button" role="tab">
                                <i class="bi bi-camera-video"></i> Videos
                                <span class="badge bg-secondary ms-1" id="videoQueueBadge">0</span>
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="queueTypeTabContent">
                        
                        <!-- Download Queue Tab -->
                        <div class="tab-pane fade show active" id="download-queue" role="tabpanel">
                            <!-- Queue Status -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-clock"></i> Pending
                                            </h6>
                                            <h3 class="mb-0" id="downloadPendingCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-download"></i> In Progress
                                            </h6>
                                            <h3 class="mb-0" id="downloadProgressCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-check-circle"></i> Completed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="downloadCompletedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-x-circle"></i> Failed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="downloadFailedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pending Jobs -->
                            <div class="mb-4">
                                <h6>Pending Jobs (ordered by priority)</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Space ID</th>
                                                <th>User</th>
                                                <th>Priority</th>
                                                <th>Created</th>
                                                <th>File Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadPendingList">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading pending jobs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- In Progress Jobs -->
                            <div>
                                <h6>Jobs In Progress</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Space ID</th>
                                                <th>User</th>
                                                <th>Priority</th>
                                                <th>Progress</th>
                                                <th>Started</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadProgressList">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading in-progress jobs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Completed Downloads -->
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-check-circle me-2"></i>Completed Downloads (Last 10)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Job ID</th>
                                                <th>Space ID</th>
                                                <th>Start Time</th>
                                                <th>End Time</th>
                                                <th>File Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadCompletedList">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading completed jobs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Failed Downloads -->
                            <div class="card mt-3">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-x-circle me-2"></i>Failed Downloads (Last 10)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Job ID</th>
                                                <th>Space ID</th>
                                                <th>Start Time</th>
                                                <th>Error</th>
                                                <th>File Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadFailedList">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading failed jobs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transcription Queue Tab -->
                        <div class="tab-pane fade" id="transcription-queue" role="tabpanel">
                            <!-- Queue Status -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-clock"></i> Pending
                                            </h6>
                                            <h3 class="mb-0" id="transcriptionPendingCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-mic"></i> Processing
                                            </h6>
                                            <h3 class="mb-0" id="transcriptionProgressCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-check-circle"></i> Completed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="transcriptionCompletedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-x-circle"></i> Failed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="transcriptionFailedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Transcription Jobs -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Job ID</th>
                                            <th>Space ID</th>
                                            <th>Model</th>
                                            <th>Language</th>
                                            <th>Status</th>
                                            <th>Progress</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transcriptionJobsList">
                                        <tr>
                                            <td colspan="8" class="text-center">Loading transcription jobs...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Translation Queue Tab -->
                        <div class="tab-pane fade" id="translation-queue" role="tabpanel">
                            <!-- Queue Status -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-clock"></i> Pending
                                            </h6>
                                            <h3 class="mb-0" id="translationPendingCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-translate"></i> Processing
                                            </h6>
                                            <h3 class="mb-0" id="translationProgressCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-check-circle"></i> Completed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="translationCompletedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Translation Jobs -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Job ID</th>
                                            <th>Space ID</th>
                                            <th>From Language</th>
                                            <th>To Language</th>
                                            <th>Status</th>
                                            <th>Progress</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="translationJobsList">
                                        <tr>
                                            <td colspan="8" class="text-center">Loading translation jobs...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Video Generation Queue Tab -->
                        <div class="tab-pane fade" id="video-queue" role="tabpanel">
                            <!-- Queue Status -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-clock"></i> Pending
                                            </h6>
                                            <h3 class="mb-0" id="videoPendingCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-camera-video"></i> Generating
                                            </h6>
                                            <h3 class="mb-0" id="videoProgressCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-check-circle"></i> Completed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="videoCompletedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Video Generation Jobs -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Job ID</th>
                                            <th>Space ID</th>
                                            <th>User</th>
                                            <th>Status</th>
                                            <th>Progress</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="videoJobsList">
                                        <tr>
                                            <td colspan="7" class="text-center">Loading video generation jobs...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Tab -->
        <div class="tab-pane fade" id="stats" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Site Statistics</h5>
                    
                    <!-- Period Selection -->
                    <div class="btn-group mb-3" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="changePeriod('daily')">Daily</button>
                        <button type="button" class="btn btn-outline-primary" onclick="changePeriod('weekly')">Weekly</button>
                        <button type="button" class="btn btn-outline-primary" onclick="changePeriod('monthly')">Monthly</button>
                        <button type="button" class="btn btn-outline-primary" onclick="changePeriod('all')">All Time</button>
                    </div>
                    
                    <!-- Statistics Cards -->
                    <div class="row">
                        <!-- Space Submissions Chart -->
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Space Submissions</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="submissionsChart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Popular Spaces -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Most Played Spaces</h6>
                                </div>
                                <div class="card-body">
                                    <div id="popularSpacesList" class="list-group">
                                        <div class="text-center">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Most Downloaded -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Most Downloaded Spaces</h6>
                                </div>
                                <div class="card-body">
                                    <div id="downloadedSpacesList" class="list-group">
                                        <div class="text-center">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Active Users -->
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Most Active Users</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Email</th>
                                                    <th>Country</th>
                                                    <th>Logins</th>
                                                    <th>Spaces</th>
                                                    <th>Downloads</th>
                                                    <th>Plays</th>
                                                </tr>
                                            </thead>
                                            <tbody id="activeUsersList">
                                                <tr>
                                                    <td colspan="6" class="text-center">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">System Settings</h5>
                    
                    <!-- Cache Management Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-arrow-clockwise"></i> Cache Management</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">Manage application caches to ensure fresh data is displayed.</p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2">Current Cache Status</h6>
                                            <div id="cacheStatusInfo">
                                                <div class="text-center">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    Loading cache status...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2">Cache Actions</h6>
                                            <p class="mb-3">Clear all caches to force reload of fresh data from the database.</p>
                                            <button type="button" class="btn btn-warning" onclick="clearAllCaches()">
                                                <i class="bi bi-trash"></i> Clear All Caches
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3" style="display: none;" id="cacheMessage"></div>
                        </div>
                    </div>
                    
                    <!-- Rate Limiting Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-shield-check"></i> Rate Limiting Configuration</h6>
                        </div>
                        <div class="card-body">
                            <form id="rateLimitForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="dailyLimit" class="form-label">Daily Request Limit</label>
                                        <input type="number" class="form-control" id="dailyLimit" 
                                               value="{{ rate_limits.daily_limit if rate_limits else 200 }}" 
                                               min="1" max="10000">
                                        <div class="form-text">Maximum requests per day per IP address</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="hourlyLimit" class="form-label">Hourly Request Limit</label>
                                        <input type="number" class="form-control" id="hourlyLimit" 
                                               value="{{ rate_limits.hourly_limit if rate_limits else 50 }}" 
                                               min="1" max="1000">
                                        <div class="form-text">Maximum requests per hour per IP address</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="rateLimitEnabled" 
                                               {% if not rate_limits or rate_limits.enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="rateLimitEnabled">
                                            Enable Rate Limiting
                                        </label>
                                    </div>
                                    <div class="form-text">When disabled, no rate limits will be applied</div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Rate Limit Settings
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="rateLimitMessage"></div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Play/Download Tracking Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-graph-up"></i> Play & Download Tracking Configuration</h6>
                        </div>
                        <div class="card-body">
                            <form id="trackingConfigForm">
                                <!-- Play Tracking Settings -->
                                <h6 class="text-primary mb-3">Play Tracking Settings</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="playCooldownMinutes" class="form-label">Play Cooldown Period (minutes)</label>
                                        <input type="number" class="form-control" id="playCooldownMinutes" 
                                               value="30" min="1" max="1440">
                                        <div class="form-text">Time before a user can increment play count again</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="playMinDuration" class="form-label">Minimum Play Duration (seconds)</label>
                                        <input type="number" class="form-control" id="playMinDuration" 
                                               value="30" min="0" max="3600">
                                        <div class="form-text">Minimum duration required to count as a play (0 = disabled)</div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="playTrackingEnabled" checked>
                                        <label class="form-check-label" for="playTrackingEnabled">
                                            Enable Play Tracking
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Download Tracking Settings -->
                                <h6 class="text-primary mb-3">Download Tracking Settings</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="downloadDailyLimit" class="form-label">Daily Download Limit (per user per space)</label>
                                        <input type="number" class="form-control" id="downloadDailyLimit" 
                                               value="1" min="1" max="100">
                                        <div class="form-text">Maximum downloads per user per space per day</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="downloadHourlyIpLimit" class="form-label">Hourly IP Limit (all spaces)</label>
                                        <input type="number" class="form-control" id="downloadHourlyIpLimit" 
                                               value="10" min="1" max="1000">
                                        <div class="form-text">Maximum downloads per IP per hour across all spaces</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="downloadTrackingEnabled" checked>
                                        <label class="form-check-label" for="downloadTrackingEnabled">
                                            Enable Download Tracking
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Tracking Settings
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="trackingConfigMessage"></div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Transcription Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-mic"></i> Transcription Configuration</h6>
                        </div>
                        <div class="card-body">
                            <form id="transcriptionConfigForm">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Transcription Provider</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="transcriptionProvider" 
                                                   id="localWhisper" value="local" checked>
                                            <label class="form-check-label" for="localWhisper">
                                                <strong>Local Whisper</strong> - Uses local OpenAI Whisper models
                                            </label>
                                            <div class="form-text ms-4">
                                                <i class="bi bi-cpu text-info"></i> 
                                                CPU-intensive, free, works offline. Default model: tiny (fast), admin can upgrade to base.
                                            </div>
                                        </div>
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="radio" name="transcriptionProvider" 
                                                   id="openaiApi" value="openai">
                                            <label class="form-check-label" for="openaiApi">
                                                <strong>OpenAI API</strong> - Uses OpenAI's cloud transcription service
                                            </label>
                                            <div class="form-text ms-4">
                                                <i class="bi bi-cloud text-success"></i> 
                                                Fast, accurate, costs money per minute. Requires API key.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="openaiApiSettings" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label for="openaiApiKey" class="form-label">OpenAI API Key</label>
                                            <input type="password" class="form-control" id="openaiApiKey" 
                                                   placeholder="sk-...">
                                            <div class="form-text">
                                                <span id="apiKeyStatus">Your OpenAI API key for transcription service.</span>
                                                <br><small class="text-muted">Leave unchanged to keep existing key, or enter new key to update.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="openaiModel" class="form-label">Model</label>
                                            <select class="form-select" id="openaiModel">
                                                <option value="gpt-4o-mini-transcribe">gpt-4o-mini-transcribe (recommended - better & cheaper)</option>
                                                <option value="whisper-1">whisper-1 (legacy)</option>
                                            </select>
                                            <div class="form-text">OpenAI transcription model</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="localWhisperSettings">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="defaultWhisperModel" class="form-label">Default Whisper Model</label>
                                            <select class="form-select" id="defaultWhisperModel">
                                                <option value="tiny" selected>tiny (fastest, less accurate)</option>
                                                <option value="base">base (balanced)</option>
                                                <option value="small">small (slower, more accurate)</option>
                                                <option value="medium">medium (much slower, very accurate)</option>
                                                <option value="large">large (slowest, most accurate)</option>
                                            </select>
                                            <div class="form-text">Default model for new transcriptions</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="whisperDevice" class="form-label">Processing Device</label>
                                            <select class="form-select" id="whisperDevice">
                                                <option value="auto" selected>Auto-detect</option>
                                                <option value="cpu">CPU only</option>
                                                <option value="cuda">CUDA (NVIDIA GPU)</option>
                                            </select>
                                            <div class="form-text">Device for Whisper processing</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Corrective Filter Settings -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <hr>
                                        <h6 class="text-primary mb-3">Corrective Filter (Post-Processing)</h6>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableCorrectiveFilter">
                                            <label class="form-check-label" for="enableCorrectiveFilter">
                                                <strong>Enable Corrective Filter</strong>
                                            </label>
                                            <div class="form-text">
                                                Uses GPT to improve transcript accuracy by fixing spelling, punctuation, and common transcription errors.
                                                <br><small class="text-warning"> Requires OpenAI API key and will increase processing time and costs.</small>
                                            </div>
                                        </div>
                                        <div class="row" id="correctiveFilterSettings">
                                            <div class="col-md-6">
                                                <label for="correctionModel" class="form-label">Correction Model</label>
                                                <select class="form-select" id="correctionModel">
                                                    <option value="gpt-4o-mini">gpt-4o-mini (recommended - fast & cheap)</option>
                                                    <option value="gpt-4o">gpt-4o (higher quality, more expensive)</option>
                                                    <option value="gpt-3.5-turbo">gpt-3.5-turbo (legacy)</option>
                                                </select>
                                                <div class="form-text">Model used for correcting transcripts</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Transcription Settings
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="transcriptionConfigMessage"></div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Video Generation Branding Configuration -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-palette"></i> Video Generation Branding Configuration</h6>
                        </div>
                        <div class="card-body">
                            <form id="brandingConfigForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="brandingTitle" class="form-label">Video Title Branding</label>
                                        <input type="text" class="form-control" id="brandingTitle" 
                                               placeholder="Your Brand Name - Space Archive">
                                        <div class="form-text">Appears at the beginning of generated video titles</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="brandingWatermark" class="form-label">Video Watermark Text</label>
                                        <input type="text" class="form-control" id="brandingWatermark" 
                                               placeholder="yoursite.com">
                                        <div class="form-text">Text watermark shown on the video (optional)</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="brandingColor" class="form-label">Primary Brand Color</label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" 
                                                   id="brandingColor" value="#007bff" title="Choose brand color">
                                            <input type="text" class="form-control" id="brandingColorHex" 
                                                   value="#007bff" placeholder="#007bff">
                                        </div>
                                        <div class="form-text">Used for video UI elements and progress bars</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="brandingBackgroundColor" class="form-label">Background Color</label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" 
                                                   id="brandingBackgroundColor" value="#ffffff" title="Choose background color">
                                            <input type="text" class="form-control" id="brandingBackgroundColorHex" 
                                                   value="#ffffff" placeholder="#ffffff">
                                        </div>
                                        <div class="form-text">Background color for video elements</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="brandingFont" class="form-label">Font Family</label>
                                        <select class="form-select" id="brandingFont">
                                            <option value="Arial">Arial (default)</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Trebuchet MS">Trebuchet MS</option>
                                        </select>
                                        <div class="form-text">Font used for text in generated videos</div>
                                    </div>
                                    <div class="col-md-6">
                                        <!-- Empty column for layout balance -->
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="brandingLogo" class="form-label">Logo/Branding Image URL</label>
                                        <input type="url" class="form-control" id="brandingLogo" 
                                               placeholder="https://example.com/logo.png">
                                        <div class="form-text">
                                            URL to your logo image (PNG/JPG, recommended size: 200x50px). 
                                            Will be displayed in the top corner of generated videos.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="brandingEnabled" checked>
                                            <label class="form-check-label" for="brandingEnabled">
                                                <strong>Enable Video Branding</strong>
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            When enabled, all generated videos will include your branding elements.
                                            When disabled, videos will use default styling.
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Preview Section -->
                                <div class="mb-3">
                                    <hr>
                                    <h6 class="text-primary mb-3">Branding Preview</h6>
                                    <div class="card bg-light" id="brandingPreviewCard">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <div id="brandingPreviewLogo" style="width: 100px; height: 25px; background: #ddd; margin-right: 10px; display: none;">
                                                    <img id="brandingPreviewLogoImg" src="" alt="Logo" style="max-width: 100px; max-height: 25px;">
                                                </div>
                                                <h6 class="mb-0" id="brandingPreviewTitle" style="color: #007bff;">
                                                    Your Brand Name - Sample Space Title
                                                </h6>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div style="width: 200px; height: 8px; background: #e9ecef; border-radius: 4px; margin-right: 10px;">
                                                    <div id="brandingPreviewProgress" style="width: 60%; height: 100%; background: #007bff; border-radius: 4px;"></div>
                                                </div>
                                                <small id="brandingPreviewWatermark" class="text-muted">yoursite.com</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Branding Settings
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetBrandingDefaults()">
                                    <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="brandingConfigMessage"></div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Other settings can be added here -->
                </div>
            </div>
        </div>
        
        <!-- Logs Tab -->
        <div class="tab-pane fade" id="logs" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title">
                                <i class="bi bi-file-text"></i> System Logs
                            </h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="refreshLogs()" title="Refresh logs">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="clearLogs()">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="toggleAutoScroll()" id="autoScrollBtn">
                                    <i class="bi bi-arrow-down-circle"></i> Auto-scroll: ON
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="toggleLogStreaming()" id="streamingBtn">
                                    <i class="bi bi-play-circle"></i> Start Streaming
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Filters -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="logLevel" class="form-label">Log Level</label>
                            <select class="form-select" id="logLevel" onchange="filterLogs()">
                                <option value="">All Levels</option>
                                <option value="DEBUG">Debug</option>
                                <option value="INFO">Info</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="logSource" class="form-label">Source</label>
                            <select class="form-select" id="logSource" onchange="filterLogs()">
                                <option value="">All Sources</option>
                                <option value="transcribe">Transcription</option>
                                <option value="download">Downloads</option>
                                <option value="app">Application</option>
                                <option value="api">API</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="logSearch" class="form-label">Search</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="logSearch" placeholder="Search logs..." onkeyup="filterLogs()">
                                <button class="btn btn-outline-secondary" type="button" onclick="resetFilters()" title="Reset all filters">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Display -->
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <div class="row">
                                <div class="col-md-6">
                                    <small>Live System Logs</small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small id="logStatus">Stopped</small>
                                    <span class="badge bg-secondary ms-2" id="logCount">0 lines</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0" style="background-color: #1e1e1e;">
                            <div id="logContainer" style="height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; color: #f8f9fa; padding: 10px;">
                                <div class="text-muted text-center mt-5">
                                    <i class="bi bi-file-text" style="font-size: 2rem;"></i>
                                    <p>Click "Start Streaming" to view live logs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Legend -->
                    <div class="mt-3">
                        <small class="text-muted">
                            <strong>Legend:</strong>
                            <span class="badge bg-primary ms-2">INFO</span>
                            <span class="badge bg-warning ms-2">WARNING</span>
                            <span class="badge bg-danger ms-2">ERROR</span>
                            <span class="badge bg-success ms-2">OPENAI</span>
                            <span class="badge bg-info ms-2">LOCAL</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- SQL Query Logs Tab -->
        <div class="tab-pane fade" id="sql" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-database"></i> SQL Query Logs</h5>
                        <small class="text-muted">Monitor database query performance and execution</small>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleSQLLogging()">
                            <i class="bi bi-power" id="sqlToggleIcon"></i> <span id="sqlToggleText">Enable</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshSQLLogs()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearSQLLogs()">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- SQL Logging Status -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <span class="me-2">Status:</span>
                                <span class="badge" id="sqlLogStatus">Checking...</span>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                Showing last <span id="sqlLogCount">0</span> queries
                            </small>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="sqlComponentFilter">
                                <option value="">All Components</option>
                                <option value="Space">Space</option>
                                <option value="User">User</option>
                                <option value="Tag">Tag</option>
                                <option value="DatabaseManager">DatabaseManager</option>
                                <option value="DownloadSpace">DownloadSpace</option>
                                <option value="SpeechToText">SpeechToText</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="sqlStatusFilter">
                                <option value="">All Status</option>
                                <option value="SUCCESS">Success</option>
                                <option value="ERROR">Error</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" id="sqlSearchFilter" 
                                   placeholder="Search queries...">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary w-100" onclick="clearSQLFilters()">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    </div>

                    <!-- SQL Query Display -->
                    <div class="border rounded" style="background-color: #1e1e1e; color: #d4d4d4; height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                        <div id="sqlContainer" class="p-3">
                            <div class="text-center text-muted">
                                <i class="bi bi-database fs-1"></i>
                                <p class="mt-2">SQL query logs will appear here when logging is enabled.</p>
                                <p class="small">Enable SQL logging to monitor database performance.</p>
                            </div>
                        </div>
                    </div>

                    <!-- SQL Query Statistics -->
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> Avg Time: 
                                <span id="sqlAvgTime">-</span>ms
                            </small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">
                                <i class="bi bi-lightning"></i> Fastest: 
                                <span id="sqlFastestTime">-</span>ms
                            </small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">
                                <i class="bi bi-hourglass"></i> Slowest: 
                                <span id="sqlSlowestTime">-</span>ms
                            </small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">
                                <i class="bi bi-exclamation-triangle"></i> Errors: 
                                <span id="sqlErrorCount">-</span>
                            </small>
                        </div>
                    </div>

                    <!-- Performance Warning -->
                    <div class="alert alert-warning mt-3" style="display: none;" id="sqlPerformanceWarning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Performance Impact:</strong> SQL logging may impact database performance. 
                        Disable logging in production environments when not needed for debugging.
                    </div>
                </div>
            </div>
        </div>
        
        {% if is_localhost %}
        <!-- Development Tab -->
        <div class="tab-pane fade" id="development" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header bg-warning">
                    <h6 class="mb-0 text-dark">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>DANGER ZONE - Development Tools (Localhost Only)</strong>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger" role="alert">
                        <h5 class="alert-heading"><i class="bi bi-shield-exclamation"></i> Warning!</h5>
                        <p>These operations are <strong>IRREVERSIBLE</strong> and will permanently delete data. Only use in development environments.</p>
                        <hr>
                        <p class="mb-0">These tools are only available when running on localhost for safety.</p>
                    </div>
                    
                    <!-- Clear All Spaces Data -->
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-trash3"></i> Clear All Spaces Data
                            </h6>
                        </div>
                        <div class="card-body">
                            <p>This will permanently delete:</p>
                            <ul>
                                <li><strong>Database Tables:</strong> spaces, space_clips, space_download_history, space_download_scheduler, space_favs, space_metadata, space_notes, space_play_history, space_reviews, space_tags, space_transcripts</li>
                                <li><strong>Audio Files:</strong> downloads/*.mp3, downloads/*.m4a, downloads/*.wav</li>
                                <li><strong>Transcript Jobs:</strong> transcript_jobs/*.json</li>
                            </ul>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmClearSpaces">
                                    <label class="form-check-label" for="confirmClearSpaces">
                                        I understand this will permanently delete ALL spaces data and files
                                    </label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="clearAllSpacesData()" disabled id="clearSpacesBtn">
                                <i class="bi bi-trash3-fill"></i> Clear All Spaces Data
                            </button>
                            <div class="alert alert-info mt-3" style="display: none;" id="clearSpacesMessage"></div>
                        </div>
                    </div>
                    
                    <!-- Clear Non-Admin Users -->
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-people"></i> Clear Non-Admin Users
                            </h6>
                        </div>
                        <div class="card-body">
                            <p>This will permanently delete all users except those with <code>is_admin = 1</code>.</p>
                            <div class="alert alert-warning" role="alert">
                                <strong>Preserved:</strong> Admin users will be kept safe.
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmClearUsers">
                                    <label class="form-check-label" for="confirmClearUsers">
                                        I understand this will permanently delete all non-admin users
                                    </label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="clearNonAdminUsers()" disabled id="clearUsersBtn">
                                <i class="bi bi-people-fill"></i> Clear Non-Admin Users
                            </button>
                            <div class="alert alert-info mt-3" style="display: none;" id="clearUsersMessage"></div>
                        </div>
                    </div>
                    
                    <!-- System Info -->
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i> Development Environment Info
                            </h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Environment:</strong> Localhost Development</p>
                            <p><strong>Host:</strong> {{ request.host }}</p>
                            <p class="mb-0"><strong>Note:</strong> These tools are automatically hidden in production environments.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">
                    <i class="bi bi-cloud-upload"></i> Upload Audio/Video File
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="hidden" id="uploadSpaceId" name="space_id">
                    
                    <div class="mb-3">
                        <label for="uploadFile" class="form-label">
                            <i class="bi bi-file-earmark-music"></i> Select Audio/Video File
                        </label>
                        <input type="file" class="form-control" id="uploadFile" name="file" 
                               accept=".mp3,.mp4,.wav,.m4a,.webm,.ogg" required>
                        <div class="form-text">
                            Supported formats: MP3, MP4, WAV, M4A, WebM, OGG (Max size: 2GB)
                        </div>
                    </div>
                    
                    <!-- File Preview -->
                    <div id="filePreview" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-info-circle"></i> File Details
                                </h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">File Name:</small>
                                        <div id="fileName" class="fw-bold"></div>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">Size:</small>
                                        <div id="fileSize" class="fw-bold"></div>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">Type:</small>
                                        <div id="fileType" class="fw-bold"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mb-3" style="display: none;">
                        <label class="form-label">Upload Progress</label>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" id="uploadProgressBar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <small class="text-muted" id="uploadStatus">Preparing upload...</small>
                    </div>
                    
                    <!-- Upload Result -->
                    <div id="uploadResult" class="alert" style="display: none;">
                        <div id="uploadResultContent"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="uploadCancelBtn">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="uploadSubmitBtn" onclick="startUpload()">
                    <i class="bi bi-cloud-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let currentPeriod = 'daily';
let submissionsChart = null;
let currentUsersPage = 1;
let currentSpacesPage = 1;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadSpaces();
    loadStatistics('daily');
    
    // Add enter key support for search
    document.getElementById('userSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchUsers();
    });
    document.getElementById('spaceSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchSpaces();
    });
});

// User Management Functions
function loadUsers(page = 1) {
    currentUsersPage = page;
    const search = document.getElementById('userSearch').value;
    
    fetch(`/admin/api/users?page=${page}&search=${encodeURIComponent(search)}`)
        .then(response => response.json())
        .then(data => {
            displayUsers(data.users);
            displayPagination('usersPagination', data.page, data.pages, loadUsers);
        })
        .catch(error => {
            console.error('Error loading users:', error);
            document.getElementById('usersList').innerHTML = 
                '<tr><td colspan="9" class="text-danger text-center">Error loading users</td></tr>';
        });
}

function displayUsers(users) {
    const tbody = document.getElementById('usersList');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No users found</td></tr>';
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.id}</td>
            <td>${user.email}</td>
            <td>
                <span class="badge bg-${user.status === 1 ? 'success' : 'secondary'}">
                    ${user.status === 1 ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <input type="checkbox" class="form-check-input" 
                       ${user.is_admin ? 'checked' : ''} 
                       onchange="updateUser(${user.id}, 'is_admin', this.checked)">
            </td>
            <td>${user.country || '-'}</td>
            <td>${user.login_count || 0}</td>
            <td>${user.space_count || 0}</td>
            <td>${user.last_logged_in ? new Date(user.last_logged_in).toLocaleString() : 'Never'}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-warning" onclick="toggleUserStatus(${user.id}, ${user.status})">
                        ${user.status === 1 ? 'Suspend' : 'Activate'}
                    </button>
                    <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.email}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function searchUsers() {
    loadUsers(1);
}

function updateUser(userId, field, value) {
    fetch(`/admin/api/users/${userId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({[field]: value})
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Error updating user');
            loadUsers(currentUsersPage);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating user');
        loadUsers(currentUsersPage);
    });
}

function toggleUserStatus(userId, currentStatus) {
    const newStatus = currentStatus === 1 ? 0 : 1;
    updateUser(userId, 'status', newStatus);
    loadUsers(currentUsersPage);
}

function deleteUser(userId, email) {
    if (!confirm(`Are you sure you want to delete user: ${email}?`)) return;
    
    fetch(`/admin/api/users/${userId}`, {method: 'DELETE'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUsers(currentUsersPage);
            } else {
                alert(data.error || 'Error deleting user');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
}

// Space Management Functions
function loadSpaces(page = 1) {
    currentSpacesPage = page;
    const search = document.getElementById('spaceSearch').value;
    
    fetch(`/admin/api/spaces?page=${page}&search=${encodeURIComponent(search)}`)
        .then(response => response.json())
        .then(data => {
            displaySpaces(data.spaces);
            displayPagination('spacesPagination', data.page, data.pages, loadSpaces);
        })
        .catch(error => {
            console.error('Error loading spaces:', error);
            document.getElementById('spacesList').innerHTML = 
                '<tr><td colspan="7" class="text-danger text-center">Error loading spaces</td></tr>';
        });
}

function displaySpaces(spaces) {
    const tbody = document.getElementById('spacesList');
    
    if (spaces.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No spaces found</td></tr>';
        return;
    }
    
    tbody.innerHTML = spaces.map(space => `
        <tr>
            <td>
                <a href="/spaces/${space.space_id}" target="_blank" class="text-decoration-none">
                    ${space.title || 'Untitled Space'}
                </a>
                <br>
                <small class="text-muted">${space.space_id}</small>
            </td>
            <td>
                ${space.host_handle ? `
                    <img src="https://unavatar.io/twitter/${space.host_handle.replace('@', '')}" 
                         alt="${space.host_handle}" 
                         class="rounded-circle" 
                         style="width: 32px; height: 32px;"
                         onerror="this.style.display='none'">
                ` : '-'}
            </td>
            <td>
                ${space.user_email ? `
                    <img src="https://unavatar.io/${space.user_email}" 
                         alt="${space.user_email}" 
                         class="rounded-circle" 
                         style="width: 32px; height: 32px;"
                         onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(space.user_email.split('@')[0])}&background=random'">
                ` : 'Anonymous'}
            </td>
            <td>${space.download_cnt || 0}</td>
            <td>${space.playback_cnt || 0}</td>
            <td>${new Date(space.created_at).toLocaleDateString()}</td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary btn-sm" onclick="redoTags('${space.space_id}')" title="Regenerate tags from transcript">
                        Redo <i class="bi bi-tags"></i>
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="reTranscribe('${space.space_id}')" title="Re-transcribe with base model">
                        <i class="bi bi-mic"></i> Base
                    </button>
                    <button class="btn btn-success btn-sm" onclick="showUploadModal('${space.space_id}')" title="Upload new audio/video file">
                        <i class="bi bi-cloud-upload"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSpace('${space.space_id}')" title="Delete space">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function searchSpaces() {
    loadSpaces(1);
}

function deleteSpace(spaceId) {
    if (!confirm('Are you sure you want to delete this space? This action cannot be undone.')) return;
    
    fetch(`/admin/api/spaces/${spaceId}`, {method: 'DELETE'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSpaces(currentSpacesPage);
            } else {
                alert(data.error || 'Error deleting space');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting space');
        });
}

function redoTags(spaceId) {
    if (!confirm('Regenerate tags for this space using its transcript? This will replace all existing tags.')) return;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Generating...';
    button.disabled = true;
    
    fetch(`/admin/api/spaces/${spaceId}/redo-tags`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message with tags
                const tagsText = data.tags.length > 0 ? 
                    `\n\nGenerated tags: ${data.tags.join(', ')}` : 
                    '\n\nNo tags generated.';
                alert(`${data.message} for "${data.space_title}"${tagsText}`);
                // Reload the spaces list to show updated data
                loadSpaces(currentSpacesPage);
            } else {
                alert(data.error || 'Error regenerating tags');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error regenerating tags');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
}

function reTranscribe(spaceId) {
    if (!confirm('Re-transcribe this space with the base model? This will overwrite the existing transcript.')) return;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Transcribing...';
    button.disabled = true;
    
    fetch(`/admin/api/spaces/${spaceId}/re-transcribe`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: 'base',
            overwrite: true
        })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.message} for space ${spaceId}`);
            } else {
                alert(data.error || 'Error starting re-transcription');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting re-transcription');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
}

// Upload Functions
let uploadAbortController = null;

function showUploadModal(spaceId) {
    document.getElementById('uploadSpaceId').value = spaceId;
    
    // Reset modal state
    resetUploadModal();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
    modal.show();
}

function resetUploadModal() {
    // Clear file input
    document.getElementById('uploadFile').value = '';
    
    // Hide all dynamic sections
    document.getElementById('filePreview').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadResult').style.display = 'none';
    
    // Reset progress bar
    const progressBar = document.getElementById('uploadProgressBar');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    
    // Reset buttons
    document.getElementById('uploadSubmitBtn').style.display = 'inline-block';
    document.getElementById('uploadCancelBtn').textContent = 'Cancel';
    document.getElementById('uploadCancelBtn').innerHTML = '<i class="bi bi-x-circle"></i> Cancel';
    
    // Clear any existing abort controller
    if (uploadAbortController) {
        uploadAbortController.abort();
        uploadAbortController = null;
    }
}

// File selection handler
document.getElementById('uploadFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        showFilePreview(file);
    } else {
        document.getElementById('filePreview').style.display = 'none';
    }
});

function showFilePreview(file) {
    const preview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');
    
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileType.textContent = file.type || 'Unknown';
    
    preview.style.display = 'block';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function validateFile(file) {
    const maxSize = 2 * 1024 * 1024 * 1024; // 2GB
    const allowedTypes = ['audio/mpeg', 'audio/mp4', 'audio/wav', 'audio/x-wav', 'audio/webm', 'audio/ogg', 
                         'video/mp4', 'video/webm', 'video/quicktime', 'video/x-msvideo'];
    const allowedExtensions = ['.mp3', '.mp4', '.wav', '.m4a', '.webm', '.ogg', '.avi', '.mov'];
    
    // Check file size
    if (file.size > maxSize) {
        return 'File size too large. Maximum allowed size is 2GB.';
    }
    
    // Check file extension
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(fileExtension)) {
        return 'Invalid file type. Supported formats: MP3, MP4, WAV, M4A, WebM, OGG.';
    }
    
    return null; // No error
}

function startUpload() {
    const fileInput = document.getElementById('uploadFile');
    const spaceId = document.getElementById('uploadSpaceId').value;
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file to upload.');
        return;
    }
    
    // Validate file
    const validationError = validateFile(file);
    if (validationError) {
        showUploadResult(false, validationError);
        return;
    }
    
    // Show progress section
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadResult').style.display = 'none';
    
    // Disable upload button and change cancel button
    document.getElementById('uploadSubmitBtn').style.display = 'none';
    document.getElementById('uploadCancelBtn').innerHTML = '<i class="bi bi-x-circle"></i> Abort Upload';
    
    // Create FormData
    const formData = new FormData();
    formData.append('file', file);
    formData.append('space_id', spaceId);
    
    // Create abort controller
    uploadAbortController = new AbortController();
    
    // Create XMLHttpRequest for progress tracking
    const xhr = new XMLHttpRequest();
    
    // Track upload progress
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            updateUploadProgress(percentComplete, 'Uploading...');
        }
    });
    
    // Handle successful response
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    showUploadResult(true, response.message || 'File uploaded successfully!');
                    // Refresh spaces table after successful upload
                    setTimeout(() => {
                        loadSpaces(currentSpacesPage);
                    }, 1500);
                } else {
                    showUploadResult(false, response.error || 'Upload failed');
                }
            } catch (e) {
                showUploadResult(false, 'Invalid server response');
            }
        } else {
            showUploadResult(false, `Upload failed with status: ${xhr.status}`);
        }
    });
    
    // Handle errors
    xhr.addEventListener('error', function() {
        showUploadResult(false, 'Upload failed due to network error');
    });
    
    // Handle abort
    xhr.addEventListener('abort', function() {
        showUploadResult(false, 'Upload was cancelled');
    });
    
    // Setup abort controller
    uploadAbortController.signal.addEventListener('abort', function() {
        xhr.abort();
    });
    
    // Start upload
    xhr.open('POST', '/admin/api/spaces/upload');
    xhr.send(formData);
    
    updateUploadProgress(0, 'Starting upload...');
}

function updateUploadProgress(percent, status) {
    const progressBar = document.getElementById('uploadProgressBar');
    const statusText = document.getElementById('uploadStatus');
    
    progressBar.style.width = percent + '%';
    progressBar.textContent = Math.round(percent) + '%';
    statusText.textContent = status;
    
    if (percent >= 100) {
        progressBar.className = 'progress-bar bg-success';
        statusText.textContent = 'Processing upload...';
    }
}

function showUploadResult(success, message) {
    const resultDiv = document.getElementById('uploadResult');
    const resultContent = document.getElementById('uploadResultContent');
    
    resultDiv.className = success ? 'alert alert-success' : 'alert alert-danger';
    resultContent.innerHTML = `<i class="bi bi-${success ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
    resultDiv.style.display = 'block';
    
    // Hide progress section
    document.getElementById('uploadProgress').style.display = 'none';
    
    // Reset buttons
    document.getElementById('uploadSubmitBtn').style.display = 'inline-block';
    document.getElementById('uploadCancelBtn').innerHTML = '<i class="bi bi-x-circle"></i> Close';
    
    // Clear abort controller
    uploadAbortController = null;
}

// Handle cancel/abort button
document.getElementById('uploadCancelBtn').addEventListener('click', function() {
    if (uploadAbortController) {
        // Currently uploading, abort it
        uploadAbortController.abort();
    }
});

// Statistics Functions
function changePeriod(period) {
    currentPeriod = period;
    
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    loadStatistics(period);
}

function loadStatistics(period) {
    // Load all statistics
    loadSubmissionsChart(period);
    loadPopularSpaces(period);
    loadDownloadedSpaces(period);
    loadActiveUsers(period);
}

function loadSubmissionsChart(period) {
    fetch(`/admin/api/stats/submissions?period=${period}`)
        .then(response => response.json())
        .then(result => {
            const ctx = document.getElementById('submissionsChart').getContext('2d');
            
            if (submissionsChart) {
                submissionsChart.destroy();
            }
            
            submissionsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: result.data.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Space Submissions',
                        data: result.data.map(d => d.count),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading submissions chart:', error));
}

function loadPopularSpaces(period) {
    fetch(`/admin/api/stats/plays?period=${period}`)
        .then(response => response.json())
        .then(result => {
            const list = document.getElementById('popularSpacesList');
            
            if (result.data.length === 0) {
                list.innerHTML = '<div class="text-center text-muted">No data available</div>';
                return;
            }
            
            list.innerHTML = result.data.slice(0, 10).map((space, index) => `
                <a href="/spaces/${space.space_id}" target="_blank" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>#${index + 1}</strong> ${space.title || 'Untitled'}
                            <small class="text-muted d-block">${space.host || 'Unknown host'}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${space.playback_cnt} plays</span>
                    </div>
                </a>
            `).join('');
        })
        .catch(error => console.error('Error loading popular spaces:', error));
}

function loadDownloadedSpaces(period) {
    fetch(`/admin/api/stats/downloads?period=${period}`)
        .then(response => response.json())
        .then(result => {
            const list = document.getElementById('downloadedSpacesList');
            
            if (result.data.length === 0) {
                list.innerHTML = '<div class="text-center text-muted">No data available</div>';
                return;
            }
            
            list.innerHTML = result.data.slice(0, 10).map((space, index) => `
                <a href="/spaces/${space.space_id}" target="_blank" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>#${index + 1}</strong> ${space.title || 'Untitled'}
                            <small class="text-muted d-block">${space.host || 'Unknown host'}</small>
                        </div>
                        <span class="badge bg-info rounded-pill">${space.download_cnt} downloads</span>
                    </div>
                </a>
            `).join('');
        })
        .catch(error => console.error('Error loading downloaded spaces:', error));
}

function loadActiveUsers(period) {
    fetch(`/admin/api/stats/active_users?period=${period}`)
        .then(response => response.json())
        .then(result => {
            const tbody = document.getElementById('activeUsersList');
            
            if (result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = result.data.map(user => `
                <tr>
                    <td>${user.email}</td>
                    <td>${user.country || '-'}</td>
                    <td>${user.login_count || 0}</td>
                    <td>${user.space_count || 0}</td>
                    <td>${user.total_downloads || 0}</td>
                    <td>${user.total_plays || 0}</td>
                </tr>
            `).join('');
        })
        .catch(error => console.error('Error loading active users:', error));
}

// Pagination Helper
function displayPagination(elementId, currentPage, totalPages, loadFunction) {
    const pagination = document.getElementById(elementId);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage > 1 ? `${loadFunction.name}(${currentPage - 1})` : ''}">Previous</a>
    </li>`;
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="event.preventDefault(); ${loadFunction.name}(${i})">${i}</a>
        </li>`;
    }
    
    // Next button
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage < totalPages ? `${loadFunction.name}(${currentPage + 1})` : ''}">Next</a>
    </li>`;
    
    pagination.innerHTML = html;
}

// Rate Limit Settings
document.getElementById('rateLimitForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageDiv = document.getElementById('rateLimitMessage');
    messageDiv.style.display = 'none';
    
    const data = {
        daily_limit: parseInt(document.getElementById('dailyLimit').value),
        hourly_limit: parseInt(document.getElementById('hourlyLimit').value),
        enabled: document.getElementById('rateLimitEnabled').checked
    };
    
    try {
        const response = await fetch('/admin/api/update_rate_limits', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message;
            messageDiv.style.display = 'block';
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to update settings');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    }
});

// Load tracking configuration on page load
async function loadTrackingConfig() {
    try {
        const response = await fetch('/admin/api/tracking_config');
        const result = await response.json();
        
        if (result.success && result.config) {
            // Set form values
            document.getElementById('playCooldownMinutes').value = result.config.play_cooldown_minutes || 30;
            document.getElementById('playMinDuration').value = result.config.play_minimum_duration_seconds || 30;
            document.getElementById('downloadDailyLimit').value = result.config.download_daily_limit || 1;
            document.getElementById('downloadHourlyIpLimit').value = result.config.download_hourly_ip_limit || 10;
            document.getElementById('playTrackingEnabled').checked = result.config.play_tracking_enabled !== 'false';
            document.getElementById('downloadTrackingEnabled').checked = result.config.download_tracking_enabled !== 'false';
        }
    } catch (error) {
        console.error('Error loading tracking config:', error);
    }
}

// Save tracking configuration
document.getElementById('trackingConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageDiv = document.getElementById('trackingConfigMessage');
    messageDiv.style.display = 'none';
    
    const data = {
        play_cooldown_minutes: document.getElementById('playCooldownMinutes').value,
        play_minimum_duration_seconds: document.getElementById('playMinDuration').value,
        download_daily_limit: document.getElementById('downloadDailyLimit').value,
        download_hourly_ip_limit: document.getElementById('downloadHourlyIpLimit').value,
        play_tracking_enabled: document.getElementById('playTrackingEnabled').checked ? 'true' : 'false',
        download_tracking_enabled: document.getElementById('downloadTrackingEnabled').checked ? 'true' : 'false'
    };
    
    try {
        const response = await fetch('/admin/api/update_tracking_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message || 'Tracking configuration updated successfully';
            messageDiv.style.display = 'block';
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to update configuration');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    }
});

// Load tracking config when settings tab is shown
document.getElementById('settings-tab').addEventListener('shown.bs.tab', function() {
    loadTrackingConfig();
    loadTranscriptionConfig();
    loadBrandingConfig();
});

// Transcription Configuration
document.querySelectorAll('input[name="transcriptionProvider"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const openaiSettings = document.getElementById('openaiApiSettings');
        const localSettings = document.getElementById('localWhisperSettings');
        
        if (this.value === 'openai') {
            openaiSettings.style.display = 'block';
            localSettings.style.display = 'none';
        } else {
            openaiSettings.style.display = 'none';
            localSettings.style.display = 'block';
        }
    });
});

async function loadTranscriptionConfig() {
    try {
        const response = await fetch('/admin/api/transcription_config');
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.config) {
                // Set provider
                const provider = result.config.provider || 'local';
                document.getElementById(provider === 'openai' ? 'openaiApi' : 'localWhisper').checked = true;
                
                // Trigger change event to show/hide sections
                document.querySelector(`input[value="${provider}"]`).dispatchEvent(new Event('change'));
                
                // Set OpenAI settings
                const apiKeyInput = document.getElementById('openaiApiKey');
                const apiKeyStatus = document.getElementById('apiKeyStatus');
                const keySource = result.config.openai_key_source || 'none';
                
                if (keySource === 'environment') {
                    apiKeyInput.value = '***from_env***';
                    apiKeyInput.placeholder = 'Using API key from environment variables';
                    apiKeyInput.title = 'OpenAI API key is set in environment variables (.env file)';
                    apiKeyStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> API key configured in environment variables (.env file).';
                } else if (keySource === 'config') {
                    apiKeyInput.value = '***hidden***';
                    apiKeyInput.placeholder = 'Using API key from configuration';
                    apiKeyInput.title = 'OpenAI API key is set in configuration file';
                    apiKeyStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> API key configured in settings file.';
                } else {
                    apiKeyInput.value = '';
                    apiKeyInput.placeholder = 'sk-...';
                    apiKeyInput.title = 'Enter your OpenAI API key';
                    apiKeyStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> No API key configured. Enter one to use OpenAI transcription.';
                }
                
                document.getElementById('openaiModel').value = result.config.openai_model || 'gpt-4o-mini-transcribe';
                
                // Set local Whisper settings
                document.getElementById('defaultWhisperModel').value = result.config.default_model || 'tiny';
                document.getElementById('whisperDevice').value = result.config.device || 'auto';
                
                // Set corrective filter settings
                document.getElementById('enableCorrectiveFilter').checked = result.config.enable_corrective_filter !== false;
                document.getElementById('correctionModel').value = result.config.correction_model || 'gpt-4o-mini';
            }
        }
    } catch (error) {
        console.error('Error loading transcription config:', error);
    }
}

document.getElementById('transcriptionConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageDiv = document.getElementById('transcriptionConfigMessage');
    messageDiv.style.display = 'none';
    
    const provider = document.querySelector('input[name="transcriptionProvider"]:checked').value;
    
    const data = {
        provider: provider,
        openai_api_key: document.getElementById('openaiApiKey').value,
        openai_model: document.getElementById('openaiModel').value,
        default_model: document.getElementById('defaultWhisperModel').value,
        device: document.getElementById('whisperDevice').value,
        enable_corrective_filter: document.getElementById('enableCorrectiveFilter').checked,
        correction_model: document.getElementById('correctionModel').value
    };
    
    try {
        const response = await fetch('/admin/api/transcription_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message || 'Transcription configuration updated successfully';
            messageDiv.style.display = 'block';
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to update configuration');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    }
});

// Log Streaming Variables
let logStreamingActive = false;
let logStreamingInterval = null;
let autoScrollEnabled = true;
let allLogs = [];
let logOffset = 0;

// Log Management Functions
function toggleLogStreaming() {
    const btn = document.getElementById('streamingBtn');
    const status = document.getElementById('logStatus');
    
    if (logStreamingActive) {
        // Stop streaming
        clearInterval(logStreamingInterval);
        logStreamingActive = false;
        btn.innerHTML = '<i class="bi bi-play-circle"></i> Start Streaming';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-primary');
        status.textContent = 'Stopped';
        status.className = 'text-danger';
    } else {
        // Start streaming
        logStreamingActive = true;
        btn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop Streaming';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        status.textContent = 'Streaming';
        status.className = 'text-success';
        
        // Reset and start fresh
        allLogs = [];
        logOffset = 0;
        
        // Initial load
        loadLogs();
        
        // Set up polling every 2 seconds
        logStreamingInterval = setInterval(loadLogs, 2000);
    }
}

async function loadLogs() {
    try {
        const response = await fetch(`/admin/api/logs?offset=${logOffset}`);
        const result = await response.json();
        
        console.log('API Response:', result);
        
        if (result.success) {
            if (result.logs.length > 0) {
                allLogs = allLogs.concat(result.logs);
                logOffset = result.next_offset || logOffset + result.logs.length;
                displayLogs();
                updateLogCount();
            } else {
                console.log('No new logs received from API');
                // Still call displayLogs to show existing logs
                displayLogs();
                updateLogCount();
            }
        } else {
            console.error('API returned error:', result.error);
        }
    } catch (error) {
        console.error('Error loading logs:', error);
    }
}

function displayLogs() {
    const container = document.getElementById('logContainer');
    const level = document.getElementById('logLevel').value;
    const source = document.getElementById('logSource').value;
    const search = document.getElementById('logSearch').value.toLowerCase();
    
    // Debug logging
    console.log('Total logs:', allLogs.length);
    console.log('Filters:', { level, source, search });
    
    // Filter logs
    let filteredLogs = allLogs.filter(log => {
        if (level && !log.message.includes(`[${level}]`)) return false;
        if (source && !log.message.toLowerCase().includes(source)) return false;
        if (search && !log.message.toLowerCase().includes(search)) return false;
        return true;
    });
    
    console.log('Filtered logs count:', filteredLogs.length);
    
    // Display filtered logs
    const logHtml = filteredLogs.map(log => formatLogLine(log.message)).join('\n');
    
    if (allLogs.length === 0) {
        container.innerHTML = '<div class="text-muted text-center mt-5"><i class="bi bi-file-text" style="font-size: 2rem;"></i><p>No logs available yet</p></div>';
    } else if (filteredLogs.length === 0) {
        container.innerHTML = '<div class="text-muted text-center mt-5">No logs match the current filters<br><small>Try clearing filters or changing search terms</small></div>';
    } else {
        container.innerHTML = `<pre style="color: inherit; margin: 0; white-space: pre-wrap; word-wrap: break-word;">${logHtml}</pre>`;
        
        // Auto-scroll to bottom if enabled
        if (autoScrollEnabled) {
            container.scrollTop = container.scrollHeight;
        }
    }
}

function formatLogLine(message) {
    // Enhanced formatting to highlight transcription provider
    let formatted = message;
    
    // Highlight log levels
    formatted = formatted.replace(/\[DEBUG\]/g, '<span class="badge bg-secondary">[DEBUG]</span>');
    formatted = formatted.replace(/\[INFO\]/g, '<span class="badge bg-primary">[INFO]</span>');
    formatted = formatted.replace(/\[WARNING\]/g, '<span class="badge bg-warning">[WARNING]</span>');
    formatted = formatted.replace(/\[ERROR\]/g, '<span class="badge bg-danger">[ERROR]</span>');
    formatted = formatted.replace(/\[CRITICAL\]/g, '<span class="badge bg-danger">[CRITICAL]</span>');
    
    // Highlight transcription providers
    formatted = formatted.replace(/OpenAI API|openai_api|OpenAI client/gi, '<span class="badge bg-success">OPENAI</span>');
    formatted = formatted.replace(/local Whisper|whisper\.load_model|Local transcription/gi, '<span class="badge bg-info">LOCAL</span>');
    
    // Highlight important transcription events
    formatted = formatted.replace(/Starting transcription/gi, '<span class="text-warning">Starting transcription</span>');
    formatted = formatted.replace(/transcription completed/gi, '<span class="text-success">transcription completed</span>');
    formatted = formatted.replace(/Error.*transcrib/gi, '<span class="text-danger">$&</span>');
    
    return formatted;
}

function clearLogs() {
    if (confirm('Clear all logs from the display?')) {
        allLogs = [];
        logOffset = 0;
        document.getElementById('logContainer').innerHTML = '<div class="text-muted text-center mt-5">Logs cleared</div>';
        updateLogCount();
    }
}

function toggleAutoScroll() {
    autoScrollEnabled = !autoScrollEnabled;
    const btn = document.getElementById('autoScrollBtn');
    
    if (autoScrollEnabled) {
        btn.innerHTML = '<i class="bi bi-arrow-down-circle"></i> Auto-scroll: ON';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-primary');
    } else {
        btn.innerHTML = '<i class="bi bi-arrow-down-circle"></i> Auto-scroll: OFF';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-outline-secondary');
    }
}

function filterLogs() {
    displayLogs();
}

function resetFilters() {
    document.getElementById('logLevel').value = '';
    document.getElementById('logSource').value = '';
    document.getElementById('logSearch').value = '';
    displayLogs();
}

function refreshLogs() {
    // Reset and reload logs from the beginning
    allLogs = [];
    logOffset = 0;
    loadLogs();
}

function updateLogCount() {
    const count = document.getElementById('logCount');
    count.textContent = `${allLogs.length} lines`;
}

// Initialize logs tab when activated
document.getElementById('logs-tab').addEventListener('shown.bs.tab', function() {
    if (!logStreamingActive) {
        // Reset logs and load from beginning when tab is first opened
        allLogs = [];
        logOffset = 0;
        loadLogs();
    }
});

// System Monitoring Variables
let systemMonitoringActive = false;
let systemMonitoringInterval = null;

// System Monitoring Functions
async function loadSystemStats() {
    try {
        const response = await fetch('/admin/api/system_stats');
        const result = await response.json();
        
        if (result.success) {
            updateSystemDisplay(result.stats);
            document.getElementById('systemStatus').textContent = 'Live';
            document.getElementById('systemStatus').className = 'badge bg-success ms-2';
        } else {
            console.error('Error loading system stats:', result.error);
            document.getElementById('systemStatus').textContent = 'Error';
            document.getElementById('systemStatus').className = 'badge bg-danger ms-2';
        }
    } catch (error) {
        console.error('Error loading system stats:', error);
        document.getElementById('systemStatus').textContent = 'Offline';
        document.getElementById('systemStatus').className = 'badge bg-secondary ms-2';
    }
}

function updateSystemDisplay(stats) {
    // Update CPU
    const cpuProgress = document.getElementById('cpuProgress');
    const cpuDetails = document.getElementById('cpuDetails');
    cpuProgress.style.width = `${stats.cpu.usage_percent}%`;
    cpuProgress.textContent = `${stats.cpu.usage_percent}%`;
    cpuProgress.className = `progress-bar ${getProgressBarColor(stats.cpu.usage_percent)}`;
    cpuDetails.textContent = stats.cpu.details;
    
    // Update Memory
    const memoryProgress = document.getElementById('memoryProgress');
    const memoryDetails = document.getElementById('memoryDetails');
    memoryProgress.style.width = `${stats.memory.usage_percent}%`;
    memoryProgress.textContent = `${stats.memory.usage_percent}%`;
    memoryProgress.className = `progress-bar ${getProgressBarColor(stats.memory.usage_percent)}`;
    memoryDetails.textContent = stats.memory.details;
    
    // Update Disk
    const diskProgress = document.getElementById('diskProgress');
    const diskDetails = document.getElementById('diskDetails');
    diskProgress.style.width = `${stats.disk.usage_percent}%`;
    diskProgress.textContent = `${stats.disk.usage_percent}%`;
    diskProgress.className = `progress-bar ${getProgressBarColor(stats.disk.usage_percent)}`;
    diskDetails.textContent = stats.disk.details;
    
    // Update GPU
    const gpuProgress = document.getElementById('gpuProgress');
    const gpuDetails = document.getElementById('gpuDetails');
    
    if (stats.gpu.available !== false) {
        const gpuUsage = stats.gpu.usage_percent || 0;
        gpuProgress.style.width = `${gpuUsage}%`;
        gpuProgress.textContent = `${gpuUsage}%`;
        gpuProgress.className = `progress-bar ${getProgressBarColor(gpuUsage)}`;
        gpuDetails.textContent = stats.gpu.details;
    } else {
        gpuProgress.style.width = '0%';
        gpuProgress.textContent = 'N/A';
        gpuProgress.className = 'progress-bar bg-secondary';
        gpuDetails.textContent = stats.gpu.details;
    }
}

function getProgressBarColor(percentage) {
    if (percentage < 50) return 'bg-success';
    if (percentage < 75) return 'bg-warning';
    return 'bg-danger';
}

function startSystemMonitoring() {
    if (!systemMonitoringActive) {
        systemMonitoringActive = true;
        // Load immediately
        loadSystemStats();
        // Set up 30-second interval
        systemMonitoringInterval = setInterval(loadSystemStats, 30000);
    }
}

function stopSystemMonitoring() {
    if (systemMonitoringActive) {
        systemMonitoringActive = false;
        clearInterval(systemMonitoringInterval);
        document.getElementById('systemStatus').textContent = 'Stopped';
        document.getElementById('systemStatus').className = 'badge bg-secondary ms-2';
    }
}

// Start system monitoring when the page loads
document.addEventListener('DOMContentLoaded', function() {
    startSystemMonitoring();
});

// Stop monitoring when the page is about to unload
window.addEventListener('beforeunload', function() {
    stopSystemMonitoring();
});

// Development Tab Functions (only available on localhost)
function enableClearSpacesButton() {
    const checkbox = document.getElementById('confirmClearSpaces');
    const button = document.getElementById('clearSpacesBtn');
    button.disabled = !checkbox.checked;
}

function enableClearUsersButton() {
    const checkbox = document.getElementById('confirmClearUsers');
    const button = document.getElementById('clearUsersBtn');
    button.disabled = !checkbox.checked;
}

async function clearAllSpacesData() {
    const confirmed = confirm(
        " FINAL WARNING \n\n" +
        "This will PERMANENTLY DELETE:\n" +
        " ALL spaces from database\n" +
        " ALL audio files (downloads/)\n" +
        " ALL transcript jobs\n\n" +
        "This action CANNOT be undone!\n\n" +
        "Type 'DELETE ALL SPACES' in the next dialog to proceed."
    );
    
    if (!confirmed) return;
    
    const confirmText = prompt("Type 'DELETE ALL SPACES' to confirm:");
    if (confirmText !== 'DELETE ALL SPACES') {
        alert("Confirmation text did not match. Operation cancelled.");
        return;
    }
    
    const messageDiv = document.getElementById('clearSpacesMessage');
    const button = document.getElementById('clearSpacesBtn');
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Clearing...';
        
        const response = await fetch('/admin/api/dev/clear_spaces_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ confirm: 'DELETE ALL SPACES' })
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message;
            messageDiv.style.display = 'block';
            
            // Uncheck the confirmation
            document.getElementById('confirmClearSpaces').checked = false;
            
            // Refresh the page after a delay
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to clear spaces data');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash3-fill"></i> Clear All Spaces Data';
    }
}

async function clearNonAdminUsers() {
    const confirmed = confirm(
        " FINAL WARNING \n\n" +
        "This will PERMANENTLY DELETE all users except admins!\n\n" +
        "Admin users (is_admin = 1) will be preserved.\n\n" +
        "This action CANNOT be undone!\n\n" +
        "Type 'DELETE NON ADMIN USERS' in the next dialog to proceed."
    );
    
    if (!confirmed) return;
    
    const confirmText = prompt("Type 'DELETE NON ADMIN USERS' to confirm:");
    if (confirmText !== 'DELETE NON ADMIN USERS') {
        alert("Confirmation text did not match. Operation cancelled.");
        return;
    }
    
    const messageDiv = document.getElementById('clearUsersMessage');
    const button = document.getElementById('clearUsersBtn');
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Clearing...';
        
        const response = await fetch('/admin/api/dev/clear_non_admin_users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ confirm: 'DELETE NON ADMIN USERS' })
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message;
            messageDiv.style.display = 'block';
            
            // Uncheck the confirmation
            document.getElementById('confirmClearUsers').checked = false;
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to clear users');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-people-fill"></i> Clear Non-Admin Users';
    }
}

// Add event listeners for development checkboxes when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Only add listeners if development tab exists (localhost only)
    const spacesCheckbox = document.getElementById('confirmClearSpaces');
    const usersCheckbox = document.getElementById('confirmClearUsers');
    
    if (spacesCheckbox) {
        spacesCheckbox.addEventListener('change', enableClearSpacesButton);
    }
    
    if (usersCheckbox) {
        usersCheckbox.addEventListener('change', enableClearUsersButton);
    }
    
    // Initialize branding configuration
    initializeBrandingConfig();
});

// Branding Configuration Functions
function initializeBrandingConfig() {
    // Set up color picker sync
    const colorPicker = document.getElementById('brandingColor');
    const colorHex = document.getElementById('brandingColorHex');
    const backgroundColorPicker = document.getElementById('brandingBackgroundColor');
    const backgroundColorHex = document.getElementById('brandingBackgroundColorHex');
    
    if (colorPicker && colorHex) {
        colorPicker.addEventListener('input', function() {
            colorHex.value = this.value;
            updateBrandingPreview();
        });
        
        colorHex.addEventListener('input', function() {
            if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                colorPicker.value = this.value;
                updateBrandingPreview();
            }
        });
    }
    
    // Sync background color picker with hex input
    if (backgroundColorPicker && backgroundColorHex) {
        backgroundColorPicker.addEventListener('input', function() {
            backgroundColorHex.value = this.value;
            updateBrandingPreview();
        });
        
        backgroundColorHex.addEventListener('input', function() {
            if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                backgroundColorPicker.value = this.value;
                updateBrandingPreview();
            }
        });
    }
    
    // Set up real-time preview updates
    const previewElements = [
        'brandingTitle', 'brandingWatermark', 'brandingLogo', 
        'brandingFont', 'brandingEnabled'
    ];
    
    previewElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateBrandingPreview);
            element.addEventListener('change', updateBrandingPreview);
        }
    });
    
    // Set up form submit handler
    const brandingForm = document.getElementById('brandingConfigForm');
    if (brandingForm) {
        brandingForm.addEventListener('submit', handleBrandingFormSubmit);
    }
    
    // Initial preview update
    updateBrandingPreview();
}

function updateBrandingPreview() {
    const enabled = document.getElementById('brandingEnabled')?.checked ?? true;
    const title = document.getElementById('brandingTitle')?.value || 'Your Brand Name';
    const watermark = document.getElementById('brandingWatermark')?.value || 'yoursite.com';
    const color = document.getElementById('brandingColor')?.value || '#007bff';
    const backgroundColor = document.getElementById('brandingBackgroundColor')?.value || '#ffffff';
    const logo = document.getElementById('brandingLogo')?.value;
    const font = document.getElementById('brandingFont')?.value || 'Arial';
    
    // Update preview elements
    const previewTitle = document.getElementById('brandingPreviewTitle');
    const previewWatermark = document.getElementById('brandingPreviewWatermark');
    const previewProgress = document.getElementById('brandingPreviewProgress');
    const previewLogo = document.getElementById('brandingPreviewLogo');
    const previewLogoImg = document.getElementById('brandingPreviewLogoImg');
    const previewCard = document.querySelector('#brandingPreviewCard');
    
    if (!enabled) {
        // Show disabled state
        if (previewTitle) {
            previewTitle.textContent = 'Sample Space Title (Branding Disabled)';
            previewTitle.style.color = '#6c757d';
            previewTitle.style.fontFamily = 'Arial';
        }
        if (previewWatermark) {
            previewWatermark.textContent = '';
        }
        if (previewProgress) {
            previewProgress.style.background = '#6c757d';
        }
        if (previewLogo) {
            previewLogo.style.display = 'none';
        }
        if (previewCard) {
            previewCard.style.setProperty('background-color', '#f8f9fa', 'important');
        }
        return;
    }
    
    // Update title
    if (previewTitle) {
        previewTitle.textContent = `${title} - Sample Space Title`;
        previewTitle.style.color = color;
        previewTitle.style.fontFamily = font;
    }
    
    // Update background color
    if (previewCard) {
        previewCard.style.setProperty('background-color', backgroundColor, 'important');
    }
    
    // Update watermark
    if (previewWatermark) {
        previewWatermark.textContent = watermark;
    }
    
    // Update progress bar color
    if (previewProgress) {
        previewProgress.style.background = color;
    }
    
    // Update logo
    if (previewLogo && previewLogoImg) {
        if (logo && logo.trim()) {
            previewLogoImg.src = logo;
            previewLogo.style.display = 'block';
            
            // Handle logo load error
            previewLogoImg.onerror = function() {
                previewLogo.style.display = 'none';
            };
        } else {
            previewLogo.style.display = 'none';
        }
    }
}

// Load branding configuration from server
async function loadBrandingConfig() {
    console.log('Loading branding configuration...');
    try {
        const response = await fetch('/admin/api/branding_config');
        const result = await response.json();
        console.log('Branding config response:', result);
        
        if (result.success && result.config) {
            // Set form values
            document.getElementById('brandingTitle').value = result.config.video_title_branding || '';
            document.getElementById('brandingWatermark').value = result.config.video_watermark_text || '';
            document.getElementById('brandingColor').value = result.config.brand_color || '#007bff';
            document.getElementById('brandingColorHex').value = result.config.brand_color || '#007bff';
            document.getElementById('brandingBackgroundColor').value = result.config.background_color || '#ffffff';
            document.getElementById('brandingBackgroundColorHex').value = result.config.background_color || '#ffffff';
            document.getElementById('brandingFont').value = result.config.font_family || 'Arial';
            document.getElementById('brandingLogo').value = result.config.brand_logo_url || '';
            document.getElementById('brandingEnabled').checked = result.config.branding_enabled !== false;
            
            // Update preview
            updateBrandingPreview();
        }
    } catch (error) {
        console.error('Error loading branding config:', error);
    }
}

// Save branding configuration
async function handleBrandingFormSubmit(e) {
    e.preventDefault();
    console.log('Saving branding configuration...');
    
    const messageDiv = document.getElementById('brandingConfigMessage');
    messageDiv.style.display = 'none';
    
    const data = {
        video_title_branding: document.getElementById('brandingTitle').value,
        video_watermark_text: document.getElementById('brandingWatermark').value,
        brand_color: document.getElementById('brandingColor').value,
        background_color: document.getElementById('brandingBackgroundColor').value,
        font_family: document.getElementById('brandingFont').value,
        brand_logo_url: document.getElementById('brandingLogo').value,
        branding_enabled: document.getElementById('brandingEnabled').checked
    };
    
    console.log('Branding data to save:', data);
    
    try {
        const response = await fetch('/admin/api/branding_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message || 'Branding configuration updated successfully';
            messageDiv.style.display = 'block';
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to update branding configuration');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Error saving branding config:', error);
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    }
}

// Reset branding to defaults
function resetBrandingDefaults() {
    if (!confirm('Reset all branding settings to default values?')) return;
    
    document.getElementById('brandingTitle').value = '';
    document.getElementById('brandingWatermark').value = '';
    document.getElementById('brandingColor').value = '#007bff';
    document.getElementById('brandingColorHex').value = '#007bff';
    document.getElementById('brandingBackgroundColor').value = '#ffffff';
    document.getElementById('brandingBackgroundColorHex').value = '#ffffff';
    document.getElementById('brandingFont').value = 'Arial';
    document.getElementById('brandingLogo').value = '';
    document.getElementById('brandingEnabled').checked = true;
    
    updateBrandingPreview();
}

// Queue Management Functions
let allQueueData = {
    download: { pending: [], in_progress: [], completed: [], failed: [], priorities: {} },
    transcription: { pending: [], processing: [], completed: [], failed: [] },
    translation: { pending: [], processing: [], completed: [] },
    video: { pending: [], processing: [], completed: [] }
};

function refreshAllQueues() {
    loadDownloadQueue();
    loadTranscriptionQueue();
    loadTranslationQueue();
    loadVideoQueue();
}

function refreshQueue() {
    // Backward compatibility
    refreshAllQueues();
}

function loadDownloadQueue() {
    fetch('/admin/api/queue/download')
        .then(response => response.json())
        .then(data => {
            allQueueData.download = data;
            displayDownloadQueue();
            updateQueueBadges();
        })
        .catch(error => {
            console.error('Error loading download queue:', error);
            showQueueError('downloadPendingList', 'Error loading download queue');
            showQueueError('downloadProgressList', 'Error loading download queue');
        });
}

function loadTranscriptionQueue() {
    fetch('/admin/api/queue/transcription')
        .then(response => response.json())
        .then(data => {
            allQueueData.transcription = data;
            displayTranscriptionQueue();
            updateQueueBadges();
        })
        .catch(error => {
            console.error('Error loading transcription queue:', error);
            showQueueError('transcriptionJobsList', 'Error loading transcription queue');
        });
}

function loadTranslationQueue() {
    fetch('/admin/api/queue/translation')
        .then(response => response.json())
        .then(data => {
            allQueueData.translation = data;
            displayTranslationQueue();
            updateQueueBadges();
        })
        .catch(error => {
            console.error('Error loading translation queue:', error);
            showQueueError('translationJobsList', 'Error loading translation queue');
        });
}

function loadVideoQueue() {
    fetch('/admin/api/queue/video')
        .then(response => response.json())
        .then(data => {
            allQueueData.video = data;
            displayVideoQueue();
            updateQueueBadges();
        })
        .catch(error => {
            console.error('Error loading video queue:', error);
            showQueueError('videoJobsList', 'Error loading video queue');
        });
}

function showQueueError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        const colspan = element.closest('table').querySelectorAll('thead th').length;
        element.innerHTML = `<tr><td colspan="${colspan}" class="text-danger text-center">${message}</td></tr>`;
    }
}

function updateQueueBadges() {
    // Update tab badges with queue counts
    const downloadTotal = (allQueueData.download.pending?.length || 0) + (allQueueData.download.in_progress?.length || 0);
    const transcriptionTotal = (allQueueData.transcription.pending?.length || 0) + (allQueueData.transcription.processing?.length || 0);
    const translationTotal = (allQueueData.translation.pending?.length || 0) + (allQueueData.translation.processing?.length || 0);
    const videoTotal = (allQueueData.video.pending?.length || 0) + (allQueueData.video.processing?.length || 0);
    
    document.getElementById('downloadQueueBadge').textContent = downloadTotal;
    document.getElementById('transcriptionQueueBadge').textContent = transcriptionTotal;
    document.getElementById('translationQueueBadge').textContent = translationTotal;
    document.getElementById('videoQueueBadge').textContent = videoTotal;
    
    // Update badge colors based on queue status
    updateBadgeColor('downloadQueueBadge', downloadTotal);
    updateBadgeColor('transcriptionQueueBadge', transcriptionTotal);
    updateBadgeColor('translationQueueBadge', translationTotal);
    updateBadgeColor('videoQueueBadge', videoTotal);
}

function updateBadgeColor(badgeId, count) {
    const badge = document.getElementById(badgeId);
    if (badge) {
        badge.className = count > 0 ? 'badge bg-warning ms-1' : 'badge bg-secondary ms-1';
    }
}

function loadQueue() {
    // Backward compatibility - load download queue
    loadDownloadQueue();
}

function displayDownloadQueue() {
    const data = allQueueData.download;
    
    // Update counts
    document.getElementById('downloadPendingCount').textContent = data.pending?.length || 0;
    document.getElementById('downloadProgressCount').textContent = data.in_progress?.length || 0;
    document.getElementById('downloadCompletedCount').textContent = data.completed?.length || 0;
    document.getElementById('downloadFailedCount').textContent = data.failed?.length || 0;
    
    // Display pending jobs
    const pendingTbody = document.getElementById('downloadPendingList');
    if (!data.pending || data.pending.length === 0) {
        pendingTbody.innerHTML = '<tr><td colspan="6" class="text-center">No pending jobs</td></tr>';
    } else {
        pendingTbody.innerHTML = data.pending.map(job => `
            <tr>
                <td><code>${job.space_id}</code></td>
                <td>${job.user_id || 'Anonymous'}</td>
                <td>
                    <select class="form-select form-select-sm" onchange="updateJobPriority(${job.id}, this.value)" style="width: auto;">
                        ${Object.entries(data.priorities || {}).map(([value, label]) => 
                            `<option value="${value}" ${job.priority == value ? 'selected' : ''}>${label}</option>`
                        ).join('')}
                    </select>
                    <span class="badge ${getPriorityBadgeClass(job.priority)} ms-2">${job.priority_label}</span>
                </td>
                <td><small class="text-muted">${formatDate(job.created_at)}</small></td>
                <td><span class="badge bg-secondary">${job.file_type || 'mp3'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger me-1" onclick="cancelDownloadJob(${job.id})" title="Cancel Job">
                        <i class="bi bi-x-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails(${job.id})" title="View Details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Display in-progress jobs
    const progressTbody = document.getElementById('downloadProgressList');
    if (!data.in_progress || data.in_progress.length === 0) {
        progressTbody.innerHTML = '<tr><td colspan="6" class="text-center">No jobs in progress</td></tr>';
    } else {
        progressTbody.innerHTML = data.in_progress.map(job => `
            <tr>
                <td><code>${job.space_id}</code></td>
                <td>${job.user_id || 'Anonymous'}</td>
                <td><span class="badge ${getPriorityBadgeClass(job.priority)}">${job.priority_label}</span></td>
                <td>
                    <div class="progress" style="width: 100px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${job.progress_in_percent || 0}%" 
                             title="${job.progress_in_percent || 0}%">
                            ${job.progress_in_percent || 0}%
                        </div>
                    </div>
                </td>
                <td><small class="text-muted">${formatDate(job.start_time)}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger me-1" onclick="cancelDownloadJob(${job.id})" title="Cancel Download">
                        <i class="bi bi-x-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails(${job.id})" title="View Details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Display completed jobs (limit to 10 most recent)
    const completedTbody = document.getElementById('downloadCompletedList');
    if (!data.completed || data.completed.length === 0) {
        completedTbody.innerHTML = '<tr><td colspan="6" class="text-center">No completed jobs</td></tr>';
    } else {
        const recentCompleted = data.completed.slice(0, 10);
        completedTbody.innerHTML = recentCompleted.map(job => `
            <tr>
                <td><small>${job.id}</small></td>
                <td><code>${job.space_id}</code></td>
                <td><small class="text-muted">${formatDate(job.start_time)}</small></td>
                <td><small class="text-muted">${formatDate(job.end_time)}</small></td>
                <td><span class="badge bg-secondary">${job.file_type || 'mp3'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-warning me-1" onclick="removeDownloadJob(${job.id})" title="Remove Record">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails(${job.id})" title="View Details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Display failed jobs (limit to 10 most recent)
    const failedTbody = document.getElementById('downloadFailedList');
    if (!data.failed || data.failed.length === 0) {
        failedTbody.innerHTML = '<tr><td colspan="6" class="text-center">No failed jobs</td></tr>';
    } else {
        const recentFailed = data.failed.slice(0, 10);
        failedTbody.innerHTML = recentFailed.map(job => `
            <tr>
                <td><small>${job.id}</small></td>
                <td><code>${job.space_id}</code></td>
                <td><small class="text-muted">${formatDate(job.start_time)}</small></td>
                <td><small class="text-danger" title="${job.error_message || ''}">${(job.error_message || 'Unknown error').substring(0, 50)}${job.error_message && job.error_message.length > 50 ? '...' : ''}</small></td>
                <td><span class="badge bg-secondary">${job.file_type || 'mp3'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-warning me-1" onclick="removeDownloadJob(${job.id})" title="Remove Record">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails(${job.id})" title="View Details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

function displayTranscriptionQueue() {
    const data = allQueueData.transcription;
    
    // Update counts
    document.getElementById('transcriptionPendingCount').textContent = data.pending?.length || 0;
    document.getElementById('transcriptionProgressCount').textContent = data.processing?.length || 0;
    document.getElementById('transcriptionCompletedCount').textContent = data.completed?.length || 0;
    document.getElementById('transcriptionFailedCount').textContent = data.failed?.length || 0;
    
    // Combine all jobs for display
    const allJobs = [
        ...(data.pending || []).map(job => ({...job, status: 'pending'})),
        ...(data.processing || []).map(job => ({...job, status: 'processing'})),
        ...(data.completed || []).slice(0, 10).map(job => ({...job, status: 'completed'})),
        ...(data.failed || []).slice(0, 5).map(job => ({...job, status: 'failed'}))
    ];
    
    const tbody = document.getElementById('transcriptionJobsList');
    if (allJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No transcription jobs</td></tr>';
    } else {
        tbody.innerHTML = allJobs.map(job => `
            <tr>
                <td><code>${job.job_id || job.id}</code></td>
                <td><code>${job.space_id}</code></td>
                <td><span class="badge bg-info">${job.model || job.options?.model || 'Unknown'}</span></td>
                <td><span class="badge bg-secondary">${job.language || job.options?.language || 'Auto'}</span></td>
                <td><span class="badge ${getJobStatusBadgeClass(job.status)}">${job.status}</span></td>
                <td>
                    ${job.status === 'processing' ? 
                        `<div class="progress" style="width: 80px;">
                            <div class="progress-bar" style="width: ${job.progress || 0}%">${job.progress || 0}%</div>
                        </div>` : 
                        '-'
                    }
                </td>
                <td><small class="text-muted">${formatDate(job.created_at)}</small></td>
                <td>
                    ${(job.status === 'pending' || job.status === 'processing') ? 
                        `<button class="btn btn-sm btn-outline-danger me-1" onclick="cancelTranscriptionJob('${job.job_id || job.id}')" title="Cancel Job">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTranscriptionJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>` :
                        `<button class="btn btn-sm btn-outline-warning me-1" onclick="removeTranscriptionJob('${job.job_id || job.id}')" title="Remove Record">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTranscriptionJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>`
                    }
                </td>
            </tr>
        `).join('');
    }
}

function displayTranslationQueue() {
    const data = allQueueData.translation;
    
    // Update counts
    document.getElementById('translationPendingCount').textContent = data.pending?.length || 0;
    document.getElementById('translationProgressCount').textContent = data.processing?.length || 0;
    document.getElementById('translationCompletedCount').textContent = data.completed?.length || 0;
    
    // Combine all jobs for display
    const allJobs = [
        ...(data.pending || []).map(job => ({...job, status: 'pending'})),
        ...(data.processing || []).map(job => ({...job, status: 'processing'})),
        ...(data.completed || []).slice(0, 10).map(job => ({...job, status: 'completed'}))
    ];
    
    const tbody = document.getElementById('translationJobsList');
    if (allJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No translation jobs</td></tr>';
    } else {
        tbody.innerHTML = allJobs.map(job => `
            <tr>
                <td><code>${job.job_id || job.id}</code></td>
                <td><code>${job.space_id}</code></td>
                <td><span class="badge bg-primary">${job.source_language || 'Auto'}</span></td>
                <td><span class="badge bg-success">${job.target_language || job.options?.translate_to || 'en'}</span></td>
                <td><span class="badge ${getJobStatusBadgeClass(job.status)}">${job.status}</span></td>
                <td>
                    ${job.status === 'processing' ? 
                        `<div class="progress" style="width: 80px;">
                            <div class="progress-bar" style="width: ${job.progress || 0}%">${job.progress || 0}%</div>
                        </div>` : 
                        '-'
                    }
                </td>
                <td><small class="text-muted">${formatDate(job.created_at)}</small></td>
                <td>
                    ${(job.status === 'pending' || job.status === 'processing') ? 
                        `<button class="btn btn-sm btn-outline-danger me-1" onclick="cancelTranslationJob('${job.job_id || job.id}')" title="Cancel Job">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTranslationJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>` :
                        `<button class="btn btn-sm btn-outline-warning me-1" onclick="removeTranslationJob('${job.job_id || job.id}')" title="Remove Record">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTranslationJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>`
                    }
                </td>
            </tr>
        `).join('');
    }
}

function displayVideoQueue() {
    const data = allQueueData.video;
    
    // Update counts
    document.getElementById('videoPendingCount').textContent = data.pending?.length || 0;
    document.getElementById('videoProgressCount').textContent = data.processing?.length || 0;
    document.getElementById('videoCompletedCount').textContent = data.completed?.length || 0;
    
    // Combine all jobs for display
    const allJobs = [
        ...(data.pending || []).map(job => ({...job, status: 'pending'})),
        ...(data.processing || []).map(job => ({...job, status: 'processing'})),
        ...(data.completed || []).slice(0, 10).map(job => ({...job, status: 'completed'}))
    ];
    
    const tbody = document.getElementById('videoJobsList');
    if (allJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No video generation jobs</td></tr>';
    } else {
        tbody.innerHTML = allJobs.map(job => `
            <tr>
                <td><code>${job.job_id || job.id}</code></td>
                <td><code>${job.space_id}</code></td>
                <td>${job.user_id || 'Anonymous'}</td>
                <td><span class="badge ${getJobStatusBadgeClass(job.status)}">${job.status}</span></td>
                <td>
                    ${job.status === 'processing' ? 
                        `<div class="progress" style="width: 80px;">
                            <div class="progress-bar" style="width: ${job.progress || 0}%">${job.progress || 0}%</div>
                        </div>` : 
                        '-'
                    }
                </td>
                <td><small class="text-muted">${formatDate(job.created_at)}</small></td>
                <td>
                    ${(job.status === 'pending' || job.status === 'processing') ? 
                        `<button class="btn btn-sm btn-outline-danger me-1" onclick="cancelVideoJob('${job.job_id || job.id}')" title="Cancel Job">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewVideoJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>` :
                        `<button class="btn btn-sm btn-outline-warning me-1" onclick="removeVideoJob('${job.job_id || job.id}')" title="Remove Record">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewVideoJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>`
                    }
                </td>
            </tr>
        `).join('');
    }
}

function getJobStatusBadgeClass(status) {
    switch (status) {
        case 'pending': return 'bg-warning text-dark';
        case 'processing': return 'bg-info';
        case 'completed': return 'bg-success';
        case 'failed': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function displayQueue() {
    // Backward compatibility - display download queue
    displayDownloadQueue();
}

function getPriorityBadgeClass(priority) {
    switch (priority) {
        case 1: return 'bg-danger';
        case 2: return 'bg-warning';
        case 3: return 'bg-secondary';
        case 4: return 'bg-info';
        case 5: return 'bg-success';
        default: return 'bg-secondary';
    }
}

function updateJobPriority(jobId, newPriority) {
    fetch(`/admin/api/jobs/${jobId}/priority`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ priority: parseInt(newPriority) })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Show success message
            showToast('Priority updated successfully', 'success');
            // Refresh queue to show new order
            setTimeout(loadQueue, 500);
        } else {
            showToast('Error: ' + result.error, 'error');
            // Revert the select value
            loadQueue();
        }
    })
    .catch(error => {
        console.error('Error updating priority:', error);
        showToast('Error updating priority', 'error');
        loadQueue();
    });
}

function cancelJob(jobId) {
    // Delegate to the existing cancelDownloadJob function
    cancelDownloadJob(jobId);
}

function viewJobDetails(jobId) {
    // Implementation would go here - show job details modal
    showToast('Job details view not yet implemented', 'info');
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString();
}

function clearAllCaches() {
    if (!confirm('Are you sure you want to clear all caches? This will force a reload of all data from the database.')) {
        return;
    }
    
    // Show loading state
    const cacheMessage = document.getElementById('cacheMessage');
    cacheMessage.className = 'alert alert-info mt-3';
    cacheMessage.innerHTML = '<i class="bi bi-hourglass-split spin"></i> Clearing caches...';
    cacheMessage.style.display = 'block';
    
    fetch('/admin/api/cache/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            cacheMessage.className = 'alert alert-success mt-3';
            cacheMessage.innerHTML = '<i class="bi bi-check-circle"></i> ' + result.message;
            
            // Show toast notification
            showToast('All caches have been cleared successfully', 'success');
            
            // Hide message after 5 seconds
            setTimeout(() => {
                cacheMessage.style.display = 'none';
            }, 5000);
            
            // Refresh any active data displays
            if (window.location.hash === '#queue' || document.querySelector('#queue-tab.active')) {
                refreshAllQueues();
            }
            
            // Reload cache status
            setTimeout(loadCacheStatus, 1000);
        } else {
            cacheMessage.className = 'alert alert-danger mt-3';
            cacheMessage.innerHTML = '<i class="bi bi-x-circle"></i> Error: ' + (result.error || 'Failed to clear caches');
            showToast('Error clearing caches', 'error');
        }
    })
    .catch(error => {
        console.error('Error clearing caches:', error);
        cacheMessage.className = 'alert alert-danger mt-3';
        cacheMessage.innerHTML = '<i class="bi bi-x-circle"></i> Error clearing caches';
        showToast('Error clearing caches', 'error');
    });
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// Queue management action functions
function cancelTranscriptionJob(jobId) {
    if (!confirm('Are you sure you want to cancel this transcription job?')) return;
    
    fetch(`/admin/api/transcription/${jobId}/cancel`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Transcription job cancelled', 'success');
            loadTranscriptionQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error cancelling transcription job:', error);
        showToast('Error cancelling transcription job', 'error');
    });
}

function cancelTranslationJob(jobId) {
    if (!confirm('Are you sure you want to cancel this translation job?')) return;
    
    fetch(`/admin/api/translation/${jobId}/cancel`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Translation job cancelled', 'success');
            loadTranslationQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error cancelling translation job:', error);
        showToast('Error cancelling translation job', 'error');
    });
}

function cancelVideoJob(jobId) {
    if (!confirm('Are you sure you want to cancel this video generation job?')) return;
    
    fetch(`/admin/api/video/${jobId}/cancel`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Video job cancelled', 'success');
            loadVideoQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error cancelling video job:', error);
        showToast('Error cancelling video job', 'error');
    });
}

function cancelDownloadJob(jobId) {
    if (!confirm('Are you sure you want to cancel this download job? This will stop the download process.')) return;
    
    fetch(`/admin/api/download/${jobId}/cancel`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const message = result.process_killed ? 
                'Download job cancelled and process terminated' : 
                'Download job cancelled';
            showToast(message, 'success');
            loadDownloadQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error cancelling download job:', error);
        showToast('Error cancelling download job', 'error');
    });
}

function removeDownloadJob(jobId) {
    if (!confirm('Are you sure you want to remove this job record? This action cannot be undone.')) return;
    
    fetch(`/admin/api/download/${jobId}/remove`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Download job record removed', 'success');
            loadDownloadQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error removing download job:', error);
        showToast('Error removing download job', 'error');
    });
}

function removeTranscriptionJob(jobId) {
    if (!confirm('Are you sure you want to remove this job record? This action cannot be undone.')) return;
    
    fetch(`/admin/api/transcription/${jobId}/remove`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Transcription job record removed', 'success');
            loadTranscriptionQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error removing transcription job:', error);
        showToast('Error removing transcription job', 'error');
    });
}

function removeTranslationJob(jobId) {
    if (!confirm('Are you sure you want to remove this job record? This action cannot be undone.')) return;
    
    fetch(`/admin/api/translation/${jobId}/remove`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Translation job record removed', 'success');
            loadTranslationQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error removing translation job:', error);
        showToast('Error removing translation job', 'error');
    });
}

function removeVideoJob(jobId) {
    if (!confirm('Are you sure you want to remove this job record? This action cannot be undone.')) return;
    
    fetch(`/admin/api/video/${jobId}/remove`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Video job record removed', 'success');
            loadVideoQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error removing video job:', error);
        showToast('Error removing video job', 'error');
    });
}

function viewTranscriptionJobDetails(jobId) {
    fetch(`/admin/api/transcription/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const job = data.job;
                let details = `Job ID: ${jobId}\n`;
                details += `Space ID: ${job.space_id}\n`;
                details += `Status: ${job.status}\n`;
                details += `Progress: ${job.progress || 0}%\n`;
                details += `Model: ${job.model || job.options?.model || 'Unknown'}\n`;
                details += `Language: ${job.language || job.options?.language || 'Auto'}\n`;
                
                if (job.options?.translate_to) {
                    details += `Translate to: ${job.options.translate_to}\n`;
                }
                
                details += `Created: ${formatDate(job.created_at)}\n`;
                
                if (job.updated_at) {
                    details += `Updated: ${formatDate(job.updated_at)}\n`;
                }
                
                if (job.error) {
                    details += `\nError: ${job.error}`;
                }
                
                if (job.result) {
                    details += `\nResult: Transcript generated (${job.result.text_sample || 'No preview available'})`;
                }
                
                alert(details);
            } else {
                showToast('Error: ' + (data.error || 'Job not found'), 'error');
            }
        })
        .catch(error => {
            console.error('Error loading transcription job details:', error);
            showToast('Error loading job details', 'error');
        });
}

function viewTranslationJobDetails(jobId) {
    fetch(`/admin/api/translation/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Job ID: ${jobId}\nSpace: ${data.job.space_id}\nFrom: ${data.job.source_language}\nTo: ${data.job.target_language}\nStatus: ${data.job.status}`);
            } else {
                showToast('Error loading job details', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading translation job details:', error);
            showToast('Error loading job details', 'error');
        });
}

function viewVideoJobDetails(jobId) {
    fetch(`/admin/api/video/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Job ID: ${jobId}\nSpace: ${data.job.space_id}\nUser: ${data.job.user_id}\nStatus: ${data.job.status}\nProgress: ${data.job.progress}%`);
            } else {
                showToast('Error loading job details', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading video job details:', error);
            showToast('Error loading job details', 'error');
        });
}

// Cache Management Functions
function loadCacheStatus() {
    fetch('/admin/api/cache/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('cacheStatusInfo');
            let html = '<ul class="mb-0">';
            
            // Spaces Cache
            if (data.spaces_cache.active) {
                const age = Math.round(data.spaces_cache.age_seconds);
                const expires = Math.round(data.spaces_cache.expires_in_seconds);
                html += `<li><strong>Spaces Cache:</strong> 
                    <span class="badge bg-success">Active</span>
                    <small class="text-muted">(Age: ${formatDuration(age)}, Expires in: ${formatDuration(expires)})</small>
                </li>`;
            } else {
                html += `<li><strong>Spaces Cache:</strong> 
                    <span class="badge bg-secondary">Empty</span>
                    <small class="text-muted">(TTL: ${data.spaces_cache.ttl}s)</small>
                </li>`;
            }
            
            // Index Cache
            if (data.index_cache.active) {
                const age = Math.round(data.index_cache.age_seconds);
                const expires = Math.round(data.index_cache.expires_in_seconds);
                html += `<li><strong>Index Cache:</strong> 
                    <span class="badge bg-success">Active</span>
                    <small class="text-muted">(Age: ${formatDuration(age)}, Expires in: ${formatDuration(expires)})</small>
                </li>`;
            } else {
                html += `<li><strong>Index Cache:</strong> 
                    <span class="badge bg-secondary">Empty</span>
                    <small class="text-muted">(TTL: ${data.index_cache.ttl}s)</small>
                </li>`;
            }
            
            html += '</ul>';
            statusDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading cache status:', error);
            document.getElementById('cacheStatusInfo').innerHTML = 
                '<div class="text-danger">Error loading cache status</div>';
        });
}

function formatDuration(seconds) {
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}m ${remainingSeconds}s`;
}

// Load queue when queue tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const queueTab = document.getElementById('queue-tab');
    if (queueTab) {
        queueTab.addEventListener('shown.bs.tab', function() {
            refreshAllQueues();
        });
    }
    
    // Load all queues on page load if we're on the queue tab
    if (window.location.hash === '#queue' || document.querySelector('#queue-tab.active')) {
        refreshAllQueues();
    }
    
    // Load cache status when settings tab is shown
    const settingsTab = document.getElementById('settings-tab');
    if (settingsTab) {
        settingsTab.addEventListener('shown.bs.tab', function() {
            loadCacheStatus();
        });
    }
    
    // Load cache status on page load if we're on the settings tab
    if (window.location.hash === '#settings' || document.querySelector('#settings-tab.active')) {
        loadCacheStatus();
    }
});

// SQL Logging Functions
let sqlLogData = [];
let sqlLogStatus = false;

function toggleSQLLogging() {
    const action = sqlLogStatus ? 'disable' : 'enable';
    
    fetch(`/admin/api/sql-logging/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sqlLogStatus = !sqlLogStatus;
            updateSQLLogStatus();
            showToast(`SQL logging ${action}d successfully`, 'success');
            if (sqlLogStatus) {
                document.getElementById('sqlPerformanceWarning').style.display = 'block';
                refreshSQLLogs();
            } else {
                document.getElementById('sqlPerformanceWarning').style.display = 'none';
            }
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling SQL logging:', error);
        showToast('Error toggling SQL logging', 'error');
    });
}

function updateSQLLogStatus() {
    const statusBadge = document.getElementById('sqlLogStatus');
    const toggleIcon = document.getElementById('sqlToggleIcon');
    const toggleText = document.getElementById('sqlToggleText');
    
    if (sqlLogStatus) {
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Enabled';
        toggleIcon.className = 'bi bi-power';
        toggleText.textContent = 'Disable';
    } else {
        statusBadge.className = 'badge bg-secondary';
        statusBadge.textContent = 'Disabled';
        toggleIcon.className = 'bi bi-play';
        toggleText.textContent = 'Enable';
    }
}

function refreshSQLLogs() {
    fetch('/admin/api/sql-logs')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sqlLogData = data.logs || [];
                sqlLogStatus = data.enabled || false;
                updateSQLLogStatus();
                displaySQLLogs();
                calculateSQLStats();
            } else {
                showToast('Error loading SQL logs: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading SQL logs:', error);
            showToast('Error loading SQL logs', 'error');
        });
}

function displaySQLLogs() {
    const container = document.getElementById('sqlContainer');
    const componentFilter = document.getElementById('sqlComponentFilter').value;
    const statusFilter = document.getElementById('sqlStatusFilter').value;
    const searchFilter = document.getElementById('sqlSearchFilter').value.toLowerCase();
    
    let filteredLogs = sqlLogData;
    
    // Apply filters
    if (componentFilter) {
        filteredLogs = filteredLogs.filter(log => log.message.includes(`[${componentFilter}]`));
    }
    
    if (statusFilter) {
        filteredLogs = filteredLogs.filter(log => log.message.includes(statusFilter));
    }
    
    if (searchFilter) {
        filteredLogs = filteredLogs.filter(log => 
            log.message.toLowerCase().includes(searchFilter)
        );
    }
    
    document.getElementById('sqlLogCount').textContent = filteredLogs.length;
    
    if (filteredLogs.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-database fs-1"></i>
                <p class="mt-2">No SQL logs found matching current filters.</p>
                <p class="small">Clear filters or enable SQL logging to see queries.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    filteredLogs.forEach(log => {
        const isError = log.level === 'ERROR';
        const timeColor = isError ? '#ff6b6b' : '#4ecdc4';
        const levelColor = isError ? '#ff4757' : '#20bf6b';
        
        html += `
            <div class="mb-2 p-2 border-start border-3" style="border-color: ${levelColor} !important;">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <span class="badge" style="background-color: ${levelColor}; font-size: 0.7rem;">
                        ${log.level}
                    </span>
                    <small style="color: #888;">${log.timestamp}</small>
                </div>
                <div style="color: ${timeColor}; font-size: 0.85rem; word-break: break-all;">
                    ${escapeHtml(log.message)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
}

function calculateSQLStats() {
    const timeRegex = /\((\d+\.?\d*)ms\)/g;
    const times = [];
    let errorCount = 0;
    
    sqlLogData.forEach(log => {
        if (log.level === 'ERROR') {
            errorCount++;
        }
        
        const match = timeRegex.exec(log.message);
        if (match) {
            times.push(parseFloat(match[1]));
        }
        timeRegex.lastIndex = 0; // Reset regex
    });
    
    if (times.length > 0) {
        const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
        const minTime = Math.min(...times);
        const maxTime = Math.max(...times);
        
        document.getElementById('sqlAvgTime').textContent = avgTime.toFixed(2);
        document.getElementById('sqlFastestTime').textContent = minTime.toFixed(2);
        document.getElementById('sqlSlowestTime').textContent = maxTime.toFixed(2);
    } else {
        document.getElementById('sqlAvgTime').textContent = '-';
        document.getElementById('sqlFastestTime').textContent = '-';
        document.getElementById('sqlSlowestTime').textContent = '-';
    }
    
    document.getElementById('sqlErrorCount').textContent = errorCount;
}

function clearSQLLogs() {
    if (!confirm('Are you sure you want to clear all SQL logs? This action cannot be undone.')) {
        return;
    }
    
    fetch('/admin/api/sql-logs/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sqlLogData = [];
            displaySQLLogs();
            calculateSQLStats();
            showToast('SQL logs cleared successfully', 'success');
        } else {
            showToast('Error clearing SQL logs: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error clearing SQL logs:', error);
        showToast('Error clearing SQL logs', 'error');
    });
}

function clearSQLFilters() {
    document.getElementById('sqlComponentFilter').value = '';
    document.getElementById('sqlStatusFilter').value = '';
    document.getElementById('sqlSearchFilter').value = '';
    displaySQLLogs();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize SQL tab when shown
document.addEventListener('DOMContentLoaded', function() {
    const sqlTab = document.getElementById('sql-tab');
    if (sqlTab) {
        sqlTab.addEventListener('shown.bs.tab', function() {
            refreshSQLLogs();
        });
    }
    
    // Filter event listeners
    const filters = ['sqlComponentFilter', 'sqlStatusFilter', 'sqlSearchFilter'];
    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.addEventListener('change', displaySQLLogs);
            element.addEventListener('input', displaySQLLogs);
        }
    });
});

</script>
{% endblock %}