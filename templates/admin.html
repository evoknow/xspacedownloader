{% extends "base.html" %}

{% block title %}Admin Dashboard - XSpace Downloader{% endblock %}

{% block head %}
<!-- List.js for pagination and search -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
<style>
.spin {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* List.js styling */
.search {
    width: 100%;
    padding: 0.375rem 0.75rem;
    margin-bottom: 1rem;
    font-size: 1rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
}

.pagination {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
}

.pagination li {
    display: inline-block;
    margin: 0 2px;
}

.pagination li a {
    display: block;
    padding: 0.375rem 0.75rem;
    color: #0d6efd;
    text-decoration: none;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.pagination li.active a {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.pagination li a:hover {
    background-color: #e9ecef;
}

/* System Messages Table Styling */
#systemMessagesList .sort {
    cursor: pointer;
    user-select: none;
}

#systemMessagesList .sort:hover {
    background-color: #f8f9fa;
}

#systemMessagesList .sort i {
    font-size: 0.75rem;
    opacity: 0.5;
}

#systemMessagesList .sort.asc i::before {
    content: "\f128"; /* bi-arrow-up */
}

#systemMessagesList .sort.desc i::before {
    content: "\f120"; /* bi-arrow-down */
}

/* Template Editor styling */
#templates.tab-pane.fade.active.show {
    display: block !important;
    opacity: 1 !important;
}

#templateEditor {
    font-family: 'Courier New', monospace;
    line-height: 1.4;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
}

#templateSelect {
    min-width: 200px;
}

.template-actions {
    gap: 0.5rem;
}

#templateInfo {
    background: #f8f9fa;
    padding: 8px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

/* Space ID link styling */
.text-decoration-none code {
    color: inherit;
}

.text-decoration-none:hover code {
    text-decoration: underline;
}

.text-decoration-none .bi-box-arrow-up-right {
    opacity: 0.6;
    font-size: 0.75rem;
}

.text-decoration-none:hover .bi-box-arrow-up-right {
    opacity: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-speedometer2"></i> Admin Dashboard
    </h1>
    
    <!-- Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-people-fill"></i> Total Users
                    </h5>
                    <h2 class="mb-0">{{ total_users }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-collection-play-fill"></i> Total Spaces
                    </h5>
                    <h2 class="mb-0">{{ total_spaces }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-download"></i> Total Downloads
                    </h5>
                    <h2 class="mb-0">{{ total_downloads }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-play-circle-fill"></i> Total Plays
                    </h5>
                    <h2 class="mb-0">{{ total_plays }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Monitoring -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-cpu"></i> System Resources
                        <span class="badge bg-success ms-2" id="systemStatus">Monitoring...</span>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- CPU Usage -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">
                                        <i class="bi bi-cpu"></i> CPU Usage
                                    </h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="cpuProgress" style="width: 0%">0%</div>
                                    </div>
                                    <small class="text-muted" id="cpuDetails">Loading...</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Memory Usage -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">
                                        <i class="bi bi-memory"></i> Memory Usage
                                    </h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="memoryProgress" style="width: 0%">0%</div>
                                    </div>
                                    <small class="text-muted" id="memoryDetails">Loading...</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- GPU Usage -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">
                                        <i class="bi bi-gpu-card"></i> GPU Usage
                                    </h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="gpuProgress" style="width: 0%">0%</div>
                                    </div>
                                    <small class="text-muted" id="gpuDetails">Loading...</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Disk Usage -->
                        <div class="col-md-3 mb-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title">
                                        <i class="bi bi-hdd"></i> Disk Usage
                                    </h6>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="diskProgress" style="width: 0%">0%</div>
                                    </div>
                                    <small class="text-muted" id="diskDetails">Loading...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                <i class="bi bi-people"></i> Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="spaces-tab" data-bs-toggle="tab" data-bs-target="#spaces" type="button" role="tab">
                <i class="bi bi-collection-play"></i> Spaces
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button" role="tab">
                <i class="bi bi-list-ol"></i> Queue
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button" role="tab">
                <i class="bi bi-graph-up"></i> Statistics
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="costs-tab" data-bs-toggle="tab" data-bs-target="#costs" type="button" role="tab">
                <i class="bi bi-coin"></i> Cost Management
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="/admin/ads">
                <i class="bi bi-megaphone"></i> Ads
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="/admin/affiliates">
                <i class="bi bi-people"></i> Affiliates
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="/admin/products">
                <i class="bi bi-box-seam"></i> Products
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                <i class="bi bi-gear"></i> Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="/admin/templates">
                <i class="bi bi-code-square"></i> Templates
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="/admin/logs">
                <i class="bi bi-file-text"></i> Logs
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="/admin/sql">
                <i class="bi bi-database"></i> SQL
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="/admin/status">
                <i class="bi bi-activity"></i> System Status
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab">
                <i class="bi bi-question-circle"></i> Help
            </button>
        </li>
        {% if is_localhost %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="development-tab" data-bs-toggle="tab" data-bs-target="#development" type="button" role="tab">
                <i class="bi bi-code-slash text-warning"></i> Development
            </button>
        </li>
        {% endif %}
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="adminTabContent">
        <!-- Users Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title">Manage Users</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="userSearch" placeholder="Search by email...">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchUsers()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Admin</th>
                                    <th>Credits</th>
                                    <th>Country</th>
                                    <th>Logins</th>
                                    <th>Spaces</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                                <tr>
                                    <td colspan="10" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination justify-content-center" id="usersPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Spaces Tab -->
        <div class="tab-pane fade" id="spaces" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title">Manage Spaces</h5>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="spaceSearch" placeholder="Search spaces...">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchSpaces()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Host</th>
                                    <th>User</th>
                                    <th>Downloads</th>
                                    <th>Plays</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="spacesList">
                                <tr>
                                    <td colspan="7" class="text-center">Loading spaces...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <nav>
                        <ul class="pagination justify-content-center" id="spacesPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Queue Management Tab -->
        <div class="tab-pane fade" id="queue" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="card-title">
                                <i class="bi bi-list-task"></i> Queue Management
                            </h5>
                            <p class="text-muted">Manage all queue types: downloads, transcriptions, translations, and video generation</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-outline-primary" onclick="refreshAllQueues()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Queue Type Tabs -->
                    <ul class="nav nav-pills mb-4" id="queueTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="download-queue-tab" data-bs-toggle="pill" 
                                    data-bs-target="#download-queue" type="button" role="tab">
                                <i class="bi bi-download"></i> Downloads
                                <span class="badge bg-secondary ms-1" id="downloadQueueBadge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="transcription-queue-tab" data-bs-toggle="pill" 
                                    data-bs-target="#transcription-queue" type="button" role="tab">
                                <i class="bi bi-mic"></i> Transcriptions
                                <span class="badge bg-secondary ms-1" id="transcriptionQueueBadge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="translation-queue-tab" data-bs-toggle="pill" 
                                    data-bs-target="#translation-queue" type="button" role="tab">
                                <i class="bi bi-translate"></i> Translations
                                <span class="badge bg-secondary ms-1" id="translationQueueBadge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="video-queue-tab" data-bs-toggle="pill" 
                                    data-bs-target="#video-queue" type="button" role="tab">
                                <i class="bi bi-camera-video"></i> Videos
                                <span class="badge bg-secondary ms-1" id="videoQueueBadge">0</span>
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="queueTypeTabContent">
                        
                        <!-- Download Queue Tab -->
                        <div class="tab-pane fade show active" id="download-queue" role="tabpanel">
                            <!-- Queue Status -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-clock"></i> Pending
                                            </h6>
                                            <h3 class="mb-0" id="downloadPendingCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-download"></i> In Progress
                                            </h6>
                                            <h3 class="mb-0" id="downloadProgressCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-check-circle"></i> Completed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="downloadCompletedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-x-circle"></i> Failed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="downloadFailedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pending Jobs -->
                            <div class="mb-4">
                                <h6>Pending Jobs (ordered by priority)</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Space ID</th>
                                                <th>User</th>
                                                <th>Priority</th>
                                                <th>Created</th>
                                                <th>File Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadPendingList">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading pending jobs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- In Progress Jobs -->
                            <div>
                                <h6>Jobs In Progress</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Space ID</th>
                                                <th>User</th>
                                                <th>Priority</th>
                                                <th>Progress</th>
                                                <th>Started</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadProgressList">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading in-progress jobs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Completed Downloads -->
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-check-circle me-2"></i>Completed Downloads (Last 10)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Job ID</th>
                                                <th>Space ID</th>
                                                <th>Start Time</th>
                                                <th>End Time</th>
                                                <th>File Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadCompletedList">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading completed jobs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Failed Downloads -->
                            <div class="card mt-3">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-x-circle me-2"></i>Failed Downloads (Last 10)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Job ID</th>
                                                <th>Space ID</th>
                                                <th>Start Time</th>
                                                <th>Error</th>
                                                <th>File Type</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="downloadFailedList">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading failed jobs...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transcription Queue Tab -->
                        <div class="tab-pane fade" id="transcription-queue" role="tabpanel">
                            <!-- Queue Status -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-clock"></i> Pending
                                            </h6>
                                            <h3 class="mb-0" id="transcriptionPendingCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-mic"></i> Processing
                                            </h6>
                                            <h3 class="mb-0" id="transcriptionProgressCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-check-circle"></i> Completed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="transcriptionCompletedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-x-circle"></i> Failed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="transcriptionFailedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Transcription Jobs -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Job ID</th>
                                            <th>Space ID</th>
                                            <th>Model</th>
                                            <th>Language</th>
                                            <th>Status</th>
                                            <th>Progress</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transcriptionJobsList">
                                        <tr>
                                            <td colspan="8" class="text-center">Loading transcription jobs...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Translation Queue Tab -->
                        <div class="tab-pane fade" id="translation-queue" role="tabpanel">
                            <!-- Queue Status -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-clock"></i> Pending
                                            </h6>
                                            <h3 class="mb-0" id="translationPendingCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-translate"></i> Processing
                                            </h6>
                                            <h3 class="mb-0" id="translationProgressCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-check-circle"></i> Completed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="translationCompletedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Translation Jobs -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Job ID</th>
                                            <th>Space ID</th>
                                            <th>From Language</th>
                                            <th>To Language</th>
                                            <th>Status</th>
                                            <th>Progress</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="translationJobsList">
                                        <tr>
                                            <td colspan="8" class="text-center">Loading translation jobs...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Video Generation Queue Tab -->
                        <div class="tab-pane fade" id="video-queue" role="tabpanel">
                            <!-- Queue Status -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-clock"></i> Pending
                                            </h6>
                                            <h3 class="mb-0" id="videoPendingCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-info text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-camera-video"></i> Generating
                                            </h6>
                                            <h3 class="mb-0" id="videoProgressCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-check-circle"></i> Completed (24h)
                                            </h6>
                                            <h3 class="mb-0" id="videoCompletedCount">-</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Video Generation Jobs -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Job ID</th>
                                            <th>Space ID</th>
                                            <th>User</th>
                                            <th>Status</th>
                                            <th>Progress</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="videoJobsList">
                                        <tr>
                                            <td colspan="7" class="text-center">Loading video generation jobs...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Tab -->
        <div class="tab-pane fade" id="stats" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Site Statistics</h5>
                    
                    <!-- Period Selection -->
                    <div class="btn-group mb-3" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="changePeriod('daily')">Daily</button>
                        <button type="button" class="btn btn-outline-primary" onclick="changePeriod('weekly')">Weekly</button>
                        <button type="button" class="btn btn-outline-primary" onclick="changePeriod('monthly')">Monthly</button>
                        <button type="button" class="btn btn-outline-primary" onclick="changePeriod('all')">All Time</button>
                    </div>
                    
                    <!-- Statistics Cards -->
                    <div class="row">
                        <!-- Space Submissions Chart -->
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Space Submissions</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="submissionsChart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Popular Spaces -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Most Played Spaces</h6>
                                </div>
                                <div class="card-body">
                                    <div id="popularSpacesList" class="list-group">
                                        <div class="text-center">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Most Downloaded -->
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Most Downloaded Spaces</h6>
                                </div>
                                <div class="card-body">
                                    <div id="downloadedSpacesList" class="list-group">
                                        <div class="text-center">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Active Users -->
                        <div class="col-md-12 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Most Active Users</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Email</th>
                                                    <th>Country</th>
                                                    <th>Logins</th>
                                                    <th>Spaces</th>
                                                    <th>Downloads</th>
                                                    <th>Plays</th>
                                                </tr>
                                            </thead>
                                            <tbody id="activeUsersList">
                                                <tr>
                                                    <td colspan="6" class="text-center">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cost Management Tab -->
        <div class="tab-pane fade" id="costs" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Cost Management</h5>
                    
                    <!-- Compute Cost Settings -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> Compute Cost Settings</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">Configure the cost per second for compute operations (MP3/MP4 generation).</p>
                            <form id="computeCostForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="computeCostPerSecond">Cost per Second (USD)</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="computeCostPerSecond" 
                                                       step="0.0000001" min="0" value="0.001" required>
                                                <span class="input-group-text">per second</span>
                                            </div>
                                            <small class="form-text text-muted">
                                                Default: $0.001/second. This applies to MP3 and MP4 generation.
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="alert alert-info mb-0">
                                            <strong>Example:</strong><br>
                                            A 60-minute audio file = 3600 seconds<br>
                                            At $0.001/second = $3.60 cost
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary mt-3">
                                    <i class="bi bi-save"></i> Update Compute Cost
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- AI Model Costs -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-robot"></i> AI Model Costs</h6>
                            <div>
                                <button class="btn btn-sm btn-success" onclick="updateOpenAIPricing()">
                                    <i class="bi bi-arrow-clockwise"></i> Update OpenAI Pricing
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="openAddAICostModal()">
                                    <i class="bi bi-plus"></i> Add Model
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">Manage AI model pricing for accurate cost tracking.</p>
                            
                            <!-- List.js container -->
                            <div id="aiCostsList">
                                <!-- Search input -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <input class="search form-control" placeholder="Search vendors, models..." />
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <span class="text-muted">
                                            Showing <span class="list-showing">0</span> of <span class="list-total">0</span> models
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped" id="aiCostsTable">
                                        <thead>
                                            <tr>
                                                <th class="sort" data-sort="vendor">Vendor <i class="bi bi-arrow-down-up"></i></th>
                                                <th class="sort" data-sort="model">Model <i class="bi bi-arrow-down-up"></i></th>
                                                <th class="sort" data-sort="input-cost">Input Cost (per 1M tokens) <i class="bi bi-arrow-down-up"></i></th>
                                                <th class="sort" data-sort="output-cost">Output Cost (per 1M tokens) <i class="bi bi-arrow-down-up"></i></th>
                                                <th class="sort" data-sort="updated">Last Updated <i class="bi bi-arrow-down-up"></i></th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody class="list">
                                            <!-- AI costs will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <ul class="pagination"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Credits Overview -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-people"></i> User Credits Overview</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <h3 id="totalCredits">$0.00</h3>
                                    <p class="text-muted">Total Credits in System</p>
                                </div>
                                <div class="col-md-3">
                                    <h3 id="avgCredits">$0.00</h3>
                                    <p class="text-muted">Average Credits per User</p>
                                </div>
                                <div class="col-md-3">
                                    <h3 id="weeklyCreditsAdded">$0.00</h3>
                                    <p class="text-muted">Weekly Credits Added</p>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-success" onclick="addWeeklyCredits()">
                                        <i class="bi bi-coin"></i> Add $5 to All Users
                                    </button>
                                    <p class="text-muted mt-2">Manual Weekly Credit</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost Usage Statistics -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-graph-up"></i> Cost Usage Statistics</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <canvas id="costByTypeChart"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <canvas id="costByVendorChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ads Tab -->
        <div class="tab-pane fade" id="ads" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-megaphone"></i> Advertisement Management
                    </h5>
                    
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Current Status</h6>
                        <p>Ads are currently managed via command line. Use the commands below on the server:</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Common Commands</h6>
                                </div>
                                <div class="card-body">
                                    <h6>List all ads:</h6>
                                    <code>python admin_ads.py list</code>
                                    
                                    <h6 class="mt-3">Create new ad:</h6>
                                    <code>python admin_ads.py create --copy "Your ad HTML" --start "2025-01-01 00:00:00" --end "2025-12-31 23:59:59" --max-impressions 1000</code>
                                    
                                    <h6 class="mt-3">Activate ad:</h6>
                                    <code>python admin_ads.py activate 3</code>
                                    
                                    <h6 class="mt-3">Suspend ad:</h6>
                                    <code>python admin_ads.py suspend 3</code>
                                    
                                    <h6 class="mt-3">Delete ad:</h6>
                                    <code>python admin_ads.py delete 3</code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Current Active Ads</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Note:</strong> Run <code>python admin_ads.py list</code> to see current ads with their status and impression counts.</p>
                                    
                                    <h6>Features:</h6>
                                    <ul>
                                        <li>HTML content support</li>
                                        <li>Date range scheduling</li>
                                        <li>Impression limits</li>
                                        <li>Status management (active/suspended/pending)</li>
                                        <li>Automatic impression tracking</li>
                                    </ul>
                                    
                                    <p class="mt-3"><strong>Ads display:</strong> Active ads are shown to logged-in users on the homepage in the "For You" section.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">System Settings</h5>
                    
                    <!-- Settings Accordion -->
                    <div class="accordion" id="settingsAccordion">
                        
                        <!-- Cache Management Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="cacheHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#cacheCollapse" aria-expanded="false" aria-controls="cacheCollapse">
                                    <i class="bi bi-arrow-clockwise me-2"></i> Cache Management
                                </button>
                            </h2>
                            <div id="cacheCollapse" class="accordion-collapse collapse" 
                                 aria-labelledby="cacheHeading" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                            <p class="mb-3">Manage application caches to ensure fresh data is displayed.</p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2">Current Cache Status</h6>
                                            <div id="cacheStatusInfo">
                                                <div class="text-center">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    Loading cache status...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-subtitle mb-2">Cache Actions</h6>
                                            <p class="mb-3">Clear all caches to force reload of fresh data from the database.</p>
                                            <button type="button" class="btn btn-warning" onclick="clearAllCaches()">
                                                <i class="bi bi-trash"></i> Clear All Caches
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3" style="display: none;" id="cacheMessage"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rate Limiting Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="rateLimitHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#rateLimitCollapse" aria-expanded="false" aria-controls="rateLimitCollapse">
                                    <i class="bi bi-shield-check me-2"></i> Rate Limiting Configuration
                                </button>
                            </h2>
                            <div id="rateLimitCollapse" class="accordion-collapse collapse" 
                                 aria-labelledby="rateLimitHeading" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                        <div class="card-body">
                            <form id="rateLimitForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="dailyLimit" class="form-label">Daily Request Limit</label>
                                        <input type="number" class="form-control" id="dailyLimit" 
                                               value="{{ rate_limits.daily_limit if rate_limits else 200 }}" 
                                               min="1" max="10000">
                                        <div class="form-text">Maximum requests per day per IP address</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="hourlyLimit" class="form-label">Hourly Request Limit</label>
                                        <input type="number" class="form-control" id="hourlyLimit" 
                                               value="{{ rate_limits.hourly_limit if rate_limits else 50 }}" 
                                               min="1" max="1000">
                                        <div class="form-text">Maximum requests per hour per IP address</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="rateLimitEnabled" 
                                               {% if not rate_limits or rate_limits.enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="rateLimitEnabled">
                                            Enable Rate Limiting
                                        </label>
                                    </div>
                                    <div class="form-text">When disabled, no rate limits will be applied</div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Rate Limit Settings
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="rateLimitMessage"></div>
                            </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Play/Download Tracking Configuration -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="trackingHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#trackingCollapse" aria-expanded="false" aria-controls="trackingCollapse">
                                    <i class="bi bi-graph-up me-2"></i> Play & Download Tracking Configuration
                                </button>
                            </h2>
                            <div id="trackingCollapse" class="accordion-collapse collapse" 
                                 aria-labelledby="trackingHeading" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                            <form id="trackingConfigForm">
                                <!-- Play Tracking Settings -->
                                <h6 class="text-primary mb-3">Play Tracking Settings</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="playCooldownMinutes" class="form-label">Play Cooldown Period (minutes)</label>
                                        <input type="number" class="form-control" id="playCooldownMinutes" 
                                               value="30" min="1" max="1440">
                                        <div class="form-text">Time before a user can increment play count again</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="playMinDuration" class="form-label">Minimum Play Duration (seconds)</label>
                                        <input type="number" class="form-control" id="playMinDuration" 
                                               value="30" min="0" max="3600">
                                        <div class="form-text">Minimum duration required to count as a play (0 = disabled)</div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="playTrackingEnabled" checked>
                                        <label class="form-check-label" for="playTrackingEnabled">
                                            Enable Play Tracking
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Download Tracking Settings -->
                                <h6 class="text-primary mb-3">Download Tracking Settings</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="downloadDailyLimit" class="form-label">Daily Download Limit (per user per space)</label>
                                        <input type="number" class="form-control" id="downloadDailyLimit" 
                                               value="1" min="1" max="100">
                                        <div class="form-text">Maximum downloads per user per space per day</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="downloadHourlyIpLimit" class="form-label">Hourly IP Limit (all spaces)</label>
                                        <input type="number" class="form-control" id="downloadHourlyIpLimit" 
                                               value="10" min="1" max="1000">
                                        <div class="form-text">Maximum downloads per IP per hour across all spaces</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="downloadTrackingEnabled" checked>
                                        <label class="form-check-label" for="downloadTrackingEnabled">
                                            Enable Download Tracking
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Tracking Settings
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="trackingConfigMessage"></div>
                            </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transcription Configuration -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="transcriptionHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#transcriptionCollapse" aria-expanded="false" aria-controls="transcriptionCollapse">
                                    <i class="bi bi-mic me-2"></i> Transcription Configuration
                                </button>
                            </h2>
                            <div id="transcriptionCollapse" class="accordion-collapse collapse" 
                                 aria-labelledby="transcriptionHeading" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                        <div class="card-body">
                            <form id="transcriptionConfigForm">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Transcription Provider</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="transcriptionProvider" 
                                                   id="localWhisper" value="local" checked>
                                            <label class="form-check-label" for="localWhisper">
                                                <strong>Local Whisper</strong> - Uses local OpenAI Whisper models
                                            </label>
                                            <div class="form-text ms-4">
                                                <i class="bi bi-cpu text-info"></i> 
                                                CPU-intensive, free, works offline. Default model: tiny (fast), admin can upgrade to base.
                                            </div>
                                        </div>
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="radio" name="transcriptionProvider" 
                                                   id="openaiApi" value="openai">
                                            <label class="form-check-label" for="openaiApi">
                                                <strong>OpenAI API</strong> - Uses OpenAI's cloud transcription service
                                            </label>
                                            <div class="form-text ms-4">
                                                <i class="bi bi-cloud text-success"></i> 
                                                Fast, accurate, costs money per minute. Requires API key.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="openaiApiSettings" style="display: none;">
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label for="openaiApiKey" class="form-label">OpenAI API Key</label>
                                            <input type="password" class="form-control" id="openaiApiKey" 
                                                   placeholder="sk-...">
                                            <div class="form-text">
                                                <span id="apiKeyStatus">Your OpenAI API key for transcription service.</span>
                                                <br><small class="text-muted">Leave unchanged to keep existing key, or enter new key to update.</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="openaiModel" class="form-label">Model</label>
                                            <select class="form-select" id="openaiModel">
                                                <option value="gpt-4o-mini-transcribe">gpt-4o-mini-transcribe (recommended - better & cheaper)</option>
                                                <option value="whisper-1">whisper-1 (legacy)</option>
                                            </select>
                                            <div class="form-text">OpenAI transcription model</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="localWhisperSettings">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="defaultWhisperModel" class="form-label">Default Whisper Model</label>
                                            <select class="form-select" id="defaultWhisperModel">
                                                <option value="tiny" selected>tiny (fastest, less accurate)</option>
                                                <option value="base">base (balanced)</option>
                                                <option value="small">small (slower, more accurate)</option>
                                                <option value="medium">medium (much slower, very accurate)</option>
                                                <option value="large">large (slowest, most accurate)</option>
                                            </select>
                                            <div class="form-text">Default model for new transcriptions</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="whisperDevice" class="form-label">Processing Device</label>
                                            <select class="form-select" id="whisperDevice">
                                                <option value="auto" selected>Auto-detect</option>
                                                <option value="cpu">CPU only</option>
                                                <option value="cuda">CUDA (NVIDIA GPU)</option>
                                            </select>
                                            <div class="form-text">Device for Whisper processing</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Corrective Filter Settings -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <hr>
                                        <h6 class="text-primary mb-3">Corrective Filter (Post-Processing)</h6>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableCorrectiveFilter">
                                            <label class="form-check-label" for="enableCorrectiveFilter">
                                                <strong>Enable Corrective Filter</strong>
                                            </label>
                                            <div class="form-text">
                                                Uses GPT to improve transcript accuracy by fixing spelling, punctuation, and common transcription errors.
                                                <br><small class="text-warning"> Requires OpenAI API key and will increase processing time and costs.</small>
                                            </div>
                                        </div>
                                        <div class="row" id="correctiveFilterSettings">
                                            <div class="col-md-6">
                                                <label for="correctionModel" class="form-label">Correction Model</label>
                                                <select class="form-select" id="correctionModel">
                                                    <option value="gpt-4o-mini">gpt-4o-mini (recommended - fast & cheap)</option>
                                                    <option value="gpt-4o">gpt-4o (higher quality, more expensive)</option>
                                                    <option value="gpt-3.5-turbo">gpt-3.5-turbo (legacy)</option>
                                                </select>
                                                <div class="form-text">Model used for correcting transcripts</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Transcription Settings
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="transcriptionConfigMessage"></div>
                            </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Video Generation Branding Configuration -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="brandingHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#brandingCollapse" aria-expanded="false" aria-controls="brandingCollapse">
                                    <i class="bi bi-palette me-2"></i> Video Generation Branding Configuration
                                </button>
                            </h2>
                            <div id="brandingCollapse" class="accordion-collapse collapse" 
                                 aria-labelledby="brandingHeading" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                        <div class="card-body">
                            <form id="brandingConfigForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="brandingTitle" class="form-label">Video Title Branding</label>
                                        <input type="text" class="form-control" id="brandingTitle" 
                                               placeholder="Your Brand Name - Space Archive">
                                        <div class="form-text">Appears at the beginning of generated video titles</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="brandingWatermark" class="form-label">Video Watermark Text</label>
                                        <input type="text" class="form-control" id="brandingWatermark" 
                                               placeholder="yoursite.com">
                                        <div class="form-text">Text watermark shown on the video (optional)</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="brandingColor" class="form-label">Primary Brand Color</label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" 
                                                   id="brandingColor" value="#007bff" title="Choose brand color">
                                            <input type="text" class="form-control" id="brandingColorHex" 
                                                   value="#007bff" placeholder="#007bff">
                                        </div>
                                        <div class="form-text">Used for video UI elements and progress bars</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="brandingBackgroundColor" class="form-label">Background Color</label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" 
                                                   id="brandingBackgroundColor" value="#ffffff" title="Choose background color">
                                            <input type="text" class="form-control" id="brandingBackgroundColorHex" 
                                                   value="#ffffff" placeholder="#ffffff">
                                        </div>
                                        <div class="form-text">Background color for video elements</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="brandingFont" class="form-label">Font Family</label>
                                        <select class="form-select" id="brandingFont">
                                            <option value="Arial">Arial (default)</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="Trebuchet MS">Trebuchet MS</option>
                                        </select>
                                        <div class="form-text">Font used for text in generated videos</div>
                                    </div>
                                    <div class="col-md-6">
                                        <!-- Empty column for layout balance -->
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="brandingLogo" class="form-label">Logo/Branding Image URL</label>
                                        <input type="url" class="form-control" id="brandingLogo" 
                                               placeholder="https://example.com/logo.png">
                                        <div class="form-text">
                                            URL to your logo image (PNG/JPG, recommended size: 200x50px). 
                                            Will be displayed in the top corner of generated videos.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="brandingEnabled" checked>
                                            <label class="form-check-label" for="brandingEnabled">
                                                <strong>Enable Video Branding</strong>
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            When enabled, all generated videos will include your branding elements.
                                            When disabled, videos will use default styling.
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Preview Section -->
                                <div class="mb-3">
                                    <hr>
                                    <h6 class="text-primary mb-3">Branding Preview</h6>
                                    <div class="card bg-light" id="brandingPreviewCard">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center mb-2">
                                                <div id="brandingPreviewLogo" style="width: 100px; height: 25px; background: #ddd; margin-right: 10px; display: none;">
                                                    <img id="brandingPreviewLogoImg" src="" alt="Logo" style="max-width: 100px; max-height: 25px;">
                                                </div>
                                                <h6 class="mb-0" id="brandingPreviewTitle" style="color: #007bff;">
                                                    Your Brand Name - Sample Space Title
                                                </h6>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div style="width: 200px; height: 8px; background: #e9ecef; border-radius: 4px; margin-right: 10px;">
                                                    <div id="brandingPreviewProgress" style="width: 60%; height: 100%; background: #007bff; border-radius: 4px;"></div>
                                                </div>
                                                <small id="brandingPreviewWatermark" class="text-muted">yoursite.com</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Branding Settings
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetBrandingDefaults()">
                                    <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="brandingConfigMessage"></div>
                            </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Service Settings Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="serviceHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#serviceCollapse" aria-expanded="false" aria-controls="serviceCollapse">
                                    <i class="bi bi-toggles2 me-2"></i> Service Settings
                                </button>
                            </h2>
                            <div id="serviceCollapse" class="accordion-collapse collapse" 
                                 aria-labelledby="serviceHeading" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                        <div class="card-body">
                            <p class="mb-3">Control which services are available to users.</p>
                            <form id="serviceSettingsForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="transcriptionEnabled" checked>
                                            <label class="form-check-label" for="transcriptionEnabled">
                                                <strong>Enable Transcription Service</strong>
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            When disabled, users will see disabled transcription and translation buttons.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="videoGenerationEnabled" checked>
                                            <label class="form-check-label" for="videoGenerationEnabled">
                                                <strong>Enable Video Generation Service</strong>
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            When disabled, users will see disabled video generation buttons.
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Service Settings
                                </button>
                                <div class="alert alert-info mt-3" style="display: none;" id="serviceSettingsMessage"></div>
                            </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stripe API Configuration Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="stripeHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#stripeCollapse" aria-expanded="false" aria-controls="stripeCollapse">
                                    <i class="bi bi-credit-card me-2"></i> Stripe Payment Configuration
                                </button>
                            </h2>
                            <div id="stripeCollapse" class="accordion-collapse collapse" 
                                 aria-labelledby="stripeHeading" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong> 
                                        Changing these keys will affect payment processing. Make sure to use the correct keys for your environment.
                                    </div>
                                    
                                    <!-- Mode Toggle -->
                                    <div class="mb-4">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="stripeMode" id="liveMode" value="live">
                                            <label class="btn btn-outline-danger" for="liveMode">
                                                <i class="bi bi-broadcast"></i> LIVE MODE
                                            </label>
                                            <input type="radio" class="btn-check" name="stripeMode" id="testMode" value="test" checked>
                                            <label class="btn btn-outline-warning" for="testMode">
                                                <i class="bi bi-bug"></i> TEST MODE
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            <strong>Warning:</strong> Live mode processes real payments. Test mode is safe for development.
                                        </div>
                                    </div>
                                    
                                    <form id="stripeConfigForm" autocomplete="off" data-1p-ignore data-lpignore="true">
                                        <div class="row">
                                            <!-- LIVE MODE Column -->
                                            <div class="col-md-6">
                                                <div class="card border-danger">
                                                    <div class="card-header bg-danger text-white">
                                                        <h6 class="mb-0">
                                                            <i class="bi bi-broadcast"></i> LIVE MODE
                                                            <span class="badge bg-light text-danger ms-2" id="liveStatus">Not Configured</span>
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <label for="livePublishableKey" class="form-label">
                                                                <i class="bi bi-eye"></i> Publishable Key
                                                            </label>
                                                            <div class="input-group">
                                                                <input type="text" class="form-control font-monospace" id="livePublishableKey" 
                                                                       placeholder="pk_live_..." autocomplete="off" 
                                                                       data-1p-ignore data-lpignore="true" data-form-type="other"
                                                                       spellcheck="false" readonly onfocus="this.removeAttribute('readonly')">
                                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility('livePublishableKey')">
                                                                    <i class="bi bi-eye-slash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="liveSecretKey" class="form-label">
                                                                <i class="bi bi-key"></i> Secret Key
                                                            </label>
                                                            <div class="input-group">
                                                                <input type="password" class="form-control font-monospace" id="liveSecretKey" 
                                                                       placeholder="sk_live_..." autocomplete="off"
                                                                       data-1p-ignore data-lpignore="true" data-form-type="other"
                                                                       spellcheck="false" readonly onfocus="this.removeAttribute('readonly')">
                                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility('liveSecretKey')">
                                                                    <i class="bi bi-eye-slash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="liveWebhookSecret" class="form-label">
                                                                <i class="bi bi-shield-lock"></i> Webhook Secret
                                                            </label>
                                                            <div class="input-group">
                                                                <input type="password" class="form-control font-monospace" id="liveWebhookSecret" 
                                                                       placeholder="whsec_..." autocomplete="off"
                                                                       data-1p-ignore data-lpignore="true" data-form-type="other"
                                                                       spellcheck="false" readonly onfocus="this.removeAttribute('readonly')">
                                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility('liveWebhookSecret')">
                                                                    <i class="bi bi-eye-slash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="alert alert-danger">
                                                            <i class="bi bi-exclamation-triangle"></i>
                                                            <strong>Live Mode:</strong> Real payment processing with actual charges
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- TEST MODE Column -->
                                            <div class="col-md-6">
                                                <div class="card border-warning">
                                                    <div class="card-header bg-warning text-dark">
                                                        <h6 class="mb-0">
                                                            <i class="bi bi-bug"></i> TEST MODE
                                                            <span class="badge bg-light text-warning ms-2" id="testStatus">Not Configured</span>
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <label for="testPublishableKey" class="form-label">
                                                                <i class="bi bi-eye"></i> Publishable Key
                                                            </label>
                                                            <div class="input-group">
                                                                <input type="text" class="form-control font-monospace" id="testPublishableKey" 
                                                                       placeholder="pk_test_..." autocomplete="off"
                                                                       data-1p-ignore data-lpignore="true" data-form-type="other"
                                                                       spellcheck="false" readonly onfocus="this.removeAttribute('readonly')">
                                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility('testPublishableKey')">
                                                                    <i class="bi bi-eye-slash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="testSecretKey" class="form-label">
                                                                <i class="bi bi-key"></i> Secret Key
                                                            </label>
                                                            <div class="input-group">
                                                                <input type="password" class="form-control font-monospace" id="testSecretKey" 
                                                                       placeholder="sk_test_..." autocomplete="off"
                                                                       data-1p-ignore data-lpignore="true" data-form-type="other"
                                                                       spellcheck="false" readonly onfocus="this.removeAttribute('readonly')">
                                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility('testSecretKey')">
                                                                    <i class="bi bi-eye-slash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-3">
                                                            <label for="testWebhookSecret" class="form-label">
                                                                <i class="bi bi-shield-lock"></i> Webhook Secret
                                                            </label>
                                                            <div class="input-group">
                                                                <input type="password" class="form-control font-monospace" id="testWebhookSecret" 
                                                                       placeholder="whsec_..." autocomplete="off"
                                                                       data-1p-ignore data-lpignore="true" data-form-type="other"
                                                                       spellcheck="false" readonly onfocus="this.removeAttribute('readonly')">
                                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleKeyVisibility('testWebhookSecret')">
                                                                    <i class="bi bi-eye-slash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="alert alert-warning">
                                                            <i class="bi bi-info-circle"></i>
                                                            <strong>Test Mode:</strong> Safe development with test card 4242 4242 4242 4242
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-save"></i> Save Stripe Configuration
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="loadStripeConfig()">
                                                <i class="bi bi-arrow-clockwise"></i> Reload Current
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <div class="alert alert-info mt-3" style="display: none;" id="stripeMessage"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Messages Section -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="messagesHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#messagesCollapse" aria-expanded="false" aria-controls="messagesCollapse">
                                    <i class="bi bi-megaphone me-2"></i> System Messages
                                </button>
                            </h2>
                            <div id="messagesCollapse" class="accordion-collapse collapse" 
                                 aria-labelledby="messagesHeading" data-bs-parent="#settingsAccordion">
                                <div class="accordion-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <input class="form-control form-control-sm search" placeholder="Search messages..." style="width: 300px;" />
                                        </div>
                                        <div>
                                            <button type="button" class="btn btn-secondary btn-sm me-2" onclick="loadAdminSystemMessages()">
                                                <i class="bi bi-arrow-clockwise"></i> Refresh
                                            </button>
                                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSystemMessageModal">
                                                <i class="bi bi-plus"></i> Add Message
                                            </button>
                                        </div>
                                    </div>
                        <div class="card-body">
                            <p class="mb-3">Manage system-wide messages that appear to all users.</p>
                            <div id="systemMessagesTable">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading system messages...</p>
                                </div>
                            </div>
                        </div>
                                </div>
                            </div>
                        </div>
                        
                    </div> <!-- End of settingsAccordion -->
                </div>
            </div>
        </div>
        
        <!-- Help Tab -->
        <div class="tab-pane fade" id="help" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-question-circle"></i> Administrator's Guide</h5>
                            <small>Comprehensive guide for managing XSpace Downloader</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-light" onclick="printGuide()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                            <a href="/admin/api/administrator-guide/download" class="btn btn-sm btn-outline-light" target="_blank">
                                <i class="bi bi-download"></i> Download
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="administrator-guide-content" style="height: 600px; overflow-y: auto;">
                        <div class="text-center p-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading guide...</span>
                            </div>
                            <p class="mt-3">Loading Administrator's Guide...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if is_localhost %}
        <!-- Development Tab -->
        <div class="tab-pane fade" id="development" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header bg-warning">
                    <h6 class="mb-0 text-dark">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>DANGER ZONE - Development Tools (Localhost Only)</strong>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger" role="alert">
                        <h5 class="alert-heading"><i class="bi bi-shield-exclamation"></i> Warning!</h5>
                        <p>These operations are <strong>IRREVERSIBLE</strong> and will permanently delete data. Only use in development environments.</p>
                        <hr>
                        <p class="mb-0">These tools are only available when running on localhost for safety.</p>
                    </div>
                    
                    <!-- Clear All Spaces Data -->
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-trash3"></i> Clear All Spaces Data
                            </h6>
                        </div>
                        <div class="card-body">
                            <p>This will permanently delete:</p>
                            <ul>
                                <li><strong>Database Tables:</strong> spaces, space_clips, space_download_history, space_download_scheduler, space_favs, space_metadata, space_notes, space_play_history, space_reviews, space_tags, space_transcripts</li>
                                <li><strong>Audio Files:</strong> downloads/*.mp3, downloads/*.m4a, downloads/*.wav</li>
                                <li><strong>Transcript Jobs:</strong> transcript_jobs/*.json</li>
                            </ul>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmClearSpaces">
                                    <label class="form-check-label" for="confirmClearSpaces">
                                        I understand this will permanently delete ALL spaces data and files
                                    </label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="clearAllSpacesData()" disabled id="clearSpacesBtn">
                                <i class="bi bi-trash3-fill"></i> Clear All Spaces Data
                            </button>
                            <div class="alert alert-info mt-3" style="display: none;" id="clearSpacesMessage"></div>
                        </div>
                    </div>
                    
                    <!-- Clear Non-Admin Users -->
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-people"></i> Clear Non-Admin Users
                            </h6>
                        </div>
                        <div class="card-body">
                            <p>This will permanently delete all users except those with <code>is_admin = 1</code>.</p>
                            <div class="alert alert-warning" role="alert">
                                <strong>Preserved:</strong> Admin users will be kept safe.
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmClearUsers">
                                    <label class="form-check-label" for="confirmClearUsers">
                                        I understand this will permanently delete all non-admin users
                                    </label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="clearNonAdminUsers()" disabled id="clearUsersBtn">
                                <i class="bi bi-people-fill"></i> Clear Non-Admin Users
                            </button>
                            <div class="alert alert-info mt-3" style="display: none;" id="clearUsersMessage"></div>
                        </div>
                    </div>
                    
                    <!-- System Info -->
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i> Development Environment Info
                            </h6>
                        </div>
                        <div class="card-body">
                            <p><strong>Environment:</strong> Localhost Development</p>
                            <p><strong>Host:</strong> {{ request.host }}</p>
                            <p class="mb-0"><strong>Note:</strong> These tools are automatically hidden in production environments.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">
                    <i class="bi bi-cloud-upload"></i> Upload Audio/Video File
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="hidden" id="uploadSpaceId" name="space_id">
                    
                    <div class="mb-3">
                        <label for="uploadFile" class="form-label">
                            <i class="bi bi-file-earmark-music"></i> Select Audio/Video File
                        </label>
                        <input type="file" class="form-control" id="uploadFile" name="file" 
                               accept=".mp3,.mp4,.wav,.m4a,.webm,.ogg" required>
                        <div class="form-text">
                            Supported formats: MP3, MP4, WAV, M4A, WebM, OGG (Max size: 2GB)
                        </div>
                    </div>
                    
                    <!-- File Preview -->
                    <div id="filePreview" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-info-circle"></i> File Details
                                </h6>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">File Name:</small>
                                        <div id="fileName" class="fw-bold"></div>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">Size:</small>
                                        <div id="fileSize" class="fw-bold"></div>
                                    </div>
                                    <div class="col-3">
                                        <small class="text-muted">Type:</small>
                                        <div id="fileType" class="fw-bold"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="mb-3" style="display: none;">
                        <label class="form-label">Upload Progress</label>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" id="uploadProgressBar" style="width: 0%">
                                0%
                            </div>
                        </div>
                        <small class="text-muted" id="uploadStatus">Preparing upload...</small>
                    </div>
                    
                    <!-- Upload Result -->
                    <div id="uploadResult" class="alert" style="display: none;">
                        <div id="uploadResultContent"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="uploadCancelBtn">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="uploadSubmitBtn" onclick="startUpload()">
                    <i class="bi bi-cloud-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Job Details Modal -->
<div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobDetailsModalLabel">
                    <i class="bi bi-info-circle"></i> Job Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="jobDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading job details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add System Message Modal -->
<div class="modal fade" id="addSystemMessageModal" tabindex="-1" aria-labelledby="addSystemMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSystemMessageModalLabel">
                    <i class="bi bi-megaphone"></i> Add System Message
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSystemMessageForm">
                    <div class="mb-3">
                        <label for="systemMessageText" class="form-label">Message</label>
                        <textarea class="form-control" id="systemMessageText" rows="3" required 
                                  placeholder="Enter your system message..."></textarea>
                        <div class="form-text">This message will be displayed to all users at the top of every page.</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="systemMessageStartDate" class="form-label">Start Date & Time</label>
                            <input type="datetime-local" class="form-control" id="systemMessageStartDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="systemMessageEndDate" class="form-label">End Date & Time</label>
                            <input type="datetime-local" class="form-control" id="systemMessageEndDate" required>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Users can dismiss messages by clicking "OK". Once dismissed, the message won't appear again for that user.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSystemMessage()">
                    <i class="bi bi-save"></i> Save Message
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let currentPeriod = 'daily';
let submissionsChart = null;
let currentUsersPage = 1;
let currentSpacesPage = 1;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadSpaces();
    loadStatistics('daily');
    
    // Add enter key support for search
    document.getElementById('userSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchUsers();
    });
    document.getElementById('spaceSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchSpaces();
    });
    
    // Check if settings tab is active on page load or via URL hash
    if (document.getElementById('settings-tab').classList.contains('active') || 
        window.location.hash === '#settings') {
        // If hash is #settings, activate the tab
        if (window.location.hash === '#settings') {
            const settingsTab = new bootstrap.Tab(document.getElementById('settings-tab'));
            settingsTab.show();
        }
        // Load settings content
        setTimeout(() => {
            loadTrackingConfig();
            loadTranscriptionConfig();
            loadBrandingConfig();
            loadAdminSystemMessages();
            loadServiceSettings();
            loadStripeConfig();
        }, 100);
    }
    
    // Check if templates tab should be active
    if (document.getElementById('templates-tab').classList.contains('active') || 
        window.location.hash === '#templates') {
        // If hash is #templates, activate the tab
        if (window.location.hash === '#templates') {
            const templatesTab = new bootstrap.Tab(document.getElementById('templates-tab'));
            templatesTab.show();
        }
        // Load templates content
        setTimeout(() => {
            loadTemplateList();
        }, 100);
    }
    
    // Load tracking config when settings tab is shown
    document.getElementById('settings-tab').addEventListener('shown.bs.tab', function() {
        loadTrackingConfig();
        loadTranscriptionConfig();
        loadBrandingConfig();
        loadAdminSystemMessages();
        loadServiceSettings();
        loadStripeConfig();
    });

    // Load template list when templates tab is shown
    document.getElementById('templates-tab').addEventListener('shown.bs.tab', function() {
        loadTemplateList();
    });
});

// User Management Functions
function loadUsers(page = 1) {
    currentUsersPage = page;
    const search = document.getElementById('userSearch').value;
    
    fetch(`/admin/api/users?page=${page}&search=${encodeURIComponent(search)}`)
        .then(response => response.json())
        .then(data => {
            displayUsers(data.users);
            displayPagination('usersPagination', data.page, data.pages, loadUsers);
        })
        .catch(error => {
            console.error('Error loading users:', error);
            document.getElementById('usersList').innerHTML = 
                '<tr><td colspan="9" class="text-danger text-center">Error loading users</td></tr>';
        });
}

function displayUsers(users) {
    const tbody = document.getElementById('usersList');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">No users found</td></tr>';
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.id}</td>
            <td>${user.email}</td>
            <td>
                <span class="badge bg-${user.status === 1 ? 'success' : 'secondary'}">
                    ${user.status === 1 ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <input type="checkbox" class="form-check-input" 
                       ${user.is_admin ? 'checked' : ''} 
                       onchange="updateUser(${user.id}, 'is_admin', this.checked)">
            </td>
            <td>
                <div class="input-group input-group-sm" style="width: 100px;">
                    <input type="number" class="form-control" 
                           value="${Math.round(user.credits || 0)}" 
                           step="1" min="0"
                           onblur="updateUserCredits(${user.id}, this.value)"
                           onkeypress="if(event.key === 'Enter') updateUserCredits(${user.id}, this.value)">
                </div>
            </td>
            <td>${user.country || '-'}</td>
            <td>${user.login_count || 0}</td>
            <td>${user.space_count || 0}</td>
            <td>${user.last_logged_in ? new Date(user.last_logged_in).toLocaleString() : 'Never'}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-warning" onclick="toggleUserStatus(${user.id}, ${user.status})">
                        ${user.status === 1 ? 'Suspend' : 'Activate'}
                    </button>
                    <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.email}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function searchUsers() {
    loadUsers(1);
}

function updateUser(userId, field, value) {
    fetch(`/admin/api/users/${userId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({[field]: value})
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Error updating user');
            loadUsers(currentUsersPage);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating user');
        loadUsers(currentUsersPage);
    });
}

function toggleUserStatus(userId, currentStatus) {
    const newStatus = currentStatus === 1 ? 0 : 1;
    updateUser(userId, 'status', newStatus);
    loadUsers(currentUsersPage);
}

function deleteUser(userId, email) {
    if (!confirm(`Are you sure you want to delete user: ${email}?`)) return;
    
    fetch(`/admin/api/users/${userId}`, {method: 'DELETE'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUsers(currentUsersPage);
            } else {
                alert(data.error || 'Error deleting user');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
}

// Space Management Functions
function loadSpaces(page = 1) {
    currentSpacesPage = page;
    const search = document.getElementById('spaceSearch').value;
    
    fetch(`/admin/api/spaces?page=${page}&search=${encodeURIComponent(search)}`)
        .then(response => response.json())
        .then(data => {
            displaySpaces(data.spaces);
            displayPagination('spacesPagination', data.page, data.pages, loadSpaces);
        })
        .catch(error => {
            console.error('Error loading spaces:', error);
            document.getElementById('spacesList').innerHTML = 
                '<tr><td colspan="7" class="text-danger text-center">Error loading spaces</td></tr>';
        });
}

function displaySpaces(spaces) {
    const tbody = document.getElementById('spacesList');
    
    if (spaces.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No spaces found</td></tr>';
        return;
    }
    
    tbody.innerHTML = spaces.map(space => `
        <tr>
            <td>
                <a href="/spaces/${space.space_id}" target="_blank" class="text-decoration-none">
                    ${space.title || 'Untitled Space'}
                </a>
                <br>
                <small class="text-muted">${space.space_id}</small>
            </td>
            <td>
                ${space.host_handle ? `
                    <img src="https://unavatar.io/twitter/${space.host_handle.replace('@', '')}" 
                         alt="${space.host_handle}" 
                         class="rounded-circle" 
                         style="width: 32px; height: 32px;"
                         onerror="this.style.display='none'">
                ` : '-'}
            </td>
            <td>
                ${space.user_email ? `
                    <img src="https://unavatar.io/${space.user_email}" 
                         alt="${space.user_email}" 
                         class="rounded-circle" 
                         style="width: 32px; height: 32px;"
                         onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(space.user_email.split('@')[0])}&background=random'">
                ` : 'Anonymous'}
            </td>
            <td>${space.download_cnt || 0}</td>
            <td>${space.playback_cnt || 0}</td>
            <td>${new Date(space.created_at).toLocaleDateString()}</td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary btn-sm" onclick="redoTags('${space.space_id}')" title="Regenerate tags from transcript">
                        Redo <i class="bi bi-tags"></i>
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="reTranscribe('${space.space_id}')" title="Re-transcribe with base model">
                        <i class="bi bi-mic"></i> Base
                    </button>
                    <button class="btn btn-success btn-sm" onclick="showUploadModal('${space.space_id}')" title="Upload new audio/video file">
                        <i class="bi bi-cloud-upload"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSpace('${space.space_id}')" title="Delete space">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function searchSpaces() {
    loadSpaces(1);
}

function deleteSpace(spaceId) {
    if (!confirm('Are you sure you want to delete this space? This action cannot be undone.')) return;
    
    fetch(`/admin/api/spaces/${spaceId}`, {method: 'DELETE'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSpaces(currentSpacesPage);
            } else {
                alert(data.error || 'Error deleting space');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting space');
        });
}

function redoTags(spaceId) {
    if (!confirm('Regenerate tags for this space using its transcript? This will replace all existing tags.')) return;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Generating...';
    button.disabled = true;
    
    fetch(`/admin/api/spaces/${spaceId}/redo-tags`, {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message with tags
                const tagsText = data.tags.length > 0 ? 
                    `\n\nGenerated tags: ${data.tags.join(', ')}` : 
                    '\n\nNo tags generated.';
                alert(`${data.message} for "${data.space_title}"${tagsText}`);
                // Reload the spaces list to show updated data
                loadSpaces(currentSpacesPage);
            } else {
                alert(data.error || 'Error regenerating tags');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error regenerating tags');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
}

function reTranscribe(spaceId) {
    if (!confirm('Re-transcribe this space with the base model? This will overwrite the existing transcript.')) return;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Transcribing...';
    button.disabled = true;
    
    fetch(`/admin/api/spaces/${spaceId}/re-transcribe`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model: 'base',
            overwrite: true
        })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.message} for space ${spaceId}`);
            } else {
                alert(data.error || 'Error starting re-transcription');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting re-transcription');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalHtml;
            button.disabled = false;
        });
}

// Upload Functions
let uploadAbortController = null;

function showUploadModal(spaceId) {
    document.getElementById('uploadSpaceId').value = spaceId;
    
    // Reset modal state
    resetUploadModal();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
    modal.show();
}

function resetUploadModal() {
    // Clear file input
    document.getElementById('uploadFile').value = '';
    
    // Hide all dynamic sections
    document.getElementById('filePreview').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadResult').style.display = 'none';
    
    // Reset progress bar
    const progressBar = document.getElementById('uploadProgressBar');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
    
    // Reset buttons
    document.getElementById('uploadSubmitBtn').style.display = 'inline-block';
    document.getElementById('uploadCancelBtn').textContent = 'Cancel';
    document.getElementById('uploadCancelBtn').innerHTML = '<i class="bi bi-x-circle"></i> Cancel';
    
    // Clear any existing abort controller
    if (uploadAbortController) {
        uploadAbortController.abort();
        uploadAbortController = null;
    }
}

// File selection handler
document.getElementById('uploadFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        showFilePreview(file);
    } else {
        document.getElementById('filePreview').style.display = 'none';
    }
});

function showFilePreview(file) {
    const preview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileType = document.getElementById('fileType');
    
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileType.textContent = file.type || 'Unknown';
    
    preview.style.display = 'block';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function validateFile(file) {
    const maxSize = 2 * 1024 * 1024 * 1024; // 2GB
    const allowedTypes = ['audio/mpeg', 'audio/mp4', 'audio/wav', 'audio/x-wav', 'audio/webm', 'audio/ogg', 
                         'video/mp4', 'video/webm', 'video/quicktime', 'video/x-msvideo'];
    const allowedExtensions = ['.mp3', '.mp4', '.wav', '.m4a', '.webm', '.ogg', '.avi', '.mov'];
    
    // Check file size
    if (file.size > maxSize) {
        return 'File size too large. Maximum allowed size is 2GB.';
    }
    
    // Check file extension
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    if (!allowedExtensions.includes(fileExtension)) {
        return 'Invalid file type. Supported formats: MP3, MP4, WAV, M4A, WebM, OGG.';
    }
    
    return null; // No error
}

function startUpload() {
    const fileInput = document.getElementById('uploadFile');
    const spaceId = document.getElementById('uploadSpaceId').value;
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file to upload.');
        return;
    }
    
    // Validate file
    const validationError = validateFile(file);
    if (validationError) {
        showUploadResult(false, validationError);
        return;
    }
    
    // Show progress section
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadResult').style.display = 'none';
    
    // Disable upload button and change cancel button
    document.getElementById('uploadSubmitBtn').style.display = 'none';
    document.getElementById('uploadCancelBtn').innerHTML = '<i class="bi bi-x-circle"></i> Abort Upload';
    
    // Create FormData
    const formData = new FormData();
    formData.append('file', file);
    formData.append('space_id', spaceId);
    
    // Create abort controller
    uploadAbortController = new AbortController();
    
    // Create XMLHttpRequest for progress tracking
    const xhr = new XMLHttpRequest();
    
    // Track upload progress
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            updateUploadProgress(percentComplete, 'Uploading...');
        }
    });
    
    // Handle successful response
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    showUploadResult(true, response.message || 'File uploaded successfully!');
                    // Refresh spaces table after successful upload
                    setTimeout(() => {
                        loadSpaces(currentSpacesPage);
                    }, 1500);
                } else {
                    showUploadResult(false, response.error || 'Upload failed');
                }
            } catch (e) {
                showUploadResult(false, 'Invalid server response');
            }
        } else {
            showUploadResult(false, `Upload failed with status: ${xhr.status}`);
        }
    });
    
    // Handle errors
    xhr.addEventListener('error', function() {
        showUploadResult(false, 'Upload failed due to network error');
    });
    
    // Handle abort
    xhr.addEventListener('abort', function() {
        showUploadResult(false, 'Upload was cancelled');
    });
    
    // Setup abort controller
    uploadAbortController.signal.addEventListener('abort', function() {
        xhr.abort();
    });
    
    // Start upload
    xhr.open('POST', '/admin/api/spaces/upload');
    xhr.send(formData);
    
    updateUploadProgress(0, 'Starting upload...');
}

function updateUploadProgress(percent, status) {
    const progressBar = document.getElementById('uploadProgressBar');
    const statusText = document.getElementById('uploadStatus');
    
    progressBar.style.width = percent + '%';
    progressBar.textContent = Math.round(percent) + '%';
    statusText.textContent = status;
    
    if (percent >= 100) {
        progressBar.className = 'progress-bar bg-success';
        statusText.textContent = 'Processing upload...';
    }
}

function showUploadResult(success, message) {
    const resultDiv = document.getElementById('uploadResult');
    const resultContent = document.getElementById('uploadResultContent');
    
    resultDiv.className = success ? 'alert alert-success' : 'alert alert-danger';
    resultContent.innerHTML = `<i class="bi bi-${success ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
    resultDiv.style.display = 'block';
    
    // Hide progress section
    document.getElementById('uploadProgress').style.display = 'none';
    
    // Reset buttons
    document.getElementById('uploadSubmitBtn').style.display = 'inline-block';
    document.getElementById('uploadCancelBtn').innerHTML = '<i class="bi bi-x-circle"></i> Close';
    
    // Clear abort controller
    uploadAbortController = null;
}

// Handle cancel/abort button
document.getElementById('uploadCancelBtn').addEventListener('click', function() {
    if (uploadAbortController) {
        // Currently uploading, abort it
        uploadAbortController.abort();
    }
});

// Statistics Functions
function changePeriod(period) {
    currentPeriod = period;
    
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    loadStatistics(period);
}

function loadStatistics(period) {
    // Load all statistics
    loadSubmissionsChart(period);
    loadPopularSpaces(period);
    loadDownloadedSpaces(period);
    loadActiveUsers(period);
}

function loadSubmissionsChart(period) {
    fetch(`/admin/api/stats/submissions?period=${period}`)
        .then(response => response.json())
        .then(result => {
            const ctx = document.getElementById('submissionsChart').getContext('2d');
            
            if (submissionsChart) {
                submissionsChart.destroy();
            }
            
            submissionsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: result.data.map(d => new Date(d.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Space Submissions',
                        data: result.data.map(d => d.count),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading submissions chart:', error));
}

function loadPopularSpaces(period) {
    fetch(`/admin/api/stats/plays?period=${period}`)
        .then(response => response.json())
        .then(result => {
            const list = document.getElementById('popularSpacesList');
            
            if (result.data.length === 0) {
                list.innerHTML = '<div class="text-center text-muted">No data available</div>';
                return;
            }
            
            list.innerHTML = result.data.slice(0, 10).map((space, index) => `
                <a href="/spaces/${space.space_id}" target="_blank" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>#${index + 1}</strong> ${space.title || 'Untitled'}
                            <small class="text-muted d-block">${space.host || 'Unknown host'}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${space.playback_cnt} plays</span>
                    </div>
                </a>
            `).join('');
        })
        .catch(error => console.error('Error loading popular spaces:', error));
}

function loadDownloadedSpaces(period) {
    fetch(`/admin/api/stats/downloads?period=${period}`)
        .then(response => response.json())
        .then(result => {
            const list = document.getElementById('downloadedSpacesList');
            
            if (result.data.length === 0) {
                list.innerHTML = '<div class="text-center text-muted">No data available</div>';
                return;
            }
            
            list.innerHTML = result.data.slice(0, 10).map((space, index) => `
                <a href="/spaces/${space.space_id}" target="_blank" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>#${index + 1}</strong> ${space.title || 'Untitled'}
                            <small class="text-muted d-block">${space.host || 'Unknown host'}</small>
                        </div>
                        <span class="badge bg-info rounded-pill">${space.download_cnt} downloads</span>
                    </div>
                </a>
            `).join('');
        })
        .catch(error => console.error('Error loading downloaded spaces:', error));
}

function loadActiveUsers(period) {
    fetch(`/admin/api/stats/active_users?period=${period}`)
        .then(response => response.json())
        .then(result => {
            const tbody = document.getElementById('activeUsersList');
            
            if (result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = result.data.map(user => `
                <tr>
                    <td>${user.email}</td>
                    <td>${user.country || '-'}</td>
                    <td>${user.login_count || 0}</td>
                    <td>${user.space_count || 0}</td>
                    <td>${user.total_downloads || 0}</td>
                    <td>${user.total_plays || 0}</td>
                </tr>
            `).join('');
        })
        .catch(error => console.error('Error loading active users:', error));
}

// Pagination Helper
function displayPagination(elementId, currentPage, totalPages, loadFunction) {
    const pagination = document.getElementById(elementId);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage > 1 ? `${loadFunction.name}(${currentPage - 1})` : ''}">Previous</a>
    </li>`;
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="event.preventDefault(); ${loadFunction.name}(${i})">${i}</a>
        </li>`;
    }
    
    // Next button
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="event.preventDefault(); ${currentPage < totalPages ? `${loadFunction.name}(${currentPage + 1})` : ''}">Next</a>
    </li>`;
    
    pagination.innerHTML = html;
}

// Rate Limit Settings
document.getElementById('rateLimitForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageDiv = document.getElementById('rateLimitMessage');
    messageDiv.style.display = 'none';
    
    const data = {
        daily_limit: parseInt(document.getElementById('dailyLimit').value),
        hourly_limit: parseInt(document.getElementById('hourlyLimit').value),
        enabled: document.getElementById('rateLimitEnabled').checked
    };
    
    try {
        const response = await fetch('/admin/api/update_rate_limits', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message;
            messageDiv.style.display = 'block';
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to update settings');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    }
});

// Load tracking configuration on page load
async function loadTrackingConfig() {
    try {
        const response = await fetch('/admin/api/tracking_config');
        const result = await response.json();
        
        if (result.success && result.config) {
            // Set form values
            document.getElementById('playCooldownMinutes').value = result.config.play_cooldown_minutes || 30;
            document.getElementById('playMinDuration').value = result.config.play_minimum_duration_seconds || 30;
            document.getElementById('downloadDailyLimit').value = result.config.download_daily_limit || 1;
            document.getElementById('downloadHourlyIpLimit').value = result.config.download_hourly_ip_limit || 10;
            document.getElementById('playTrackingEnabled').checked = result.config.play_tracking_enabled !== 'false';
            document.getElementById('downloadTrackingEnabled').checked = result.config.download_tracking_enabled !== 'false';
        }
    } catch (error) {
        console.error('Error loading tracking config:', error);
    }
}

// Save tracking configuration
document.getElementById('trackingConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageDiv = document.getElementById('trackingConfigMessage');
    messageDiv.style.display = 'none';
    
    const data = {
        play_cooldown_minutes: document.getElementById('playCooldownMinutes').value,
        play_minimum_duration_seconds: document.getElementById('playMinDuration').value,
        download_daily_limit: document.getElementById('downloadDailyLimit').value,
        download_hourly_ip_limit: document.getElementById('downloadHourlyIpLimit').value,
        play_tracking_enabled: document.getElementById('playTrackingEnabled').checked ? 'true' : 'false',
        download_tracking_enabled: document.getElementById('downloadTrackingEnabled').checked ? 'true' : 'false'
    };
    
    try {
        const response = await fetch('/admin/api/update_tracking_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message || 'Tracking configuration updated successfully';
            messageDiv.style.display = 'block';
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to update configuration');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    }
});


// Transcription Configuration
document.querySelectorAll('input[name="transcriptionProvider"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const openaiSettings = document.getElementById('openaiApiSettings');
        const localSettings = document.getElementById('localWhisperSettings');
        
        if (this.value === 'openai') {
            openaiSettings.style.display = 'block';
            localSettings.style.display = 'none';
        } else {
            openaiSettings.style.display = 'none';
            localSettings.style.display = 'block';
        }
    });
});

async function loadTranscriptionConfig() {
    try {
        const response = await fetch('/admin/api/transcription_config');
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.config) {
                // Set provider
                const provider = result.config.provider || 'local';
                document.getElementById(provider === 'openai' ? 'openaiApi' : 'localWhisper').checked = true;
                
                // Trigger change event to show/hide sections
                document.querySelector(`input[value="${provider}"]`).dispatchEvent(new Event('change'));
                
                // Set OpenAI settings
                const apiKeyInput = document.getElementById('openaiApiKey');
                const apiKeyStatus = document.getElementById('apiKeyStatus');
                const keySource = result.config.openai_key_source || 'none';
                
                if (keySource === 'environment') {
                    apiKeyInput.value = '***from_env***';
                    apiKeyInput.placeholder = 'Using API key from environment variables';
                    apiKeyInput.title = 'OpenAI API key is set in environment variables (.env file)';
                    apiKeyStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> API key configured in environment variables (.env file).';
                } else if (keySource === 'config') {
                    apiKeyInput.value = '***hidden***';
                    apiKeyInput.placeholder = 'Using API key from configuration';
                    apiKeyInput.title = 'OpenAI API key is set in configuration file';
                    apiKeyStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> API key configured in settings file.';
                } else {
                    apiKeyInput.value = '';
                    apiKeyInput.placeholder = 'sk-...';
                    apiKeyInput.title = 'Enter your OpenAI API key';
                    apiKeyStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> No API key configured. Enter one to use OpenAI transcription.';
                }
                
                document.getElementById('openaiModel').value = result.config.openai_model || 'gpt-4o-mini-transcribe';
                
                // Set local Whisper settings
                document.getElementById('defaultWhisperModel').value = result.config.default_model || 'tiny';
                document.getElementById('whisperDevice').value = result.config.device || 'auto';
                
                // Set corrective filter settings
                document.getElementById('enableCorrectiveFilter').checked = result.config.enable_corrective_filter !== false;
                document.getElementById('correctionModel').value = result.config.correction_model || 'gpt-4o-mini';
            }
        }
    } catch (error) {
        console.error('Error loading transcription config:', error);
    }
}

document.getElementById('transcriptionConfigForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageDiv = document.getElementById('transcriptionConfigMessage');
    messageDiv.style.display = 'none';
    
    const provider = document.querySelector('input[name="transcriptionProvider"]:checked').value;
    
    const data = {
        provider: provider,
        openai_api_key: document.getElementById('openaiApiKey').value,
        openai_model: document.getElementById('openaiModel').value,
        default_model: document.getElementById('defaultWhisperModel').value,
        device: document.getElementById('whisperDevice').value,
        enable_corrective_filter: document.getElementById('enableCorrectiveFilter').checked,
        correction_model: document.getElementById('correctionModel').value
    };
    
    try {
        const response = await fetch('/admin/api/transcription_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message || 'Transcription configuration updated successfully';
            messageDiv.style.display = 'block';
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to update configuration');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    }
});

// Old logs JavaScript removed - now using dynamic template loading

// System Monitoring Variables
let systemMonitoringActive = false;
let systemMonitoringInterval = null;

// System Monitoring Functions
async function loadSystemStats() {
    try {
        const response = await fetch('/admin/api/system_stats');
        const result = await response.json();
        
        if (result.success) {
            updateSystemDisplay(result.stats);
            document.getElementById('systemStatus').textContent = 'Live';
            document.getElementById('systemStatus').className = 'badge bg-success ms-2';
        } else {
            console.error('Error loading system stats:', result.error);
            document.getElementById('systemStatus').textContent = 'Error';
            document.getElementById('systemStatus').className = 'badge bg-danger ms-2';
        }
    } catch (error) {
        console.error('Error loading system stats:', error);
        document.getElementById('systemStatus').textContent = 'Offline';
        document.getElementById('systemStatus').className = 'badge bg-secondary ms-2';
    }
}

function updateSystemDisplay(stats) {
    // Update CPU
    const cpuProgress = document.getElementById('cpuProgress');
    const cpuDetails = document.getElementById('cpuDetails');
    cpuProgress.style.width = `${stats.cpu.usage_percent}%`;
    cpuProgress.textContent = `${stats.cpu.usage_percent}%`;
    cpuProgress.className = `progress-bar ${getProgressBarColor(stats.cpu.usage_percent)}`;
    cpuDetails.textContent = stats.cpu.details;
    
    // Update Memory
    const memoryProgress = document.getElementById('memoryProgress');
    const memoryDetails = document.getElementById('memoryDetails');
    memoryProgress.style.width = `${stats.memory.usage_percent}%`;
    memoryProgress.textContent = `${stats.memory.usage_percent}%`;
    memoryProgress.className = `progress-bar ${getProgressBarColor(stats.memory.usage_percent)}`;
    memoryDetails.textContent = stats.memory.details;
    
    // Update Disk
    const diskProgress = document.getElementById('diskProgress');
    const diskDetails = document.getElementById('diskDetails');
    diskProgress.style.width = `${stats.disk.usage_percent}%`;
    diskProgress.textContent = `${stats.disk.usage_percent}%`;
    diskProgress.className = `progress-bar ${getProgressBarColor(stats.disk.usage_percent)}`;
    diskDetails.textContent = stats.disk.details;
    
    // Update GPU
    const gpuProgress = document.getElementById('gpuProgress');
    const gpuDetails = document.getElementById('gpuDetails');
    
    if (stats.gpu.available !== false) {
        const gpuUsage = stats.gpu.usage_percent || 0;
        gpuProgress.style.width = `${gpuUsage}%`;
        gpuProgress.textContent = `${gpuUsage}%`;
        gpuProgress.className = `progress-bar ${getProgressBarColor(gpuUsage)}`;
        gpuDetails.textContent = stats.gpu.details;
    } else {
        gpuProgress.style.width = '0%';
        gpuProgress.textContent = 'N/A';
        gpuProgress.className = 'progress-bar bg-secondary';
        gpuDetails.textContent = stats.gpu.details;
    }
}

function getProgressBarColor(percentage) {
    if (percentage < 50) return 'bg-success';
    if (percentage < 75) return 'bg-warning';
    return 'bg-danger';
}

function startSystemMonitoring() {
    if (!systemMonitoringActive) {
        systemMonitoringActive = true;
        // Load immediately
        loadSystemStats();
        // Set up 30-second interval
        systemMonitoringInterval = setInterval(loadSystemStats, 30000);
    }
}

function stopSystemMonitoring() {
    if (systemMonitoringActive) {
        systemMonitoringActive = false;
        clearInterval(systemMonitoringInterval);
        document.getElementById('systemStatus').textContent = 'Stopped';
        document.getElementById('systemStatus').className = 'badge bg-secondary ms-2';
    }
}

// Start system monitoring when the page loads
document.addEventListener('DOMContentLoaded', function() {
    startSystemMonitoring();
});

// Stop monitoring when the page is about to unload
window.addEventListener('beforeunload', function() {
    stopSystemMonitoring();
});

// Development Tab Functions (only available on localhost)
function enableClearSpacesButton() {
    const checkbox = document.getElementById('confirmClearSpaces');
    const button = document.getElementById('clearSpacesBtn');
    button.disabled = !checkbox.checked;
}

function enableClearUsersButton() {
    const checkbox = document.getElementById('confirmClearUsers');
    const button = document.getElementById('clearUsersBtn');
    button.disabled = !checkbox.checked;
}

async function clearAllSpacesData() {
    const confirmed = confirm(
        " FINAL WARNING \n\n" +
        "This will PERMANENTLY DELETE:\n" +
        " ALL spaces from database\n" +
        " ALL audio files (downloads/)\n" +
        " ALL transcript jobs\n\n" +
        "This action CANNOT be undone!\n\n" +
        "Type 'DELETE ALL SPACES' in the next dialog to proceed."
    );
    
    if (!confirmed) return;
    
    const confirmText = prompt("Type 'DELETE ALL SPACES' to confirm:");
    if (confirmText !== 'DELETE ALL SPACES') {
        alert("Confirmation text did not match. Operation cancelled.");
        return;
    }
    
    const messageDiv = document.getElementById('clearSpacesMessage');
    const button = document.getElementById('clearSpacesBtn');
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Clearing...';
        
        const response = await fetch('/admin/api/dev/clear_spaces_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ confirm: 'DELETE ALL SPACES' })
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message;
            messageDiv.style.display = 'block';
            
            // Uncheck the confirmation
            document.getElementById('confirmClearSpaces').checked = false;
            
            // Refresh the page after a delay
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to clear spaces data');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash3-fill"></i> Clear All Spaces Data';
    }
}

async function clearNonAdminUsers() {
    const confirmed = confirm(
        " FINAL WARNING \n\n" +
        "This will PERMANENTLY DELETE all users except admins!\n\n" +
        "Admin users (is_admin = 1) will be preserved.\n\n" +
        "This action CANNOT be undone!\n\n" +
        "Type 'DELETE NON ADMIN USERS' in the next dialog to proceed."
    );
    
    if (!confirmed) return;
    
    const confirmText = prompt("Type 'DELETE NON ADMIN USERS' to confirm:");
    if (confirmText !== 'DELETE NON ADMIN USERS') {
        alert("Confirmation text did not match. Operation cancelled.");
        return;
    }
    
    const messageDiv = document.getElementById('clearUsersMessage');
    const button = document.getElementById('clearUsersBtn');
    
    try {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Clearing...';
        
        const response = await fetch('/admin/api/dev/clear_non_admin_users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ confirm: 'DELETE NON ADMIN USERS' })
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message;
            messageDiv.style.display = 'block';
            
            // Uncheck the confirmation
            document.getElementById('confirmClearUsers').checked = false;
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to clear users');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-people-fill"></i> Clear Non-Admin Users';
    }
}

// Add event listeners for development checkboxes when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Only add listeners if development tab exists (localhost only)
    const spacesCheckbox = document.getElementById('confirmClearSpaces');
    const usersCheckbox = document.getElementById('confirmClearUsers');
    
    if (spacesCheckbox) {
        spacesCheckbox.addEventListener('change', enableClearSpacesButton);
    }
    
    if (usersCheckbox) {
        usersCheckbox.addEventListener('change', enableClearUsersButton);
    }
    
    // Initialize branding configuration
    initializeBrandingConfig();
});

// Branding Configuration Functions
function initializeBrandingConfig() {
    // Set up color picker sync
    const colorPicker = document.getElementById('brandingColor');
    const colorHex = document.getElementById('brandingColorHex');
    const backgroundColorPicker = document.getElementById('brandingBackgroundColor');
    const backgroundColorHex = document.getElementById('brandingBackgroundColorHex');
    
    if (colorPicker && colorHex) {
        colorPicker.addEventListener('input', function() {
            colorHex.value = this.value;
            updateBrandingPreview();
        });
        
        colorHex.addEventListener('input', function() {
            if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                colorPicker.value = this.value;
                updateBrandingPreview();
            }
        });
    }
    
    // Sync background color picker with hex input
    if (backgroundColorPicker && backgroundColorHex) {
        backgroundColorPicker.addEventListener('input', function() {
            backgroundColorHex.value = this.value;
            updateBrandingPreview();
        });
        
        backgroundColorHex.addEventListener('input', function() {
            if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                backgroundColorPicker.value = this.value;
                updateBrandingPreview();
            }
        });
    }
    
    // Set up real-time preview updates
    const previewElements = [
        'brandingTitle', 'brandingWatermark', 'brandingLogo', 
        'brandingFont', 'brandingEnabled'
    ];
    
    previewElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateBrandingPreview);
            element.addEventListener('change', updateBrandingPreview);
        }
    });
    
    // Set up form submit handler
    const brandingForm = document.getElementById('brandingConfigForm');
    if (brandingForm) {
        brandingForm.addEventListener('submit', handleBrandingFormSubmit);
    }
    
    // Initial preview update
    updateBrandingPreview();
}

function updateBrandingPreview() {
    const enabled = document.getElementById('brandingEnabled')?.checked ?? true;
    const title = document.getElementById('brandingTitle')?.value || 'Your Brand Name';
    const watermark = document.getElementById('brandingWatermark')?.value || 'yoursite.com';
    const color = document.getElementById('brandingColor')?.value || '#007bff';
    const backgroundColor = document.getElementById('brandingBackgroundColor')?.value || '#ffffff';
    const logo = document.getElementById('brandingLogo')?.value;
    const font = document.getElementById('brandingFont')?.value || 'Arial';
    
    // Update preview elements
    const previewTitle = document.getElementById('brandingPreviewTitle');
    const previewWatermark = document.getElementById('brandingPreviewWatermark');
    const previewProgress = document.getElementById('brandingPreviewProgress');
    const previewLogo = document.getElementById('brandingPreviewLogo');
    const previewLogoImg = document.getElementById('brandingPreviewLogoImg');
    const previewCard = document.querySelector('#brandingPreviewCard');
    
    if (!enabled) {
        // Show disabled state
        if (previewTitle) {
            previewTitle.textContent = 'Sample Space Title (Branding Disabled)';
            previewTitle.style.color = '#6c757d';
            previewTitle.style.fontFamily = 'Arial';
        }
        if (previewWatermark) {
            previewWatermark.textContent = '';
        }
        if (previewProgress) {
            previewProgress.style.background = '#6c757d';
        }
        if (previewLogo) {
            previewLogo.style.display = 'none';
        }
        if (previewCard) {
            previewCard.style.setProperty('background-color', '#f8f9fa', 'important');
        }
        return;
    }
    
    // Update title
    if (previewTitle) {
        previewTitle.textContent = `${title} - Sample Space Title`;
        previewTitle.style.color = color;
        previewTitle.style.fontFamily = font;
    }
    
    // Update background color
    if (previewCard) {
        previewCard.style.setProperty('background-color', backgroundColor, 'important');
    }
    
    // Update watermark
    if (previewWatermark) {
        previewWatermark.textContent = watermark;
    }
    
    // Update progress bar color
    if (previewProgress) {
        previewProgress.style.background = color;
    }
    
    // Update logo
    if (previewLogo && previewLogoImg) {
        if (logo && logo.trim()) {
            previewLogoImg.src = logo;
            previewLogo.style.display = 'block';
            
            // Handle logo load error
            previewLogoImg.onerror = function() {
                previewLogo.style.display = 'none';
            };
        } else {
            previewLogo.style.display = 'none';
        }
    }
}

// Load branding configuration from server
async function loadBrandingConfig() {
    console.log('Loading branding configuration...');
    try {
        const response = await fetch('/admin/api/branding_config');
        const result = await response.json();
        console.log('Branding config response:', result);
        
        if (result.success && result.config) {
            // Set form values
            document.getElementById('brandingTitle').value = result.config.video_title_branding || '';
            document.getElementById('brandingWatermark').value = result.config.video_watermark_text || '';
            document.getElementById('brandingColor').value = result.config.brand_color || '#007bff';
            document.getElementById('brandingColorHex').value = result.config.brand_color || '#007bff';
            document.getElementById('brandingBackgroundColor').value = result.config.background_color || '#ffffff';
            document.getElementById('brandingBackgroundColorHex').value = result.config.background_color || '#ffffff';
            document.getElementById('brandingFont').value = result.config.font_family || 'Arial';
            document.getElementById('brandingLogo').value = result.config.brand_logo_url || '';
            document.getElementById('brandingEnabled').checked = result.config.branding_enabled !== false;
            
            // Update preview
            updateBrandingPreview();
        }
    } catch (error) {
        console.error('Error loading branding config:', error);
    }
}

// Save branding configuration
async function handleBrandingFormSubmit(e) {
    e.preventDefault();
    console.log('Saving branding configuration...');
    
    const messageDiv = document.getElementById('brandingConfigMessage');
    messageDiv.style.display = 'none';
    
    const data = {
        video_title_branding: document.getElementById('brandingTitle').value,
        video_watermark_text: document.getElementById('brandingWatermark').value,
        brand_color: document.getElementById('brandingColor').value,
        background_color: document.getElementById('brandingBackgroundColor').value,
        font_family: document.getElementById('brandingFont').value,
        brand_logo_url: document.getElementById('brandingLogo').value,
        branding_enabled: document.getElementById('brandingEnabled').checked
    };
    
    console.log('Branding data to save:', data);
    
    try {
        const response = await fetch('/admin/api/branding_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.textContent = result.message || 'Branding configuration updated successfully';
            messageDiv.style.display = 'block';
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.textContent = 'Error: ' + (result.error || 'Failed to update branding configuration');
            messageDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Error saving branding config:', error);
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.textContent = 'Error: ' + error.message;
        messageDiv.style.display = 'block';
    }
}

// Reset branding to defaults
function resetBrandingDefaults() {
    if (!confirm('Reset all branding settings to default values?')) return;
    
    document.getElementById('brandingTitle').value = '';
    document.getElementById('brandingWatermark').value = '';
    document.getElementById('brandingColor').value = '#007bff';
    document.getElementById('brandingColorHex').value = '#007bff';
    document.getElementById('brandingBackgroundColor').value = '#ffffff';
    document.getElementById('brandingBackgroundColorHex').value = '#ffffff';
    document.getElementById('brandingFont').value = 'Arial';
    document.getElementById('brandingLogo').value = '';
    document.getElementById('brandingEnabled').checked = true;
    
    updateBrandingPreview();
}

// Queue Management Functions
let allQueueData = {
    download: { pending: [], in_progress: [], completed: [], failed: [], priorities: {} },
    transcription: { pending: [], processing: [], completed: [], failed: [] },
    translation: { pending: [], processing: [], completed: [] },
    video: { pending: [], processing: [], completed: [] }
};

function refreshAllQueues() {
    loadDownloadQueue();
    loadTranscriptionQueue();
    loadTranslationQueue();
    loadVideoQueue();
}

function refreshQueue() {
    // Backward compatibility
    refreshAllQueues();
}

function loadDownloadQueue() {
    fetch('/admin/api/queue/download')
        .then(response => response.json())
        .then(data => {
            allQueueData.download = data;
            displayDownloadQueue();
            updateQueueBadges();
        })
        .catch(error => {
            console.error('Error loading download queue:', error);
            showQueueError('downloadPendingList', 'Error loading download queue');
            showQueueError('downloadProgressList', 'Error loading download queue');
        });
}

function loadTranscriptionQueue() {
    fetch('/admin/api/queue/transcription')
        .then(response => response.json())
        .then(data => {
            allQueueData.transcription = data;
            displayTranscriptionQueue();
            updateQueueBadges();
        })
        .catch(error => {
            console.error('Error loading transcription queue:', error);
            showQueueError('transcriptionJobsList', 'Error loading transcription queue');
        });
}

function loadTranslationQueue() {
    fetch('/admin/api/queue/translation')
        .then(response => response.json())
        .then(data => {
            allQueueData.translation = data;
            displayTranslationQueue();
            updateQueueBadges();
        })
        .catch(error => {
            console.error('Error loading translation queue:', error);
            showQueueError('translationJobsList', 'Error loading translation queue');
        });
}

function loadVideoQueue() {
    fetch('/admin/api/queue/video')
        .then(response => response.json())
        .then(data => {
            allQueueData.video = data;
            displayVideoQueue();
            updateQueueBadges();
        })
        .catch(error => {
            console.error('Error loading video queue:', error);
            showQueueError('videoJobsList', 'Error loading video queue');
        });
}

function showQueueError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        const colspan = element.closest('table').querySelectorAll('thead th').length;
        element.innerHTML = `<tr><td colspan="${colspan}" class="text-danger text-center">${message}</td></tr>`;
    }
}

function updateQueueBadges() {
    // Update tab badges with queue counts
    const downloadTotal = (allQueueData.download.pending?.length || 0) + (allQueueData.download.in_progress?.length || 0);
    const transcriptionTotal = (allQueueData.transcription.pending?.length || 0) + (allQueueData.transcription.processing?.length || 0);
    const translationTotal = (allQueueData.translation.pending?.length || 0) + (allQueueData.translation.processing?.length || 0);
    const videoTotal = (allQueueData.video.pending?.length || 0) + (allQueueData.video.processing?.length || 0);
    
    document.getElementById('downloadQueueBadge').textContent = downloadTotal;
    document.getElementById('transcriptionQueueBadge').textContent = transcriptionTotal;
    document.getElementById('translationQueueBadge').textContent = translationTotal;
    document.getElementById('videoQueueBadge').textContent = videoTotal;
    
    // Update badge colors based on queue status
    updateBadgeColor('downloadQueueBadge', downloadTotal);
    updateBadgeColor('transcriptionQueueBadge', transcriptionTotal);
    updateBadgeColor('translationQueueBadge', translationTotal);
    updateBadgeColor('videoQueueBadge', videoTotal);
}

function updateBadgeColor(badgeId, count) {
    const badge = document.getElementById(badgeId);
    if (badge) {
        badge.className = count > 0 ? 'badge bg-warning ms-1' : 'badge bg-secondary ms-1';
    }
}

function loadQueue() {
    // Backward compatibility - load download queue
    loadDownloadQueue();
}

function displayDownloadQueue() {
    const data = allQueueData.download;
    
    // Update counts
    document.getElementById('downloadPendingCount').textContent = data.pending?.length || 0;
    document.getElementById('downloadProgressCount').textContent = data.in_progress?.length || 0;
    document.getElementById('downloadCompletedCount').textContent = data.completed?.length || 0;
    document.getElementById('downloadFailedCount').textContent = data.failed?.length || 0;
    
    // Display pending jobs
    const pendingTbody = document.getElementById('downloadPendingList');
    if (!data.pending || data.pending.length === 0) {
        pendingTbody.innerHTML = '<tr><td colspan="6" class="text-center">No pending jobs</td></tr>';
    } else {
        pendingTbody.innerHTML = data.pending.map(job => `
            <tr>
                <td><a href="/spaces/${job.space_id}" target="_blank" class="text-decoration-none"><code>${job.space_id}</code> <i class="bi bi-box-arrow-up-right small"></i></a></td>
                <td>${job.user_id || 'Anonymous'}</td>
                <td>
                    <select class="form-select form-select-sm" onchange="updateJobPriority(${job.id}, this.value)" style="width: auto;">
                        ${Object.entries(data.priorities || {}).map(([value, label]) => 
                            `<option value="${value}" ${job.priority == value ? 'selected' : ''}>${label}</option>`
                        ).join('')}
                    </select>
                    <span class="badge ${getPriorityBadgeClass(job.priority)} ms-2">${job.priority_label}</span>
                </td>
                <td><small class="text-muted">${formatDate(job.created_at)}</small></td>
                <td><span class="badge bg-secondary">${job.file_type || 'mp3'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger me-1" onclick="cancelDownloadJob(${job.id})" title="Cancel Job">
                        <i class="bi bi-x-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails(${job.id})" title="View Details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Display in-progress jobs
    const progressTbody = document.getElementById('downloadProgressList');
    if (!data.in_progress || data.in_progress.length === 0) {
        progressTbody.innerHTML = '<tr><td colspan="6" class="text-center">No jobs in progress</td></tr>';
    } else {
        progressTbody.innerHTML = data.in_progress.map(job => `
            <tr>
                <td><a href="/spaces/${job.space_id}" target="_blank" class="text-decoration-none"><code>${job.space_id}</code> <i class="bi bi-box-arrow-up-right small"></i></a></td>
                <td>${job.user_id || 'Anonymous'}</td>
                <td><span class="badge ${getPriorityBadgeClass(job.priority)}">${job.priority_label}</span></td>
                <td>
                    <div class="progress" style="width: 100px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${job.progress_in_percent || 0}%" 
                             title="${job.progress_in_percent || 0}%">
                            ${job.progress_in_percent || 0}%
                        </div>
                    </div>
                </td>
                <td><small class="text-muted">${formatDate(job.start_time)}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger me-1" onclick="cancelDownloadJob(${job.id})" title="Cancel Download">
                        <i class="bi bi-x-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails(${job.id})" title="View Details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Display completed jobs (limit to 10 most recent)
    const completedTbody = document.getElementById('downloadCompletedList');
    if (!data.completed || data.completed.length === 0) {
        completedTbody.innerHTML = '<tr><td colspan="6" class="text-center">No completed jobs</td></tr>';
    } else {
        const recentCompleted = data.completed.slice(0, 10);
        completedTbody.innerHTML = recentCompleted.map(job => `
            <tr>
                <td><small>${job.id}</small></td>
                <td><a href="/spaces/${job.space_id}" target="_blank" class="text-decoration-none"><code>${job.space_id}</code> <i class="bi bi-box-arrow-up-right small"></i></a></td>
                <td><small class="text-muted">${formatDate(job.start_time)}</small></td>
                <td><small class="text-muted">${formatDate(job.end_time)}</small></td>
                <td><span class="badge bg-secondary">${job.file_type || 'mp3'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-warning me-1" onclick="removeDownloadJob(${job.id})" title="Remove Record">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails(${job.id})" title="View Details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Display failed jobs (limit to 10 most recent)
    const failedTbody = document.getElementById('downloadFailedList');
    if (!data.failed || data.failed.length === 0) {
        failedTbody.innerHTML = '<tr><td colspan="6" class="text-center">No failed jobs</td></tr>';
    } else {
        const recentFailed = data.failed.slice(0, 10);
        failedTbody.innerHTML = recentFailed.map(job => `
            <tr>
                <td><small>${job.id}</small></td>
                <td><a href="/spaces/${job.space_id}" target="_blank" class="text-decoration-none"><code>${job.space_id}</code> <i class="bi bi-box-arrow-up-right small"></i></a></td>
                <td><small class="text-muted">${formatDate(job.start_time)}</small></td>
                <td><small class="text-danger" title="${job.error_message || ''}">${(job.error_message || 'Unknown error').substring(0, 50)}${job.error_message && job.error_message.length > 50 ? '...' : ''}</small></td>
                <td><span class="badge bg-secondary">${job.file_type || 'mp3'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-warning me-1" onclick="removeDownloadJob(${job.id})" title="Remove Record">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails(${job.id})" title="View Details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

function displayTranscriptionQueue() {
    const data = allQueueData.transcription;
    
    // Update counts
    document.getElementById('transcriptionPendingCount').textContent = data.pending?.length || 0;
    document.getElementById('transcriptionProgressCount').textContent = data.processing?.length || 0;
    document.getElementById('transcriptionCompletedCount').textContent = data.completed?.length || 0;
    document.getElementById('transcriptionFailedCount').textContent = data.failed?.length || 0;
    
    // Combine all jobs for display
    const allJobs = [
        ...(data.pending || []).map(job => ({...job, status: 'pending'})),
        ...(data.processing || []).map(job => ({...job, status: 'processing'})),
        ...(data.completed || []).slice(0, 10).map(job => ({...job, status: 'completed'})),
        ...(data.failed || []).slice(0, 5).map(job => ({...job, status: 'failed'}))
    ];
    
    const tbody = document.getElementById('transcriptionJobsList');
    if (allJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No transcription jobs</td></tr>';
    } else {
        tbody.innerHTML = allJobs.map(job => `
            <tr>
                <td><code>${job.job_id || job.id}</code></td>
                <td><a href="/spaces/${job.space_id}" target="_blank" class="text-decoration-none"><code>${job.space_id}</code> <i class="bi bi-box-arrow-up-right small"></i></a></td>
                <td><span class="badge bg-info">${job.model || job.options?.model || 'Unknown'}</span></td>
                <td><span class="badge bg-secondary">${job.language || job.options?.language || 'Auto'}</span></td>
                <td><span class="badge ${getJobStatusBadgeClass(job.status)}">${job.status}</span></td>
                <td>
                    ${job.status === 'processing' ? 
                        `<div class="progress" style="width: 80px;">
                            <div class="progress-bar" style="width: ${job.progress || 0}%">${job.progress || 0}%</div>
                        </div>` : 
                        '-'
                    }
                </td>
                <td><small class="text-muted">${formatDate(job.created_at)}</small></td>
                <td>
                    ${(job.status === 'pending' || job.status === 'processing') ? 
                        `<button class="btn btn-sm btn-outline-danger me-1" onclick="cancelTranscriptionJob('${job.job_id || job.id}')" title="Cancel Job">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTranscriptionJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>` :
                        `<button class="btn btn-sm btn-outline-warning me-1" onclick="removeTranscriptionJob('${job.job_id || job.id}')" title="Remove Record">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTranscriptionJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>`
                    }
                </td>
            </tr>
        `).join('');
    }
}

function displayTranslationQueue() {
    const data = allQueueData.translation;
    
    // Update counts
    document.getElementById('translationPendingCount').textContent = data.pending?.length || 0;
    document.getElementById('translationProgressCount').textContent = data.processing?.length || 0;
    document.getElementById('translationCompletedCount').textContent = data.completed?.length || 0;
    
    // Combine all jobs for display
    const allJobs = [
        ...(data.pending || []).map(job => ({...job, status: 'pending'})),
        ...(data.processing || []).map(job => ({...job, status: 'processing'})),
        ...(data.completed || []).slice(0, 10).map(job => ({...job, status: 'completed'}))
    ];
    
    const tbody = document.getElementById('translationJobsList');
    if (allJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No translation jobs</td></tr>';
    } else {
        tbody.innerHTML = allJobs.map(job => `
            <tr>
                <td><code>${job.job_id || job.id}</code></td>
                <td><a href="/spaces/${job.space_id}" target="_blank" class="text-decoration-none"><code>${job.space_id}</code> <i class="bi bi-box-arrow-up-right small"></i></a></td>
                <td><span class="badge bg-primary">${job.source_language || 'Auto'}</span></td>
                <td><span class="badge bg-success">${job.target_language || job.options?.translate_to || 'en'}</span></td>
                <td><span class="badge ${getJobStatusBadgeClass(job.status)}">${job.status}</span></td>
                <td>
                    ${job.status === 'processing' ? 
                        `<div class="progress" style="width: 80px;">
                            <div class="progress-bar" style="width: ${job.progress || 0}%">${job.progress || 0}%</div>
                        </div>` : 
                        '-'
                    }
                </td>
                <td><small class="text-muted">${formatDate(job.created_at)}</small></td>
                <td>
                    ${(job.status === 'pending' || job.status === 'processing') ? 
                        `<button class="btn btn-sm btn-outline-danger me-1" onclick="cancelTranslationJob('${job.job_id || job.id}')" title="Cancel Job">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTranslationJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>` :
                        `<button class="btn btn-sm btn-outline-warning me-1" onclick="removeTranslationJob('${job.job_id || job.id}')" title="Remove Record">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewTranslationJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>`
                    }
                </td>
            </tr>
        `).join('');
    }
}

function displayVideoQueue() {
    const data = allQueueData.video;
    
    // Update counts
    document.getElementById('videoPendingCount').textContent = data.pending?.length || 0;
    document.getElementById('videoProgressCount').textContent = data.processing?.length || 0;
    document.getElementById('videoCompletedCount').textContent = data.completed?.length || 0;
    
    // Combine all jobs for display
    const allJobs = [
        ...(data.pending || []).map(job => ({...job, status: 'pending'})),
        ...(data.processing || []).map(job => ({...job, status: 'processing'})),
        ...(data.completed || []).slice(0, 10).map(job => ({...job, status: 'completed'}))
    ];
    
    const tbody = document.getElementById('videoJobsList');
    if (allJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No video generation jobs</td></tr>';
    } else {
        tbody.innerHTML = allJobs.map(job => `
            <tr>
                <td><code>${job.job_id || job.id}</code></td>
                <td><a href="/spaces/${job.space_id}" target="_blank" class="text-decoration-none"><code>${job.space_id}</code> <i class="bi bi-box-arrow-up-right small"></i></a></td>
                <td>${job.user_id || 'Anonymous'}</td>
                <td><span class="badge ${getJobStatusBadgeClass(job.status)}">${job.status}</span></td>
                <td>
                    ${job.status === 'processing' ? 
                        `<div class="progress" style="width: 80px;">
                            <div class="progress-bar" style="width: ${job.progress || 0}%">${job.progress || 0}%</div>
                        </div>` : 
                        '-'
                    }
                </td>
                <td><small class="text-muted">${formatDate(job.created_at)}</small></td>
                <td>
                    ${(job.status === 'pending' || job.status === 'processing') ? 
                        `<button class="btn btn-sm btn-outline-danger me-1" onclick="cancelVideoJob('${job.job_id || job.id}')" title="Cancel Job">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewVideoJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>` :
                        `<button class="btn btn-sm btn-outline-warning me-1" onclick="removeVideoJob('${job.job_id || job.id}')" title="Remove Record">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewVideoJobDetails('${job.job_id || job.id}')" title="View Details">
                            <i class="bi bi-info-circle"></i>
                        </button>`
                    }
                </td>
            </tr>
        `).join('');
    }
}

function getJobStatusBadgeClass(status) {
    switch (status) {
        case 'pending': return 'bg-warning text-dark';
        case 'processing': return 'bg-info';
        case 'completed': return 'bg-success';
        case 'failed': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function displayQueue() {
    // Backward compatibility - display download queue
    displayDownloadQueue();
}

function getPriorityBadgeClass(priority) {
    switch (priority) {
        case 1: return 'bg-danger';
        case 2: return 'bg-warning';
        case 3: return 'bg-secondary';
        case 4: return 'bg-info';
        case 5: return 'bg-success';
        default: return 'bg-secondary';
    }
}

function updateJobPriority(jobId, newPriority) {
    fetch(`/admin/api/jobs/${jobId}/priority`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ priority: parseInt(newPriority) })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Show success message
            showToast('Priority updated successfully', 'success');
            // Refresh queue to show new order
            setTimeout(loadQueue, 500);
        } else {
            showToast('Error: ' + result.error, 'error');
            // Revert the select value
            loadQueue();
        }
    })
    .catch(error => {
        console.error('Error updating priority:', error);
        showToast('Error updating priority', 'error');
        loadQueue();
    });
}

function cancelJob(jobId) {
    // Delegate to the existing cancelDownloadJob function
    cancelDownloadJob(jobId);
}

function viewJobDetails(jobId) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('jobDetailsModal'));
    modal.show();
    
    // Reset content to loading state
    const content = document.getElementById('jobDetailsContent');
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading job details...</p>
        </div>
    `;
    
    // Fetch job details
    fetch(`/api/downloads/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error loading job details: ${data.error}
                    </div>
                `;
                return;
            }
            
            const job = data.job;
            const statusClass = getStatusClass(job.status);
            const statusIcon = getStatusIcon(job.status);
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Job ID:</strong></td>
                                        <td>${job.id}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Space ID:</strong></td>
                                        <td><a href="/spaces/${job.space_id}" target="_blank" class="text-decoration-none"><code>${job.space_id}</code> <i class="bi bi-box-arrow-up-right small"></i></a></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Status:</strong></td>
                                        <td><span class="badge bg-${statusClass}">${statusIcon} ${job.status}</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>File Type:</strong></td>
                                        <td>${job.file_type || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>User ID:</strong></td>
                                        <td>${job.user_id || 'Anonymous'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-clock"></i> Timing Information</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Created:</strong></td>
                                        <td>${formatDate(job.created_at)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Updated:</strong></td>
                                        <td>${formatDate(job.updated_at)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Start Time:</strong></td>
                                        <td>${formatDate(job.start_time)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>End Time:</strong></td>
                                        <td>${formatDate(job.end_time)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Duration:</strong></td>
                                        <td>${calculateDuration(job.start_time, job.end_time)}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${job.progress_in_size || job.progress_in_percent ? `
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Progress Information</h6>
                    </div>
                    <div class="card-body">
                        ${job.progress_in_percent ? `
                            <div class="mb-2">
                                <label class="form-label">Progress: ${job.progress_in_percent}%</label>
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${job.progress_in_percent}%"></div>
                                </div>
                            </div>
                        ` : ''}
                        ${job.progress_in_size ? `
                            <p><strong>Downloaded Size:</strong> ${(job.progress_in_size / 1024 / 1024).toFixed(2)} MB</p>
                        ` : ''}
                        ${job.process_id ? `
                            <p><strong>Process ID:</strong> ${job.process_id}</p>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
                
                ${job.error_message ? `
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle text-danger"></i> Error Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <code>${job.error_message}</code>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div class="text-center mt-3">
                    <a href="/spaces/${job.space_id}" class="btn btn-primary btn-sm" target="_blank">
                        <i class="bi bi-eye"></i> View Space
                    </a>
                    ${job.status === 'completed' ? `
                        <a href="/download/${job.space_id}?attachment=1" class="btn btn-success btn-sm" target="_blank">
                            <i class="bi bi-download"></i> Download File
                        </a>
                    ` : ''}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error fetching job details:', error);
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Failed to load job details. Please try again.
                </div>
            `;
        });
}

function getStatusClass(status) {
    switch(status) {
        case 'completed': return 'success';
        case 'failed': return 'danger';
        case 'in_progress': case 'downloading': return 'info';
        case 'pending': return 'warning';
        default: return 'secondary';
    }
}

function getStatusIcon(status) {
    switch(status) {
        case 'completed': return '<i class="bi bi-check-circle"></i>';
        case 'failed': return '<i class="bi bi-x-circle"></i>';
        case 'in_progress': case 'downloading': return '<i class="bi bi-arrow-clockwise"></i>';
        case 'pending': return '<i class="bi bi-clock"></i>';
        default: return '<i class="bi bi-question-circle"></i>';
    }
}

function calculateDuration(startTime, endTime) {
    if (!startTime || !endTime) return 'N/A';
    
    const start = new Date(startTime);
    const end = new Date(endTime);
    const durationMs = end - start;
    
    if (durationMs < 0) return 'N/A';
    
    const seconds = Math.floor(durationMs / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
    } else {
        return `${seconds}s`;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString();
}

function clearAllCaches() {
    if (!confirm('Are you sure you want to clear all caches? This will force a reload of all data from the database.')) {
        return;
    }
    
    // Show loading state
    const cacheMessage = document.getElementById('cacheMessage');
    cacheMessage.className = 'alert alert-info mt-3';
    cacheMessage.innerHTML = '<i class="bi bi-hourglass-split spin"></i> Clearing caches...';
    cacheMessage.style.display = 'block';
    
    fetch('/admin/api/cache/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            cacheMessage.className = 'alert alert-success mt-3';
            cacheMessage.innerHTML = '<i class="bi bi-check-circle"></i> ' + result.message;
            
            // Show toast notification
            showToast('All caches have been cleared successfully', 'success');
            
            // Hide message after 5 seconds
            setTimeout(() => {
                cacheMessage.style.display = 'none';
            }, 5000);
            
            // Refresh any active data displays
            if (window.location.hash === '#queue' || document.querySelector('#queue-tab.active')) {
                refreshAllQueues();
            }
            
            // Reload cache status
            setTimeout(loadCacheStatus, 1000);
        } else {
            cacheMessage.className = 'alert alert-danger mt-3';
            cacheMessage.innerHTML = '<i class="bi bi-x-circle"></i> Error: ' + (result.error || 'Failed to clear caches');
            showToast('Error clearing caches', 'error');
        }
    })
    .catch(error => {
        console.error('Error clearing caches:', error);
        cacheMessage.className = 'alert alert-danger mt-3';
        cacheMessage.innerHTML = '<i class="bi bi-x-circle"></i> Error clearing caches';
        showToast('Error clearing caches', 'error');
    });
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// Queue management action functions
function cancelTranscriptionJob(jobId) {
    if (!confirm('Are you sure you want to cancel this transcription job?')) return;
    
    fetch(`/admin/api/transcription/${jobId}/cancel`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Transcription job cancelled', 'success');
            loadTranscriptionQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error cancelling transcription job:', error);
        showToast('Error cancelling transcription job', 'error');
    });
}

function cancelTranslationJob(jobId) {
    if (!confirm('Are you sure you want to cancel this translation job?')) return;
    
    fetch(`/admin/api/translation/${jobId}/cancel`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Translation job cancelled', 'success');
            loadTranslationQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error cancelling translation job:', error);
        showToast('Error cancelling translation job', 'error');
    });
}

function cancelVideoJob(jobId) {
    if (!confirm('Are you sure you want to cancel this video generation job?')) return;
    
    fetch(`/admin/api/video/${jobId}/cancel`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Video job cancelled', 'success');
            loadVideoQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error cancelling video job:', error);
        showToast('Error cancelling video job', 'error');
    });
}

function cancelDownloadJob(jobId) {
    if (!confirm('Are you sure you want to cancel this download job? This will stop the download process.')) return;
    
    fetch(`/admin/api/download/${jobId}/cancel`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const message = result.process_killed ? 
                'Download job cancelled and process terminated' : 
                'Download job cancelled';
            showToast(message, 'success');
            loadDownloadQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error cancelling download job:', error);
        showToast('Error cancelling download job', 'error');
    });
}

function removeDownloadJob(jobId) {
    if (!confirm('Are you sure you want to remove this job record? This action cannot be undone.')) return;
    
    fetch(`/admin/api/download/${jobId}/remove`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Download job record removed', 'success');
            loadDownloadQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error removing download job:', error);
        showToast('Error removing download job', 'error');
    });
}

function removeTranscriptionJob(jobId) {
    if (!confirm('Are you sure you want to remove this job record? This action cannot be undone.')) return;
    
    fetch(`/admin/api/transcription/${jobId}/remove`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Transcription job record removed', 'success');
            loadTranscriptionQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error removing transcription job:', error);
        showToast('Error removing transcription job', 'error');
    });
}

function removeTranslationJob(jobId) {
    if (!confirm('Are you sure you want to remove this job record? This action cannot be undone.')) return;
    
    fetch(`/admin/api/translation/${jobId}/remove`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Translation job record removed', 'success');
            loadTranslationQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error removing translation job:', error);
        showToast('Error removing translation job', 'error');
    });
}

function removeVideoJob(jobId) {
    if (!confirm('Are you sure you want to remove this job record? This action cannot be undone.')) return;
    
    fetch(`/admin/api/video/${jobId}/remove`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Video job record removed', 'success');
            loadVideoQueue();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error removing video job:', error);
        showToast('Error removing video job', 'error');
    });
}

function viewTranscriptionJobDetails(jobId) {
    fetch(`/admin/api/transcription/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const job = data.job;
                let details = `Job ID: ${jobId}\n`;
                details += `Space ID: ${job.space_id}\n`;
                details += `Status: ${job.status}\n`;
                details += `Progress: ${job.progress || 0}%\n`;
                details += `Model: ${job.model || job.options?.model || 'Unknown'}\n`;
                details += `Language: ${job.language || job.options?.language || 'Auto'}\n`;
                
                if (job.options?.translate_to) {
                    details += `Translate to: ${job.options.translate_to}\n`;
                }
                
                details += `Created: ${formatDate(job.created_at)}\n`;
                
                if (job.updated_at) {
                    details += `Updated: ${formatDate(job.updated_at)}\n`;
                }
                
                if (job.error) {
                    details += `\nError: ${job.error}`;
                }
                
                if (job.result) {
                    details += `\nResult: Transcript generated (${job.result.text_sample || 'No preview available'})`;
                }
                
                alert(details);
            } else {
                showToast('Error: ' + (data.error || 'Job not found'), 'error');
            }
        })
        .catch(error => {
            console.error('Error loading transcription job details:', error);
            showToast('Error loading job details', 'error');
        });
}

function viewTranslationJobDetails(jobId) {
    fetch(`/admin/api/translation/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Job ID: ${jobId}\nSpace: ${data.job.space_id}\nFrom: ${data.job.source_language}\nTo: ${data.job.target_language}\nStatus: ${data.job.status}`);
            } else {
                showToast('Error loading job details', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading translation job details:', error);
            showToast('Error loading job details', 'error');
        });
}

function viewVideoJobDetails(jobId) {
    fetch(`/admin/api/video/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Job ID: ${jobId}\nSpace: ${data.job.space_id}\nUser: ${data.job.user_id}\nStatus: ${data.job.status}\nProgress: ${data.job.progress}%`);
            } else {
                showToast('Error loading job details', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading video job details:', error);
            showToast('Error loading job details', 'error');
        });
}

// Cache Management Functions
function loadCacheStatus() {
    fetch('/admin/api/cache/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('cacheStatusInfo');
            let html = '<ul class="mb-0">';
            
            // Spaces Cache
            if (data.spaces_cache.active) {
                const age = Math.round(data.spaces_cache.age_seconds);
                const expires = Math.round(data.spaces_cache.expires_in_seconds);
                html += `<li><strong>Spaces Cache:</strong> 
                    <span class="badge bg-success">Active</span>
                    <small class="text-muted">(Age: ${formatDuration(age)}, Expires in: ${formatDuration(expires)})</small>
                </li>`;
            } else {
                html += `<li><strong>Spaces Cache:</strong> 
                    <span class="badge bg-secondary">Empty</span>
                    <small class="text-muted">(TTL: ${data.spaces_cache.ttl}s)</small>
                </li>`;
            }
            
            // Index Cache
            if (data.index_cache.active) {
                const age = Math.round(data.index_cache.age_seconds);
                const expires = Math.round(data.index_cache.expires_in_seconds);
                html += `<li><strong>Index Cache:</strong> 
                    <span class="badge bg-success">Active</span>
                    <small class="text-muted">(Age: ${formatDuration(age)}, Expires in: ${formatDuration(expires)})</small>
                </li>`;
            } else {
                html += `<li><strong>Index Cache:</strong> 
                    <span class="badge bg-secondary">Empty</span>
                    <small class="text-muted">(TTL: ${data.index_cache.ttl}s)</small>
                </li>`;
            }
            
            html += '</ul>';
            statusDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading cache status:', error);
            document.getElementById('cacheStatusInfo').innerHTML = 
                '<div class="text-danger">Error loading cache status</div>';
        });
}

function formatDuration(seconds) {
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}m ${remainingSeconds}s`;
}

// Load queue when queue tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const queueTab = document.getElementById('queue-tab');
    if (queueTab) {
        queueTab.addEventListener('shown.bs.tab', function() {
            refreshAllQueues();
        });
    }
    
    // Load all queues on page load if we're on the queue tab
    if (window.location.hash === '#queue' || document.querySelector('#queue-tab.active')) {
        refreshAllQueues();
    }
    
    // Load cache status when settings tab is shown
    const settingsTab = document.getElementById('settings-tab');
    if (settingsTab) {
        settingsTab.addEventListener('shown.bs.tab', function() {
            loadCacheStatus();
        });
    }
    
    // Load cache status on page load if we're on the settings tab
    if (window.location.hash === '#settings' || document.querySelector('#settings-tab.active')) {
        loadCacheStatus();
    }
});

// SQL Logging Functions
let sqlLogData = [];
let sqlLogStatus = false;

function toggleSQLLogging() {
    const action = sqlLogStatus ? 'disable' : 'enable';
    
    fetch(`/admin/api/sql-logging/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sqlLogStatus = !sqlLogStatus;
            updateSQLLogStatus();
            showToast(`SQL logging ${action}d successfully`, 'success');
            if (sqlLogStatus) {
                document.getElementById('sqlPerformanceWarning').style.display = 'block';
                refreshSQLLogs();
            } else {
                document.getElementById('sqlPerformanceWarning').style.display = 'none';
            }
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error toggling SQL logging:', error);
        showToast('Error toggling SQL logging', 'error');
    });
}

function updateSQLLogStatus() {
    const statusBadge = document.getElementById('sqlLogStatus');
    const toggleIcon = document.getElementById('sqlToggleIcon');
    const toggleText = document.getElementById('sqlToggleText');
    
    if (sqlLogStatus) {
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Enabled';
        toggleIcon.className = 'bi bi-power';
        toggleText.textContent = 'Disable';
    } else {
        statusBadge.className = 'badge bg-secondary';
        statusBadge.textContent = 'Disabled';
        toggleIcon.className = 'bi bi-play';
        toggleText.textContent = 'Enable';
    }
}

function refreshSQLLogs() {
    fetch('/admin/api/sql-logs')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('Error loading SQL logs: ' + data.error, 'error');
            } else {
                sqlLogData = data.logs || [];
                sqlLogStatus = data.enabled || false;
                updateSQLLogStatus();
                displaySQLLogs();
                calculateSQLStats();
            }
        })
        .catch(error => {
            console.error('Error loading SQL logs:', error);
            showToast('Error loading SQL logs', 'error');
        });
}

function displaySQLLogs() {
    const container = document.getElementById('sqlContainer');
    const componentFilter = document.getElementById('sqlComponentFilter').value;
    const statusFilter = document.getElementById('sqlStatusFilter').value;
    const searchFilter = document.getElementById('sqlSearchFilter').value.toLowerCase();
    
    let filteredLogs = sqlLogData;
    
    // Apply filters
    if (componentFilter) {
        filteredLogs = filteredLogs.filter(log => log.message.includes(`[${componentFilter}]`));
    }
    
    if (statusFilter) {
        filteredLogs = filteredLogs.filter(log => log.message.includes(statusFilter));
    }
    
    if (searchFilter) {
        filteredLogs = filteredLogs.filter(log => 
            log.message.toLowerCase().includes(searchFilter)
        );
    }
    
    document.getElementById('sqlLogCount').textContent = filteredLogs.length;
    
    if (filteredLogs.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-database fs-1"></i>
                <p class="mt-2">No SQL logs found matching current filters.</p>
                <p class="small">Clear filters or enable SQL logging to see queries.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    filteredLogs.forEach(log => {
        const isError = log.level === 'ERROR';
        const timeColor = isError ? '#ff6b6b' : '#4ecdc4';
        const levelColor = isError ? '#ff4757' : '#20bf6b';
        
        html += `
            <div class="mb-2 p-2 border-start border-3" style="border-color: ${levelColor} !important;">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <span class="badge" style="background-color: ${levelColor}; font-size: 0.7rem;">
                        ${log.level}
                    </span>
                    <small style="color: #888;">${log.timestamp}</small>
                </div>
                <div style="color: ${timeColor}; font-size: 0.85rem; word-break: break-all;">
                    ${escapeHtml(log.message)}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
}

function calculateSQLStats() {
    const timeRegex = /\((\d+\.?\d*)ms\)/g;
    const times = [];
    let errorCount = 0;
    
    sqlLogData.forEach(log => {
        if (log.level === 'ERROR') {
            errorCount++;
        }
        
        const match = timeRegex.exec(log.message);
        if (match) {
            times.push(parseFloat(match[1]));
        }
        timeRegex.lastIndex = 0; // Reset regex
    });
    
    if (times.length > 0) {
        const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
        const minTime = Math.min(...times);
        const maxTime = Math.max(...times);
        
        document.getElementById('sqlAvgTime').textContent = avgTime.toFixed(2);
        document.getElementById('sqlFastestTime').textContent = minTime.toFixed(2);
        document.getElementById('sqlSlowestTime').textContent = maxTime.toFixed(2);
    } else {
        document.getElementById('sqlAvgTime').textContent = '-';
        document.getElementById('sqlFastestTime').textContent = '-';
        document.getElementById('sqlSlowestTime').textContent = '-';
    }
    
    document.getElementById('sqlErrorCount').textContent = errorCount;
}

function clearSQLLogs() {
    if (!confirm('Are you sure you want to clear all SQL logs? This action cannot be undone.')) {
        return;
    }
    
    fetch('/admin/api/sql-logs/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sqlLogData = [];
            displaySQLLogs();
            calculateSQLStats();
            showToast('SQL logs cleared successfully', 'success');
        } else {
            showToast('Error clearing SQL logs: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error clearing SQL logs:', error);
        showToast('Error clearing SQL logs', 'error');
    });
}

function copySQLLogs() {
    if (!currentSQLLogs || currentSQLLogs.length === 0) {
        showToast('No logs to copy', 'warning');
        return;
    }
    
    // Format logs as plain text
    let logText = '';
    currentSQLLogs.forEach(log => {
        logText += `[${log.timestamp}] ${log.level}: ${log.message}\n`;
    });
    
    // Copy to clipboard
    navigator.clipboard.writeText(logText).then(() => {
        showToast('SQL logs copied to clipboard', 'success');
    }).catch(err => {
        console.error('Failed to copy logs:', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = logText;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast('SQL logs copied to clipboard', 'success');
        } catch (err) {
            showToast('Failed to copy logs', 'error');
        }
        document.body.removeChild(textArea);
    });
}

function clearSQLFilters() {
    document.getElementById('sqlComponentFilter').value = '';
    document.getElementById('sqlStatusFilter').value = '';
    document.getElementById('sqlSearchFilter').value = '';
    displaySQLLogs();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize SQL tab when shown
document.addEventListener('DOMContentLoaded', function() {
    const sqlTab = document.getElementById('sql-tab');
    if (sqlTab) {
        sqlTab.addEventListener('shown.bs.tab', function() {
            refreshSQLLogs();
        });
    }
    
    // Filter event listeners
    const filters = ['sqlComponentFilter', 'sqlStatusFilter', 'sqlSearchFilter'];
    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.addEventListener('change', displaySQLLogs);
            element.addEventListener('input', displaySQLLogs);
        }
    });
});

// System Status functionality
let systemStatusAutoRefresh = false;
let systemStatusInterval = null;

function loadSystemStatus() {
    const contentDiv = document.getElementById('systemStatusContent');
    if (!contentDiv) return;
    
    // Show loading spinner
    contentDiv.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading system status...</p>
        </div>
    `;
    
    fetch('/admin/api/system_status')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Error loading system status:</h6>
                        <p class="mb-0">${data.error}</p>
                    </div>
                `;
                return;
            }
            
            displaySystemStatus(data);
        })
        .catch(error => {
            console.error('Error loading system status:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>Failed to load system status</h6>
                    <p class="mb-0">Please check the console for details.</p>
                </div>
            `;
        });
}

function displaySystemStatus(data) {
    const contentDiv = document.getElementById('systemStatusContent');
    if (!contentDiv) return;
    
    const formatUptime = (uptime) => uptime || 'Unknown';
    const formatMemory = (mb) => mb ? `${mb} MB` : 'Unknown';
    const getStatusBadge = (isRunning, status = null) => {
        if (isRunning === true || status === 'active') {
            return '<span class="badge bg-success">Running</span>';
        } else if (isRunning === false || status === 'inactive') {
            return '<span class="badge bg-danger">Stopped</span>';
        } else {
            return '<span class="badge bg-warning">Unknown</span>';
        }
    };
    
    let html = `
        <div class="row">
            <!-- System Information -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> System Information</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr><td><strong>Hostname:</strong></td><td>${data.system_info?.hostname || 'Unknown'}</td></tr>
                            <tr><td><strong>Platform:</strong></td><td>${data.system_info?.platform || 'Unknown'}</td></tr>
                            <tr><td><strong>Architecture:</strong></td><td>${data.system_info?.architecture || 'Unknown'}</td></tr>
                            <tr><td><strong>Python:</strong></td><td>${data.system_info?.python_version || 'Unknown'}</td></tr>
                            <tr><td><strong>CPU Cores:</strong></td><td>${data.system_info?.cpu_count || 'Unknown'}</td></tr>
                            <tr><td><strong>Boot Time:</strong></td><td>${data.system_info?.boot_time || 'Unknown'}</td></tr>
                            <tr><td><strong>Uptime:</strong></td><td>${formatUptime(data.system_info?.uptime)}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Port Information -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-diagram-3"></i> Network Ports</h6>
                    </div>
                    <div class="card-body">
                        ${data.port_info?.main_app ? `
                            <div class="alert alert-success">
                                <strong>Main Application:</strong> Port ${data.port_info.main_app.port} 
                                (PID: ${data.port_info.main_app.pid})
                            </div>
                        ` : '<div class="alert alert-warning">Main application port not detected</div>'}
                        
                        <h6 class="mt-3">Active Ports:</h6>
                        <div style="max-height: 150px; overflow-y: auto;">
                            ${data.port_info?.listening_ports?.length ? 
                                data.port_info.listening_ports.map(port => `
                                    <small class="d-block">
                                        ${port.address}:${port.port} - ${port.process_name || 'Unknown'} 
                                        ${port.pid ? `(PID: ${port.pid})` : ''}
                                    </small>
                                `).join('') 
                                : '<small class="text-muted">No listening ports detected</small>'
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Gunicorn Status -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-server"></i> Gunicorn Application Server</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span><strong>Status:</strong></span>
                            ${getStatusBadge(data.gunicorn_status?.status === 'running')}
                        </div>
                        ${data.gunicorn_status?.master_pid ? `
                            <p><strong>Master PID:</strong> ${data.gunicorn_status.master_pid}</p>
                            <p><strong>Uptime:</strong> ${formatUptime(data.gunicorn_status.master_uptime)}</p>
                        ` : ''}
                        <p><strong>Workers:</strong> ${data.gunicorn_status?.worker_count || 0}</p>
                        ${data.gunicorn_status?.total_memory_mb ? `
                            <p><strong>Total Memory:</strong> ${formatMemory(data.gunicorn_status.total_memory_mb)}</p>
                        ` : ''}
                        
                        ${data.gunicorn_status?.workers?.length ? `
                            <details class="mt-2">
                                <summary><small>Worker Details</small></summary>
                                <div class="mt-2">
                                    ${data.gunicorn_status.workers.map(worker => `
                                        <small class="d-block">
                                            PID ${worker.pid}: ${formatMemory(worker.memory_mb)}, 
                                            Uptime: ${formatUptime(worker.uptime)}
                                        </small>
                                    `).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <!-- Background Processes -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-gear"></i> Background Processes</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <small><i class="bi bi-info-circle"></i> Background processes are managed by shell scripts (bg_downloader.sh, run_transcribe_worker.sh, run_progress_watcher.sh), not systemd services.</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>Downloader (bg_downloader.py):</strong></span>
                                ${getStatusBadge(data.background_processes?.bg_downloader?.length > 0)}
                            </div>
                            <small class="text-muted">
                                ${data.background_processes?.bg_downloader?.length || 0} process(es) running
                                ${data.background_processes?.bg_downloader?.length > 0 ? 
                                    `<br>PIDs: ${data.background_processes.bg_downloader.map(p => p.pid).join(', ')}` : ''}
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>Transcriber (background_transcribe.py):</strong></span>
                                ${getStatusBadge(data.background_processes?.background_transcribe?.length > 0)}
                            </div>
                            <small class="text-muted">
                                ${data.background_processes?.background_transcribe?.length || 0} process(es) running
                                ${data.background_processes?.background_transcribe?.length > 0 ? 
                                    `<br>PIDs: ${data.background_processes.background_transcribe.map(p => p.pid).join(', ')}` : ''}
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>Progress Watcher (bg_progress_watcher.py):</strong></span>
                                ${getStatusBadge(data.background_processes?.bg_progress_watcher?.length > 0)}
                            </div>
                            <small class="text-muted">
                                ${data.background_processes?.bg_progress_watcher?.length || 0} process(es) running
                                ${data.background_processes?.bg_progress_watcher?.length > 0 ? 
                                    `<br>PIDs: ${data.background_processes.bg_progress_watcher.map(p => p.pid).join(', ')}` : ''}
                            </small>
                        </div>
                        
                        <!-- Process Details -->
                        ${Object.entries(data.background_processes || {}).some(([key, processes]) => processes.length > 0) ? `
                            <details class="mt-3">
                                <summary><small>Process Details</small></summary>
                                <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                                    ${Object.entries(data.background_processes || {}).map(([processType, processes]) => 
                                        processes.map(proc => `
                                            <div class="border-bottom pb-1 mb-1">
                                                <small><strong>${processType}:</strong> PID ${proc.pid}</small><br>
                                                <small>Memory: ${formatMemory(proc.memory_mb)}, Uptime: ${formatUptime(proc.uptime)}</small><br>
                                                <small class="text-muted">Started: ${proc.started}</small>
                                            </div>
                                        `).join('')
                                    ).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- System Services -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-list-check"></i> System Services</h6>
                    </div>
                    <div class="card-body">
                        ${Object.entries(data.systemd_services || {}).map(([serviceName, service]) => `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><strong>${serviceName}:</strong></span>
                                ${getStatusBadge(service.active, service.status)}
                            </div>
                            <small class="text-muted d-block mb-2">
                                ${service.enabled ? 
                                    '<i class="bi bi-check-circle text-success" title="Service starts automatically on boot"></i> Auto-start enabled' : 
                                    '<i class="bi bi-x-circle text-warning" title="Service must be started manually"></i> Auto-start disabled'}
                                ${service.main_pid ? ` | PID: ${service.main_pid}` : ''}
                                ${service.memory ? ` | Memory: ${service.memory}` : ''}
                            </small>
                        `).join('')}
                        
                        <!-- MySQL Database Status -->
                        ${data.mysql_status ? `
                            <hr class="my-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><strong>MySQL Database:</strong></span>
                                ${getStatusBadge(data.mysql_status.active, data.mysql_status.status)}
                            </div>
                            <small class="text-muted d-block">
                                ${data.mysql_status.message || 'Unknown'}
                                ${data.mysql_status.database ? ` | DB: ${data.mysql_status.database}` : ''}
                            </small>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <!-- Disk Usage -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-hdd"></i> Disk Usage</h6>
                        ${data.disk_usage?.disk_total?.free_gb ? `
                            <span class="badge bg-info">${data.disk_usage.disk_total.free_gb} GB Free</span>
                        ` : ''}
                    </div>
                    <div class="card-body">
                        ${data.disk_usage?.disk_total ? `
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span><strong>System Disk:</strong></span>
                                    <span>${data.disk_usage.disk_total.percent_used}%</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar ${data.disk_usage.disk_total.percent_used > 90 ? 'bg-danger' : data.disk_usage.disk_total.percent_used > 70 ? 'bg-warning' : 'bg-success'}" 
                                         style="width: ${data.disk_usage.disk_total.percent_used}%"></div>
                                </div>
                                <small class="text-muted">
                                    ${data.disk_usage.disk_total.used_gb} GB / ${data.disk_usage.disk_total.total_gb} GB used
                                </small>
                            </div>
                            <hr>
                        ` : ''}
                        
                        ${data.disk_usage?.app_total_gb !== undefined ? `
                            <div class="mb-2">
                                <strong>Application Total: ${data.disk_usage.app_total_gb} GB</strong>
                            </div>
                        ` : ''}
                        
                        ${data.disk_usage?.directories ? Object.entries(data.disk_usage.directories).map(([name, dir]) => `
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>${name}:</span>
                                    <span>${dir.error ? 'Error' : 
                                        dir.exists === false ? 'Not found' :
                                        `${dir.size_gb} GB (${dir.percent_of_app}%)`}</span>
                                </div>
                                ${!dir.error && dir.exists !== false && dir.percent_of_app > 0 ? `
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-primary" 
                                             style="width: ${dir.percent_of_app}%"></div>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('') : 'No directory information available'}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-end">
            <small class="text-muted">Last updated: ${new Date(data.timestamp).toLocaleString()}</small>
        </div>
    `;
    
    contentDiv.innerHTML = html;
}

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    if (!btn) return;
    
    if (systemStatusAutoRefresh) {
        // Stop auto refresh
        systemStatusAutoRefresh = false;
        if (systemStatusInterval) {
            clearInterval(systemStatusInterval);
            systemStatusInterval = null;
        }
        btn.innerHTML = '<i class="bi bi-play"></i> Auto Refresh';
        btn.classList.remove('btn-outline-danger');
        btn.classList.add('btn-outline-secondary');
    } else {
        // Start auto refresh (every 10 seconds)
        systemStatusAutoRefresh = true;
        systemStatusInterval = setInterval(loadSystemStatus, 10000);
        btn.innerHTML = '<i class="bi bi-stop"></i> Stop Auto Refresh';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-danger');
        loadSystemStatus(); // Load immediately
    }
}

// Load system status when the tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const statusTab = document.getElementById('status-tab');
    if (statusTab) {
        statusTab.addEventListener('shown.bs.tab', function() {
            loadSystemStatus();
        });
    }
    
    // Load administrator guide when help tab is shown
    const helpTab = document.getElementById('help-tab');
    if (helpTab) {
        helpTab.addEventListener('shown.bs.tab', function() {
            loadAdministratorGuide();
        });
    }
});

// Load administrator guide content
function loadAdministratorGuide() {
    const content = document.getElementById('administrator-guide-content');
    if (!content) return;
    
    // Show loading state
    content.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading guide...</span>
            </div>
            <p class="mt-3">Loading Administrator's Guide...</p>
        </div>
    `;
    
    // Fetch guide content
    fetch('/admin/api/administrator-guide')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            content.innerHTML = `<div class="p-4">${html}</div>`;
            
            // Add table of contents navigation
            addTableOfContents();
            
            // Style the content
            styleGuideContent();
        })
        .catch(error => {
            console.error('Error loading administrator guide:', error);
            content.innerHTML = `
                <div class="alert alert-danger m-4">
                    <h5><i class="bi bi-exclamation-triangle"></i> Error Loading Guide</h5>
                    <p>Failed to load the Administrator's Guide: ${error.message}</p>
                    <p>Please try refreshing the page or contact technical support.</p>
                </div>
            `;
        });
}

// Add table of contents with jump links
function addTableOfContents() {
    const content = document.getElementById('administrator-guide-content');
    const headings = content.querySelectorAll('h2, h3');
    
    if (headings.length === 0) return;
    
    // Create TOC container
    const tocHtml = `
        <div class="card mb-4" id="table-of-contents">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-list-ol"></i> Table of Contents</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    ${Array.from(headings).map((heading, index) => {
                        const id = `section-${index}`;
                        heading.id = id;
                        const level = heading.tagName === 'H2' ? 'fw-bold' : 'ms-3';
                        return `
                            <div class="col-md-6 mb-2">
                                <a href="#${id}" class="text-decoration-none ${level}" onclick="scrollToSection('${id}')">
                                    ${heading.textContent}
                                </a>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
    
    const firstChild = content.querySelector('.p-4').firstElementChild;
    if (firstChild) {
        firstChild.insertAdjacentHTML('afterend', tocHtml);
    }
}

// Scroll to specific section
function scrollToSection(sectionId) {
    const element = document.getElementById(sectionId);
    if (element) {
        const content = document.getElementById('administrator-guide-content');
        const elementTop = element.offsetTop - content.offsetTop;
        content.scrollTo({
            top: elementTop - 20,
            behavior: 'smooth'
        });
    }
}

// Style the guide content for better readability
function styleGuideContent() {
    const content = document.getElementById('administrator-guide-content');
    
    // Style code blocks
    content.querySelectorAll('code').forEach(code => {
        if (!code.parentElement.tagName === 'PRE') {
            code.classList.add('bg-light', 'p-1', 'rounded');
        }
    });
    
    // Style pre blocks
    content.querySelectorAll('pre').forEach(pre => {
        pre.classList.add('bg-dark', 'text-light', 'p-3', 'rounded', 'overflow-auto');
        const code = pre.querySelector('code');
        if (code) {
            code.classList.remove('bg-light', 'p-1');
        }
    });
    
    // Style tables
    content.querySelectorAll('table').forEach(table => {
        table.classList.add('table', 'table-striped', 'table-hover');
        const wrapper = document.createElement('div');
        wrapper.classList.add('table-responsive', 'my-3');
        table.parentNode.insertBefore(wrapper, table);
        wrapper.appendChild(table);
    });
    
    // Style blockquotes
    content.querySelectorAll('blockquote').forEach(blockquote => {
        blockquote.classList.add('border-start', 'border-4', 'border-primary', 'ps-3', 'my-3');
    });
    
    // Add copy buttons to code blocks
    content.querySelectorAll('pre code').forEach((code, index) => {
        const copyId = `copy-code-${index}`;
        const copyBtn = `
            <button class="btn btn-sm btn-outline-secondary position-absolute" 
                    style="top: 10px; right: 10px;" 
                    onclick="copyCodeBlock('${copyId}')"
                    title="Copy code">
                <i class="bi bi-clipboard"></i>
            </button>
        `;
        code.id = copyId;
        const pre = code.parentElement;
        pre.style.position = 'relative';
        pre.insertAdjacentHTML('beforeend', copyBtn);
    });
}

// Copy code block to clipboard
function copyCodeBlock(codeId) {
    const codeElement = document.getElementById(codeId);
    if (!codeElement) return;
    
    navigator.clipboard.writeText(codeElement.textContent).then(() => {
        showToast('Code copied to clipboard', 'success');
    }).catch(err => {
        console.error('Failed to copy code:', err);
        showToast('Failed to copy code', 'error');
    });
}

// Print the administrator guide
function printGuide() {
    const content = document.getElementById('administrator-guide-content');
    if (!content) {
        showToast('No content to print', 'warning');
        return;
    }
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    const guideContent = content.innerHTML;
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>XSpace Downloader - Administrator's Guide</title>
            <style>
                body { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    line-height: 1.6;
                    color: #333;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }
                h1, h2, h3, h4, h5, h6 { 
                    color: #2c3e50;
                    margin-top: 30px;
                    margin-bottom: 15px;
                }
                h1 { border-bottom: 3px solid #3498db; padding-bottom: 10px; }
                h2 { border-bottom: 1px solid #ecf0f1; padding-bottom: 5px; }
                code { 
                    background: #f8f9fa;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-family: 'Monaco', 'Menlo', monospace;
                }
                pre { 
                    background: #2c3e50;
                    color: #ecf0f1;
                    padding: 15px;
                    border-radius: 5px;
                    overflow-x: auto;
                }
                pre code { 
                    background: none;
                    padding: 0;
                    color: inherit;
                }
                table { 
                    width: 100%;
                    border-collapse: collapse;
                    margin: 15px 0;
                }
                th, td { 
                    border: 1px solid #ddd;
                    padding: 8px 12px;
                    text-align: left;
                }
                th { 
                    background: #f8f9fa;
                    font-weight: bold;
                }
                .alert { 
                    padding: 12px;
                    margin: 15px 0;
                    border-radius: 4px;
                    border-left: 4px solid #3498db;
                    background: #f8f9fa;
                }
                blockquote {
                    border-left: 4px solid #3498db;
                    padding-left: 15px;
                    margin: 15px 0;
                    color: #666;
                }
                @media print {
                    body { margin: 0; padding: 15px; }
                    h1 { page-break-before: always; }
                    h1:first-child { page-break-before: auto; }
                    pre, blockquote { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            ${guideContent}
            <footer style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666;">
                <p>XSpace Downloader - Administrator's Guide</p>
                <p>Generated on ${new Date().toLocaleDateString()}</p>
            </footer>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
    };
}

// Service Settings Functions
async function loadServiceSettings() {
    try {
        const response = await fetch('/admin/api/service_settings');
        const result = await response.json();
        
        if (result.settings) {
            document.getElementById('transcriptionEnabled').checked = result.settings.transcription_enabled?.value || false;
            document.getElementById('videoGenerationEnabled').checked = result.settings.video_generation_enabled?.value || false;
        }
    } catch (error) {
        console.error('Error loading service settings:', error);
    }
}

document.getElementById('serviceSettingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageDiv = document.getElementById('serviceSettingsMessage');
    messageDiv.style.display = 'none';
    
    const data = {
        transcription_enabled: document.getElementById('transcriptionEnabled').checked,
        video_generation_enabled: document.getElementById('videoGenerationEnabled').checked
    };
    
    try {
        const response = await fetch('/admin/api/service_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.className = 'alert alert-success mt-3';
            messageDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${result.message}`;
        } else {
            messageDiv.className = 'alert alert-danger mt-3';
            messageDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Error: ${result.error}`;
        }
        
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
        
    } catch (error) {
        console.error('Error saving service settings:', error);
        messageDiv.className = 'alert alert-danger mt-3';
        messageDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Error saving settings: ${error.message}`;
        messageDiv.style.display = 'block';
    }
});

// System Messages Functions
let systemMessagesList; // Global variable for list.js instance

async function loadAdminSystemMessages() {
    console.log('Loading system messages...');
    console.log('Function called at:', new Date().toISOString());
    
    const tableDiv = document.getElementById('systemMessagesTable');
    console.log('Table div found:', tableDiv ? 'Yes' : 'No');
    
    if (!tableDiv) {
        console.error('systemMessagesTable element not found!');
        return;
    }
    
    try {
        console.log('Fetching from /admin/api/system_messages...');
        const response = await fetch('/admin/api/system_messages');
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('System messages response:', result);
        console.log('Number of messages:', result.messages ? result.messages.length : 0);
        
        if (result.messages && result.messages.length > 0) {
            // Create the table structure with list.js requirements
            let tableHTML = `
                <div id="systemMessagesList">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th class="sort" data-sort="message">Message <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sort" data-sort="start_date">Start Date <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sort" data-sort="end_date">End Date <i class="bi bi-arrow-down-up"></i></th>
                                    <th class="sort" data-sort="status">Status <i class="bi bi-arrow-down-up"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody class="list">
            `;
            
            result.messages.forEach((msg, index) => {
                console.log(`Processing message ${index + 1}:`, msg);
                
                // Check if message is currently visible (active and within date range)
                const now = new Date();
                const startDate = msg.start_date ? new Date(msg.start_date) : null;
                const endDate = msg.end_date ? new Date(msg.end_date) : null;
                const isWithinDateRange = startDate && endDate ? (now >= startDate && now <= endDate) : false;
                const isCurrentlyVisible = msg.status === 1 && isWithinDateRange;
                
                let statusBadge = '';
                let statusText = '';
                if (msg.status === undefined) {
                    // Handle case where status is missing
                    statusBadge = '<span class="badge bg-warning">Unknown Status</span>';
                    statusText = 'Unknown';
                } else if (msg.status === 1) {
                    if (!startDate || !endDate) {
                        statusBadge = '<span class="badge bg-info">Active (No Dates)</span>';
                        statusText = 'Active (No Dates)';
                    } else if (isWithinDateRange) {
                        statusBadge = '<span class="badge bg-success">Active & Visible</span>';
                        statusText = 'Active & Visible';
                    } else if (now < startDate) {
                        statusBadge = '<span class="badge bg-warning">Active (Future)</span>';
                        statusText = 'Active (Future)';
                    } else {
                        statusBadge = '<span class="badge bg-secondary">Active (Expired)</span>';
                        statusText = 'Active (Expired)';
                    }
                } else {
                    statusBadge = '<span class="badge bg-secondary">Inactive</span>';
                    statusText = 'Inactive';
                }
                
                // Format dates in m/d/y h:i A format
                const formatDate = (date) => {
                    if (!date) return 'Not Available';
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const year = date.getFullYear();
                    let hours = date.getHours();
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12;
                    hours = hours ? hours : 12; // 0 should be 12
                    return `${month}/${day}/${year} ${hours}:${minutes} ${ampm}`;
                };
                
                const startDateStr = formatDate(startDate);
                const endDateStr = formatDate(endDate);
                console.log(`Dates - Start: ${startDateStr}, End: ${endDateStr}`);
                
                tableHTML += `
                    <tr${isCurrentlyVisible ? ' class="table-success"' : ''}>
                        <td class="message">${msg.message}</td>
                        <td class="start_date" data-timestamp="${startDate ? startDate.getTime() : 0}">${startDateStr}</td>
                        <td class="end_date" data-timestamp="${endDate ? endDate.getTime() : 0}">${endDateStr}</td>
                        <td class="status" data-status="${statusText}">${statusBadge}</td>
                        <td>
                            ${msg.status !== undefined ? 
                                (msg.status === 0 ? 
                                    `<button class="btn btn-sm btn-outline-success me-1" onclick="toggleSystemMessage(${msg.id}, 1)" title="Activate">
                                        <i class="bi bi-check-circle"></i>
                                    </button>` : 
                                    `<button class="btn btn-sm btn-outline-warning me-1" onclick="toggleSystemMessage(${msg.id}, 0)" title="Deactivate">
                                        <i class="bi bi-pause-circle"></i>
                                    </button>`) :
                                '<span class="text-muted">No actions available</span>'
                            }
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSystemMessage(${msg.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <small class="text-muted">Showing <span class="list-count"></span> of ${result.messages.length} messages</small>
                        </div>
                        <ul class="pagination pagination-sm mb-0"></ul>
                    </div>
                </div>
            `;
            
            console.log('Setting table HTML, length:', tableHTML.length);
            tableDiv.innerHTML = tableHTML;
            console.log('Table HTML set successfully');
            
            // Initialize list.js with pagination
            const options = {
                valueNames: ['message', 'start_date', 'end_date', 'status'],
                page: 10,
                pagination: true,
                searchClass: 'search',
                sortClass: 'sort'
            };
            
            // If systemMessagesList exists, destroy it first
            if (systemMessagesList) {
                systemMessagesList = null;
            }
            
            // Create new list.js instance
            systemMessagesList = new List('messagesCollapse', options);
            
            // Update count display
            systemMessagesList.on('updated', function(list) {
                document.querySelector('.list-count').textContent = list.matchingItems.length;
            });
            
            // Initial count update
            document.querySelector('.list-count').textContent = systemMessagesList.matchingItems.length;
            
        } else {
            tableDiv.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-2">No system messages found.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading system messages:', error);
        document.getElementById('systemMessagesTable').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error loading system messages: ${error.message}
            </div>
        `;
    }
}

async function saveSystemMessage() {
    const message = document.getElementById('systemMessageText').value.trim();
    const startDate = document.getElementById('systemMessageStartDate').value;
    const endDate = document.getElementById('systemMessageEndDate').value;
    
    if (!message || !startDate || !endDate) {
        alert('Please fill in all fields.');
        return;
    }
    
    if (new Date(endDate) <= new Date(startDate)) {
        alert('End date must be after start date.');
        return;
    }
    
    try {
        const response = await fetch('/admin/api/system_messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                start_date: startDate,
                end_date: endDate
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Save system message response:', result);
        
        if (result.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addSystemMessageModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('addSystemMessageForm').reset();
            
            // Reload messages
            loadAdminSystemMessages();
            
            // Show success message using showToast if available
            if (typeof showToast === 'function') {
                showToast('System message created successfully!', 'success');
            } else {
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="bi bi-check-circle"></i> System message created successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                document.querySelector('#systemMessagesTable').parentNode.insertBefore(alert, document.querySelector('#systemMessagesTable'));
            }
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
            
        } else {
            const errorMsg = result.error || 'Failed to save system message';
            console.error('Save failed:', errorMsg);
            if (typeof showToast === 'function') {
                showToast('Error: ' + errorMsg, 'danger');
            } else {
                alert('Error: ' + errorMsg);
            }
        }
        
    } catch (error) {
        console.error('Error saving system message:', error);
        if (typeof showToast === 'function') {
            showToast('Error saving system message: ' + error.message, 'danger');
        } else {
            alert('Error saving system message: ' + error.message);
        }
    }
}

async function deleteSystemMessage(messageId) {
    if (!confirm('Are you sure you want to delete this system message?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/system_messages/${messageId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadAdminSystemMessages();
        } else {
            alert('Error: ' + result.error);
        }
        
    } catch (error) {
        console.error('Error deleting system message:', error);
        alert('Error deleting system message: ' + error.message);
    }
}

async function toggleSystemMessage(messageId, newStatus) {
    const action = newStatus === 1 ? 'activate' : 'deactivate';
    if (!confirm(`Are you sure you want to ${action} this system message?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/system_messages/${messageId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            loadAdminSystemMessages();  // Refresh the list
        } else {
            alert('Error: ' + result.error);
        }
        
    } catch (error) {
        console.error('Error toggling system message:', error);
        alert('Error toggling system message: ' + error.message);
    }
}

// Cost Management Functions
function updateUserCredits(userId, newCredits) {
    fetch(`/admin/api/users/${userId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({credits: Math.round(parseFloat(newCredits))})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Credits updated successfully', 'success');
        } else {
            showToast('Failed to update credits: ' + (data.error || 'Unknown error'), 'danger');
            loadUsers(currentPage); // Reload to show correct value
        }
    })
    .catch(error => {
        console.error('Error updating credits:', error);
        showToast('Error updating credits', 'danger');
        loadUsers(currentPage); // Reload to show correct value
    });
}

async function loadCostSettings() {
    try {
        // Load compute cost
        const computeResponse = await fetch('/admin/api/compute_cost');
        const computeData = await computeResponse.json();
        if (computeData.cost_per_second) {
            document.getElementById('computeCostPerSecond').value = computeData.cost_per_second;
        }
        
        // Load AI costs
        loadAICosts();
        
        // Load credit statistics
        loadCreditStats();
        
    } catch (error) {
        console.error('Error loading cost settings:', error);
    }
}

// Global variable for list.js instance
let aiCostsList = null;

async function loadAICosts() {
    try {
        const response = await fetch('/admin/api/ai_costs');
        const data = await response.json();
        
        const tbody = document.querySelector('#aiCostsTable tbody');
        
        // Check if response contains error
        if (data.error) {
            console.error('API Error:', data.error);
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading AI costs: ' + data.error + '</td></tr>';
            return;
        }
        
        if (data.costs && data.costs.length > 0) {
            // Generate HTML rows for the table
            tbody.innerHTML = data.costs.map(cost => `
                <tr>
                    <td class="vendor">${cost.vendor || 'Unknown'}</td>
                    <td class="model">${cost.model || 'Unknown'}</td>
                    <td class="input-cost">$${typeof cost.input_token_cost_per_million_tokens === 'number' ? cost.input_token_cost_per_million_tokens.toFixed(6) : '0.000000'}</td>
                    <td class="output-cost">$${typeof cost.output_token_cost_per_million_tokens === 'number' ? cost.output_token_cost_per_million_tokens.toFixed(6) : '0.000000'}</td>
                    <td class="updated">${cost.updated_at ? new Date(cost.updated_at).toLocaleDateString() : 'Unknown'}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-primary" onclick="editAICost(${cost.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAICost(${cost.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Initialize or reinitialize list.js
            if (aiCostsList) {
                aiCostsList.reIndex();
            } else {
                // Initialize list.js for the first time
                const options = {
                    valueNames: ['vendor', 'model', 'input-cost', 'output-cost', 'updated'],
                    page: 10, // Show 10 items per page
                    pagination: true
                };
                
                aiCostsList = new List('aiCostsList', options);
                
                // Update pagination styling after initialization
                setTimeout(() => {
                    updateListInfo();
                    // Listen for search and pagination events
                    aiCostsList.on('searchComplete', updateListInfo);
                    aiCostsList.on('updated', updateListInfo);
                }, 100);
            }
            
            // Update the info display
            updateListInfo();
            
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No AI costs configured</td></tr>';
            if (aiCostsList) {
                aiCostsList.clear();
            }
        }
    } catch (error) {
        console.error('Error loading AI costs:', error);
        const tbody = document.querySelector('#aiCostsTable tbody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading AI costs</td></tr>';
        }
    }
}

function updateListInfo() {
    if (aiCostsList) {
        const showing = aiCostsList.visibleItems.length;
        const total = aiCostsList.size();
        
        document.querySelector('.list-showing').textContent = showing;
        document.querySelector('.list-total').textContent = total;
    }
}

async function loadCreditStats() {
    try {
        const response = await fetch('/admin/api/credit_stats');
        const data = await response.json();
        
        // Check if response contains error
        if (data.error) {
            console.error('API Error:', data.error);
            document.getElementById('totalCredits').textContent = 'Error loading';
            document.getElementById('avgCredits').textContent = 'Error loading';
            document.getElementById('weeklyCreditsAdded').textContent = 'Error loading';
            return;
        }
        
        // Safely handle potentially undefined values
        const totalCredits = typeof data.total_credits === 'number' ? data.total_credits : 0;
        const avgCredits = typeof data.avg_credits === 'number' ? data.avg_credits : 0;
        const userCount = typeof data.user_count === 'number' ? data.user_count : 0;
        
        document.getElementById('totalCredits').textContent = `${Math.round(totalCredits)}`;
        document.getElementById('avgCredits').textContent = `${Math.round(avgCredits)}`;
        document.getElementById('weeklyCreditsAdded').textContent = `${userCount * 5}`;
        
        // Load cost charts if available
        if (data.cost_by_type && typeof data.cost_by_type === 'object') {
            renderCostByTypeChart(data.cost_by_type);
        }
        if (data.cost_by_vendor && typeof data.cost_by_vendor === 'object') {
            renderCostByVendorChart(data.cost_by_vendor);
        }
        
    } catch (error) {
        console.error('Error loading credit stats:', error);
        document.getElementById('totalCredits').textContent = 'Error loading';
        document.getElementById('avgCredits').textContent = 'Error loading';
        document.getElementById('weeklyCreditsAdded').textContent = 'Error loading';
    }
}

// Compute cost form submission
document.getElementById('computeCostForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const costPerSecond = document.getElementById('computeCostPerSecond').value;
    
    try {
        const response = await fetch('/admin/api/compute_cost', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({cost_per_second: parseFloat(costPerSecond)})
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('Compute cost updated successfully', 'success');
        } else {
            showToast('Failed to update compute cost: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error updating compute cost:', error);
        showToast('Error updating compute cost', 'danger');
    }
});

async function updateOpenAIPricing() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i> Updating...';
    
    try {
        const response = await fetch('/admin/api/update_openai_pricing', {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('OpenAI pricing updated successfully', 'success');
            loadAICosts(); // Reload the table
        } else {
            showToast('Failed to update pricing: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error updating OpenAI pricing:', error);
        showToast('Error updating OpenAI pricing', 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Update OpenAI Pricing';
    }
}

async function addWeeklyCredits() {
    if (!confirm('Add $5.00 credits to all active users?')) {
        return;
    }
    
    try {
        const response = await fetch('/admin/api/add_weekly_credits', {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
            showToast(`Added 5 credits to ${data.users_updated} users`, 'success');
            loadCreditStats(); // Reload stats
            loadUsers(currentPage); // Reload user list
        } else {
            showToast('Failed to add credits: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error adding weekly credits:', error);
        showToast('Error adding weekly credits', 'danger');
    }
}

async function deleteAICost(id) {
    if (!confirm('Are you sure you want to delete this AI model cost?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/ai_costs/${id}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('AI model cost deleted successfully', 'success');
            loadAICosts(); // Reload the table
        } else {
            showToast('Failed to delete AI model cost: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error deleting AI model cost:', error);
        showToast('Error deleting AI model cost', 'danger');
    }
}

function openAddAICostModal() {
    // Reset the form for new entry
    document.getElementById('aiCostForm').reset();
    document.getElementById('aiCostId').value = '';
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('addAICostModal'));
    modal.show();
}

async function editAICost(id) {
    try {
        const response = await fetch(`/admin/api/ai_costs/${id}`);
        const data = await response.json();
        
        if (data.cost) {
            // Populate the form with existing data
            document.getElementById('aiCostId').value = data.cost.id;
            document.getElementById('aiVendor').value = data.cost.vendor || '';
            document.getElementById('aiModel').value = data.cost.model || '';
            document.getElementById('inputCost').value = data.cost.input_token_cost_per_million_tokens || 0;
            document.getElementById('outputCost').value = data.cost.output_token_cost_per_million_tokens || 0;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('addAICostModal'));
            modal.show();
        } else {
            showToast('Failed to load AI model cost details', 'danger');
        }
    } catch (error) {
        console.error('Error loading AI model cost:', error);
        showToast('Error loading AI model cost details', 'danger');
    }
}

async function saveAICost() {
    const id = document.getElementById('aiCostId').value;
    const vendor = document.getElementById('aiVendor').value;
    const model = document.getElementById('aiModel').value;
    const inputCost = parseFloat(document.getElementById('inputCost').value);
    const outputCost = parseFloat(document.getElementById('outputCost').value);
    
    if (!vendor || !model || isNaN(inputCost) || isNaN(outputCost)) {
        showToast('Please fill in all fields with valid values', 'danger');
        return;
    }
    
    try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/admin/api/ai_costs/${id}` : '/admin/api/ai_costs';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                vendor: vendor,
                model: model,
                input_token_cost_per_million_tokens: inputCost,
                output_token_cost_per_million_tokens: outputCost
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showToast(`AI model cost ${id ? 'updated' : 'created'} successfully`, 'success');
            
            // Hide the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addAICostModal'));
            modal.hide();
            
            // Reset the form
            document.getElementById('aiCostForm').reset();
            document.getElementById('aiCostId').value = '';
            
            // Reload the table
            loadAICosts();
        } else {
            showToast(`Failed to ${id ? 'update' : 'create'} AI model cost: ` + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error saving AI model cost:', error);
        showToast('Error saving AI model cost', 'danger');
    }
}

function renderCostByTypeChart(data) {
    const ctx = document.getElementById('costByTypeChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data),
            datasets: [{
                data: Object.values(data),
                backgroundColor: [
                    '#007bff',
                    '#28a745',
                    '#ffc107',
                    '#dc3545'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Costs by Type'
                }
            }
        }
    });
}

function renderCostByVendorChart(data) {
    const ctx = document.getElementById('costByVendorChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(data),
            datasets: [{
                label: 'Total Cost ($)',
                data: Object.values(data),
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Costs by AI Vendor'
                }
            }
        }
    });
}

// Stripe Configuration Functions
async function loadStripeConfig() {
    try {
        const response = await fetch('/admin/api/stripe_config');
        const result = await response.json();
        
        if (result.success && result.config) {
            // Set current mode
            const currentMode = result.config.mode || 'test';
            document.querySelector(`input[name="stripeMode"][value="${currentMode}"]`).checked = true;
            
            // Don't populate input fields with truncated previews - leave them empty
            // Users must enter complete keys manually to avoid saving truncated versions
            
            // Clear all input fields to prevent accidental saving of truncated keys
            document.getElementById('testPublishableKey').value = '';
            document.getElementById('testSecretKey').value = '';
            document.getElementById('testWebhookSecret').value = '';
            document.getElementById('livePublishableKey').value = '';
            document.getElementById('liveSecretKey').value = '';
            document.getElementById('liveWebhookSecret').value = '';
            
            // Update key visibility status based on whether keys exist
            updateStripeKeyStatus('testPublishableKey', result.config.test.has_publishable_key);
            updateStripeKeyStatus('testSecretKey', result.config.test.has_secret_key);
            updateStripeKeyStatus('testWebhookSecret', result.config.test.has_webhook_secret);
            
            // Update key visibility status for live keys
            updateStripeKeyStatus('livePublishableKey', result.config.live.has_publishable_key);
            updateStripeKeyStatus('liveSecretKey', result.config.live.has_secret_key);
            updateStripeKeyStatus('liveWebhookSecret', result.config.live.has_webhook_secret);
            
            // Add placeholder text to indicate keys are configured but hidden for security
            if (result.config.test.has_publishable_key) {
                document.getElementById('testPublishableKey').placeholder = 'Key configured - enter new key to update';
            }
            if (result.config.test.has_secret_key) {
                document.getElementById('testSecretKey').placeholder = 'Key configured - enter new key to update';
            }
            if (result.config.test.has_webhook_secret) {
                document.getElementById('testWebhookSecret').placeholder = 'Key configured - enter new key to update';
            }
            if (result.config.live.has_publishable_key) {
                document.getElementById('livePublishableKey').placeholder = 'Key configured - enter new key to update';
            }
            if (result.config.live.has_secret_key) {
                document.getElementById('liveSecretKey').placeholder = 'Key configured - enter new key to update';
            }
            if (result.config.live.has_webhook_secret) {
                document.getElementById('liveWebhookSecret').placeholder = 'Key configured - enter new key to update';
            }
            
            // Update mode indicator
            updateModeIndicator(currentMode);
        }
    } catch (error) {
        console.error('Error loading Stripe config:', error);
        showToast('Error loading Stripe configuration', 'danger');
    }
}

function updateStripeKeyStatus(fieldId, value) {
    const field = document.getElementById(fieldId);
    const statusIcon = field.parentElement.querySelector('.input-group-text i');
    
    if (value) {
        // Key is set
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        if (statusIcon) {
            statusIcon.className = 'bi bi-check-circle text-success';
        }
    } else {
        // Key is not set
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        if (statusIcon) {
            statusIcon.className = 'bi bi-x-circle text-danger';
        }
    }
}

function updateModeIndicator(mode) {
    // Get current configuration via API to update status badges
    fetch('/admin/api/stripe_config')
        .then(response => response.json())
        .then(result => {
            if (result.success && result.config) {
                // Update live status badge
                const liveStatus = document.getElementById('liveStatus');
                const liveIsConfigured = result.config.live.has_publishable_key && 
                                       result.config.live.has_secret_key && 
                                       result.config.live.has_webhook_secret;
                
                if (liveIsConfigured) {
                    liveStatus.textContent = 'Configured';
                    liveStatus.className = 'badge bg-success ms-2';
                } else {
                    liveStatus.textContent = 'Not Configured';
                    liveStatus.className = 'badge bg-light text-danger ms-2';
                }
                
                // Update test status badge
                const testStatus = document.getElementById('testStatus');
                const testIsConfigured = result.config.test.has_publishable_key && 
                                        result.config.test.has_secret_key && 
                                        result.config.test.has_webhook_secret;
                
                if (testIsConfigured) {
                    testStatus.textContent = 'Configured';
                    testStatus.className = 'badge bg-success ms-2';
                } else {
                    testStatus.textContent = 'Not Configured';
                    testStatus.className = 'badge bg-light text-warning ms-2';
                }
                
                // Update mode display
                const currentMode = result.config.mode || 'test';
                const modeText = currentMode === 'live' ? 'LIVE' : 'TEST';
                console.log(`Stripe mode indicator updated: ${modeText} mode`);
            }
        })
        .catch(error => {
            console.error('Error updating mode indicator:', error);
        });
}

function toggleKeyVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.parentElement.querySelector('button');
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'bi bi-eye';
    }
}


// Add event listeners for mode changes
document.addEventListener('DOMContentLoaded', function() {
    // Listen for mode changes - save to server immediately
    document.querySelectorAll('input[name="stripeMode"]').forEach(radio => {
        radio.addEventListener('change', async function() {
            if (this.checked) {
                const modeText = this.value === 'live' ? 'LIVE' : 'TEST';
                console.log(`Stripe mode changed to: ${modeText}`);
                
                try {
                    const response = await fetch('/admin/api/stripe_config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            mode: this.value
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(`Stripe mode updated to ${modeText}`, 'success');
                        updateModeIndicator(this.value);
                    } else {
                        showToast('Error: ' + (result.error || 'Failed to update Stripe mode'), 'danger');
                        // Revert the radio button
                        loadStripeConfig();
                    }
                } catch (error) {
                    console.error('Error updating Stripe mode:', error);
                    showToast('Error updating Stripe mode: ' + error.message, 'danger');
                    // Revert the radio button
                    loadStripeConfig();
                }
            }
        });
    });
});

// Stripe configuration form submission
document.getElementById('stripeConfigForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Get selected mode
    const selectedMode = document.querySelector('input[name="stripeMode"]:checked').value;
    
    // Get test keys
    const testKeys = {
        publishable_key: document.getElementById('testPublishableKey').value.trim(),
        secret_key: document.getElementById('testSecretKey').value.trim(),
        webhook_secret: document.getElementById('testWebhookSecret').value.trim()
    };
    
    // Get live keys
    const liveKeys = {
        publishable_key: document.getElementById('livePublishableKey').value.trim(),
        secret_key: document.getElementById('liveSecretKey').value.trim(),
        webhook_secret: document.getElementById('liveWebhookSecret').value.trim()
    };
    
    // Check if at least one key is provided
    const hasTestKeys = testKeys.publishable_key || testKeys.secret_key || testKeys.webhook_secret;
    const hasLiveKeys = liveKeys.publishable_key || liveKeys.secret_key || liveKeys.webhook_secret;
    
    if (!hasTestKeys && !hasLiveKeys) {
        showToast('Please provide at least one Stripe API key to update the configuration', 'warning');
        return;
    }
    
    // Validate test keys format
    if (testKeys.publishable_key && !testKeys.publishable_key.startsWith('pk_test_')) {
        showToast('Invalid test publishable key format. Must start with pk_test_', 'danger');
        return;
    }
    
    if (testKeys.secret_key && !testKeys.secret_key.startsWith('sk_test_')) {
        showToast('Invalid test secret key format. Must start with sk_test_', 'danger');
        return;
    }
    
    if (testKeys.webhook_secret && !testKeys.webhook_secret.startsWith('whsec_')) {
        showToast('Invalid test webhook secret format. Must start with whsec_', 'danger');
        return;
    }
    
    // Validate live keys format
    if (liveKeys.publishable_key && !liveKeys.publishable_key.startsWith('pk_live_')) {
        showToast('Invalid live publishable key format. Must start with pk_live_', 'danger');
        return;
    }
    
    if (liveKeys.secret_key && !liveKeys.secret_key.startsWith('sk_live_')) {
        showToast('Invalid live secret key format. Must start with sk_live_', 'danger');
        return;
    }
    
    if (liveKeys.webhook_secret && !liveKeys.webhook_secret.startsWith('whsec_')) {
        showToast('Invalid live webhook secret format. Must start with whsec_', 'danger');
        return;
    }
    
    const data = {
        mode: selectedMode,
        test_keys: testKeys,
        live_keys: liveKeys
    };
    
    try {
        const response = await fetch('/admin/api/stripe_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            const modeText = selectedMode === 'live' ? 'LIVE' : 'TEST';
            const message = result.message || `Stripe configuration updated successfully (${modeText} mode)`;
            showToast(message, 'success');
            
            // Update field status indicators for test keys
            updateStripeKeyStatus('testPublishableKey', testKeys.publishable_key);
            updateStripeKeyStatus('testSecretKey', testKeys.secret_key);
            updateStripeKeyStatus('testWebhookSecret', testKeys.webhook_secret);
            
            // Update field status indicators for live keys
            updateStripeKeyStatus('livePublishableKey', liveKeys.publishable_key);
            updateStripeKeyStatus('liveSecretKey', liveKeys.secret_key);
            updateStripeKeyStatus('liveWebhookSecret', liveKeys.webhook_secret);
            
            // Update mode indicator
            updateModeIndicator(selectedMode);
        } else {
            showToast('Error: ' + (result.error || 'Failed to update Stripe configuration'), 'danger');
        }
    } catch (error) {
        console.error('Error updating Stripe config:', error);
        showToast('Error: ' + error.message, 'danger');
    }
});

// Load data when settings tab is shown
document.addEventListener('DOMContentLoaded', function() {
    // Load service settings when settings tab is shown
    // Note: loadSystemMessages is already called in the other settings-tab listener
    
    // Load cost settings when costs tab is shown
    document.getElementById('costs-tab').addEventListener('shown.bs.tab', function() {
        loadCostSettings();
    });
    
    // Set default dates for new messages (start: now, end: 1 week from now)
    const now = new Date();
    const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    // Format for datetime-local input
    const formatForInput = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    };
    
    document.getElementById('systemMessageStartDate').value = formatForInput(now);
    document.getElementById('systemMessageEndDate').value = formatForInput(nextWeek);
});

// Dynamic tab loading
const loadedTabs = new Set();

// Debug function to force reload a tab
window.forceReloadTab = function(tabId) {
    console.log(`Force reloading tab: ${tabId}`);
    loadedTabs.delete(tabId);
    const contentDiv = document.getElementById(tabId + 'Content');
    if (contentDiv) {
        contentDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading...</p></div>';
    }
    
    const urls = {
        'logs': '/admin/templates/logs',
        'sql': '/admin/templates/sql', 
        'status': '/admin/templates/system-status'
    };
    
    if (urls[tabId]) {
        loadTabContent(tabId, urls[tabId]);
    }
};

// Debug function to check tab visibility
window.debugTabVisibility = function(tabId) {
    const tabPane = document.getElementById(tabId);
    const contentDiv = document.getElementById(tabId + 'Content');
    const tabButton = document.getElementById(tabId + '-tab');
    
    console.log(`=== Tab Visibility Debug for: ${tabId} ===`);
    console.log('Tab pane:', tabPane);
    console.log('Tab pane classes:', tabPane ? tabPane.className : 'NOT FOUND');
    console.log('Tab pane style.display:', tabPane ? tabPane.style.display : 'NOT FOUND');
    console.log('Tab pane computed style:', tabPane ? window.getComputedStyle(tabPane).display : 'NOT FOUND');
    console.log('Content div:', contentDiv);
    console.log('Content div innerHTML length:', contentDiv ? contentDiv.innerHTML.length : 'NOT FOUND');
    console.log('Content div visible:', contentDiv ? contentDiv.offsetParent !== null : 'NOT FOUND');
    
    if (contentDiv) {
        const computedStyle = window.getComputedStyle(contentDiv);
        console.log('Content div computed styles:');
        console.log('  display:', computedStyle.display);
        console.log('  visibility:', computedStyle.visibility);
        console.log('  opacity:', computedStyle.opacity);
        console.log('  height:', computedStyle.height);
        console.log('  overflow:', computedStyle.overflow);
        console.log('  position:', computedStyle.position);
        console.log('Content div bounding rect:', contentDiv.getBoundingClientRect());
    }
    
    console.log('Tab button:', tabButton);
    console.log('Tab button classes:', tabButton ? tabButton.className : 'NOT FOUND');
    console.log('Tab button aria-selected:', tabButton ? tabButton.getAttribute('aria-selected') : 'NOT FOUND');
    
    // Check if Bootstrap tab is actually active
    const activeTab = document.querySelector('#adminTabs .nav-link.active');
    console.log('Currently active tab:', activeTab ? activeTab.id : 'NONE');
    
    return {
        tabPane,
        contentDiv,
        tabButton,
        isVisible: tabPane ? tabPane.offsetParent !== null : false,
        hasContent: contentDiv ? contentDiv.innerHTML.length > 100 : false
    };
};

// Quick fix function to try making content visible
window.fixTabVisibility = function(tabId) {
    const contentDiv = document.getElementById(tabId + 'Content');
    if (contentDiv) {
        console.log(`Attempting to fix visibility for: ${tabId}`);
        contentDiv.style.display = 'block';
        contentDiv.style.visibility = 'visible';
        contentDiv.style.opacity = '1';
        contentDiv.style.height = 'auto';
        console.log('Applied visibility fixes');
        return debugTabVisibility(tabId);
    }
};

// Debug CSS styles for logs specifically
window.debugLogsCSS = function() {
    const logContainer = document.getElementById('logContainer');
    const logsContent = document.getElementById('logsContent');
    const logsTabPane = document.getElementById('logs');
    
    console.log('=== CSS Debug for Logs ===');
    
    if (logContainer) {
        const style = window.getComputedStyle(logContainer);
        console.log('logContainer computed styles:');
        console.log('  display:', style.display);
        console.log('  visibility:', style.visibility);
        console.log('  opacity:', style.opacity);
        console.log('  height:', style.height);
        console.log('  background-color:', style.backgroundColor);
        console.log('  color:', style.color);
        console.log('  z-index:', style.zIndex);
        console.log('  position:', style.position);
        console.log('  overflow:', style.overflow);
        console.log('  innerHTML length:', logContainer.innerHTML.length);
        console.log('  scrollHeight:', logContainer.scrollHeight);
        console.log('  clientHeight:', logContainer.clientHeight);
        console.log('  children count:', logContainer.children.length);
        
        // Check if any log lines exist
        const logLines = logContainer.querySelectorAll('.log-line');
        console.log('  log-line elements:', logLines.length);
        if (logLines.length > 0) {
            const firstLine = logLines[0];
            const lineStyle = window.getComputedStyle(firstLine);
            console.log('  first log-line styles:');
            console.log('    display:', lineStyle.display);
            console.log('    visibility:', lineStyle.visibility);
            console.log('    color:', lineStyle.color);
            console.log('    innerHTML:', firstLine.innerHTML);
        }
    }
    
    if (logsContent) {
        const style = window.getComputedStyle(logsContent);
        console.log('logsContent computed styles:');
        console.log('  display:', style.display);
        console.log('  visibility:', style.visibility);
        console.log('  opacity:', style.opacity);
    }
    
    if (logsTabPane) {
        const style = window.getComputedStyle(logsTabPane);
        console.log('logs tab pane computed styles:');
        console.log('  display:', style.display);
        console.log('  visibility:', style.visibility);
        console.log('  opacity:', style.opacity);
    }
};

// Force fix logs visibility with contrast
window.forceFixLogs = function() {
    const logContainer = document.getElementById('logContainer');
    if (logContainer) {
        // Force visibility and contrast
        logContainer.style.display = 'block';
        logContainer.style.visibility = 'visible';
        logContainer.style.opacity = '1';
        logContainer.style.backgroundColor = '#000000';  // Black background
        logContainer.style.color = '#ffffff';            // White text
        logContainer.style.border = '2px solid red';     // Debug border
        logContainer.style.minHeight = '200px';
        logContainer.style.padding = '10px';
        
        // Force all log lines to be visible
        const logLines = logContainer.querySelectorAll('.log-line');
        logLines.forEach(line => {
            line.style.display = 'block';
            line.style.visibility = 'visible';
            line.style.color = '#ffffff';
            line.style.backgroundColor = '#333333';
            line.style.padding = '5px';
            line.style.margin = '2px 0';
            line.style.border = '1px solid yellow';  // Debug border
        });
        
        console.log('Applied force fix to logs with', logLines.length, 'lines');
        return logContainer;
    }
};

// Simple test to show something in the logs tab
window.testLogsTab = function() {
    const logsContent = document.getElementById('logsContent');
    if (logsContent) {
        logsContent.innerHTML = `
            <div style="background: red; color: white; padding: 20px; border: 5px solid yellow; font-size: 20px; font-weight: bold;">
                TEST: If you can see this, the tab loading works!
                <br>Current time: ${new Date().toLocaleString()}
                <br>Tab is visible and functional.
            </div>
        `;
        console.log('Test content added to logsContent');
        return true;
    } else {
        console.error('logsContent div not found');
        return false;
    }
};

// Full DOM structure debugging
window.debugTabStructure = function() {
    console.log('=== Full Tab Structure Debug ===');
    
    const logsTab = document.getElementById('logs');
    const logsContent = document.getElementById('logsContent');
    const logContainer = document.getElementById('logContainer');
    const adminTabs = document.getElementById('adminTabs');
    
    console.log('Admin tabs container:', adminTabs);
    console.log('Logs tab pane:', logsTab);
    console.log('Logs content div:', logsContent);
    console.log('Log container:', logContainer);
    
    if (logsTab) {
        console.log('Logs tab pane HTML length:', logsTab.innerHTML.length);
        console.log('Logs tab pane classes:', logsTab.className);
        console.log('Logs tab pane offsetHeight:', logsTab.offsetHeight);
        console.log('Logs tab pane scrollHeight:', logsTab.scrollHeight);
        
        // Check if tab pane is actually visible
        const rect = logsTab.getBoundingClientRect();
        console.log('Logs tab pane bounding rect:', rect);
        console.log('Logs tab pane on screen:', rect.width > 0 && rect.height > 0);
    }
    
    if (logsContent) {
        console.log('Logs content HTML length:', logsContent.innerHTML.length);
        console.log('Logs content offsetHeight:', logsContent.offsetHeight);
        console.log('Logs content scrollHeight:', logsContent.scrollHeight);
        
        const rect = logsContent.getBoundingClientRect();
        console.log('Logs content bounding rect:', rect);
        console.log('Logs content on screen:', rect.width > 0 && rect.height > 0);
    }
    
    // Check what's currently active
    const activeTab = document.querySelector('#adminTabs .nav-link.active');
    const activePane = document.querySelector('.tab-pane.active.show');
    
    console.log('Currently active tab button:', activeTab ? activeTab.id : 'none');
    console.log('Currently active tab pane:', activePane ? activePane.id : 'none');
};

function loadTabContent(tabId, templateUrl) {
    console.log(`Loading tab content for: ${tabId} from ${templateUrl}`);
    
    const contentDivId = tabId + 'Content';
    const contentDiv = document.getElementById(contentDivId);
    
    // Check if already loaded AND content still exists
    if (loadedTabs.has(tabId) && contentDiv && contentDiv.innerHTML.includes('card')) {
        console.log(`Tab ${tabId} already loaded and content exists, skipping`);
        // Make sure the tab pane is visible
        ensureTabPaneVisible(tabId);
        // Trigger initialization for already loaded content
        setTimeout(() => {
            initializeTabContent(tabId);
        }, 100);
        return;
    }
    
    if (loadedTabs.has(tabId)) {
        console.log(`Tab ${tabId} was marked as loaded but content missing, reloading...`);
        loadedTabs.delete(tabId); // Remove from loaded set so we can reload
    }
    
    console.log(`Looking for content div: ${contentDivId}`, contentDiv);
    
    if (!contentDiv) {
        console.error('Content div not found for tab:', tabId, 'Expected ID:', contentDivId);
        return;
    }
    
    console.log(`Fetching template from: ${templateUrl}`);
    fetch(templateUrl)
        .then(response => {
            console.log(`Fetch response for ${tabId}:`, response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.text();
        })
        .then(html => {
            console.log(`Template HTML received for ${tabId}, length:`, html.length);
            console.log(`HTML preview:`, html.substring(0, 200) + '...');
            contentDiv.innerHTML = html;
            loadedTabs.add(tabId);
            console.log(`Tab ${tabId} loaded successfully and marked as loaded`);
            
            // Ensure tab pane is visible
            ensureTabPaneVisible(tabId);
            
            // Initialize the loaded content after ensuring visibility
            setTimeout(() => {
                initializeTabContent(tabId);
            }, 200);
        })
        .catch(error => {
            console.error(`Error loading tab ${tabId}:`, error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Error loading content:</strong> ${error.message}
                    <br><small>Tab: ${tabId}, URL: ${templateUrl}</small>
                </div>
            `;
        });
}

// Ensure the Bootstrap tab pane is visible
function ensureTabPaneVisible(tabId) {
    const tabPane = document.getElementById(tabId);
    if (tabPane) {
        // Make sure the tab pane has the right classes to be visible
        if (!tabPane.classList.contains('show')) {
            console.log(`Making tab pane ${tabId} visible`);
            tabPane.classList.add('show', 'active');
        }
        
        // Also ensure the parent tab content container is visible
        const tabContent = tabPane.closest('.tab-content');
        if (tabContent) {
            tabContent.style.display = 'block';
        }
        
        console.log(`Tab pane ${tabId} classes:`, tabPane.className);
        console.log(`Tab pane ${tabId} computed display:`, window.getComputedStyle(tabPane).display);
    } else {
        console.error(`Tab pane with ID '${tabId}' not found`);
    }
}

// Initialize tab-specific functionality after content is loaded
function initializeTabContent(tabId) {
    console.log(`Initializing content for tab: ${tabId}`);
    
    try {
        switch(tabId) {
            case 'logs':
                // Initialize logs functionality
                console.log('Checking for logs initialization functions...');
                if (typeof window.initializeLogs === 'function') {
                    console.log('Calling window.initializeLogs()');
                    window.initializeLogs();
                } else if (typeof window.loadLogs === 'function') {
                    console.log('Calling window.loadLogs()');
                    window.loadLogs();
                } else {
                    console.log('No logs initialization function found, trying direct call...');
                    // Try to trigger the logs script initialization manually
                    const scripts = document.querySelectorAll('#logsContent script');
                    if (scripts.length > 0) {
                        console.log(`Found ${scripts.length} script(s) in logs content, executing...`);
                        scripts.forEach((script, index) => {
                            try {
                                eval(script.textContent);
                                console.log(`Executed script ${index + 1}`);
                            } catch (e) {
                                console.warn(`Error executing script ${index + 1}:`, e);
                            }
                        });
                    }
                }
                break;
            case 'sql':
                // Initialize SQL functionality
                console.log('Checking for SQL initialization functions...');
                if (typeof window.loadSQLTab === 'function') {
                    console.log('Calling window.loadSQLTab()');
                    window.loadSQLTab();
                } else {
                    console.log('loadSQLTab function not found');
                }
                break;
            case 'status':
                // Initialize system status functionality
                console.log('Checking for status initialization functions...');
                if (typeof window.loadSystemStatus === 'function') {
                    console.log('Calling window.loadSystemStatus()');
                    window.loadSystemStatus();
                } else {
                    console.log('loadSystemStatus function not found');
                }
                break;
        }
    } catch (error) {
        console.error(`Error initializing ${tabId} tab:`, error);
    }
}

// Template Editor Functions
let currentTemplate = null;
let templateEditor = null;

async function loadTemplateList() {
    console.log('loadTemplateList() called');
    try {
        const response = await fetch('/admin/api/templates');
        if (!response.ok) throw new Error('Failed to load templates');
        
        const data = await response.json();
        console.log('Templates data received:', data);
        
        const selectContainer = document.getElementById('templateSelect');
        const infoContainer = document.getElementById('templateInfo');
        
        console.log('Looking for elements:', {
            templateSelect: selectContainer,
            templateInfo: infoContainer,
            templatesTab: document.getElementById('templates')
        });
        
        if (!selectContainer || !infoContainer) {
            console.error('Template elements not found!');
            // Try to force show the templates tab
            const templatesTab = document.getElementById('templates');
            if (templatesTab) {
                templatesTab.classList.add('show', 'active');
                console.log('Forced templates tab to show');
            }
            return;
        }
        
        // Populate dropdown
        let options = '<option value="">Choose a template...</option>';
        data.templates.forEach(template => {
            const selected = currentTemplate === template.name ? 'selected' : '';
            options += `
                <option value="${template.name}" ${selected}>
                    ${template.name} (${template.backup_count} backups)
                </option>
            `;
        });
        
        selectContainer.innerHTML = options;
        console.log('Template dropdown updated with', data.templates.length, 'templates');
        
        // Update info
        const formatSize = (bytes) => {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1024 / 1024).toFixed(1) + ' MB';
        };
        
        infoContainer.innerHTML = `
            <strong>${data.info.template_count}</strong> templates, 
            <strong>${formatSize(data.info.total_size)}</strong> total, 
            <strong>${data.info.total_backups}</strong> backups (${formatSize(data.info.backup_size)})
        `;
        
        console.log('Template info updated');
        
    } catch (error) {
        console.error('Error loading templates:', error);
        const infoContainer = document.getElementById('templateInfo');
        if (infoContainer) {
            infoContainer.innerHTML = `<span class="text-danger">Error loading templates: ${error.message}</span>`;
        }
    }
}

function loadSelectedTemplate() {
    const select = document.getElementById('templateSelect');
    const templateName = select.value;
    
    if (templateName) {
        loadTemplate(templateName);
    } else {
        // Hide editor when no template selected
        document.getElementById('templateEditorContainer').style.display = 'none';
        document.getElementById('templateEditorActions').style.display = 'none';
        document.getElementById('templateEditorPlaceholder').style.display = 'block';
        currentTemplate = null;
    }
}

async function loadTemplate(templateName) {
    try {
        currentTemplate = templateName;
        
        // Update dropdown selection
        const select = document.getElementById('templateSelect');
        if (select.value !== templateName) {
            select.value = templateName;
        }
        
        // Load template content
        const response = await fetch(`/admin/api/templates/${encodeURIComponent(templateName)}`);
        if (!response.ok) throw new Error('Failed to load template');
        
        const data = await response.json();
        
        // Show editor and actions
        document.getElementById('templateEditorContainer').style.display = 'block';
        document.getElementById('templateEditorActions').style.display = 'block';
        document.getElementById('templateEditorPlaceholder').style.display = 'none';
        
        // Set content
        if (!templateEditor) {
            templateEditor = document.getElementById('templateEditor');
        }
        templateEditor.value = data.content;
        
        // Update backup list
        const backupList = document.getElementById('backupList');
        if (data.backups && data.backups.length > 0) {
            let backupHtml = '';
            data.backups.forEach(backup => {
                const backupDate = new Date(backup.timestamp).toLocaleString();
                backupHtml += `
                    <li>
                        <a class="dropdown-item" href="#" 
                           onclick="restoreBackup('${templateName}', '${backup.filename}'); return false;">
                            <i class="bi bi-clock-history"></i> ${backupDate}
                            <small class="text-muted d-block">${backup.filename}</small>
                        </a>
                    </li>
                `;
            });
            backupList.innerHTML = backupHtml;
        } else {
            backupList.innerHTML = '<li><span class="dropdown-item-text">No backups available</span></li>';
        }
        
        // Clear validation messages
        document.getElementById('validationMessages').innerHTML = '';
        document.getElementById('templateVariables').innerHTML = '';
        
    } catch (error) {
        console.error('Error loading template:', error);
        alert(`Error loading template: ${error.message}`);
    }
}

async function validateTemplate() {
    if (!currentTemplate || !templateEditor) return;
    
    try {
        const content = templateEditor.value;
        
        const response = await fetch(`/admin/api/templates/${encodeURIComponent(currentTemplate)}/validate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        if (!response.ok) throw new Error('Failed to validate template');
        
        const validation = await response.json();
        
        // Show validation results
        const messagesDiv = document.getElementById('validationMessages');
        let html = '';
        
        if (validation.valid) {
            html += '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Template syntax is valid!</div>';
        }
        
        if (validation.errors && validation.errors.length > 0) {
            html += '<div class="alert alert-danger">';
            html += '<h6><i class="bi bi-exclamation-triangle"></i> Validation Errors:</h6>';
            html += '<ul class="mb-0">';
            validation.errors.forEach(error => {
                html += `<li>${escapeHtml(error)}</li>`;
            });
            html += '</ul></div>';
        }
        
        if (validation.warnings && validation.warnings.length > 0) {
            html += '<div class="alert alert-warning">';
            html += '<h6><i class="bi bi-exclamation-circle"></i> Warnings:</h6>';
            html += '<ul class="mb-0">';
            validation.warnings.forEach(warning => {
                html += `<li>${escapeHtml(warning)}</li>`;
            });
            html += '</ul></div>';
        }
        
        messagesDiv.innerHTML = html;
        
        // Show variables used
        if (validation.variables && validation.variables.length > 0) {
            const varsDiv = document.getElementById('templateVariables');
            varsDiv.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-braces"></i> Template Variables</h6>
                        <div class="d-flex flex-wrap gap-2">
                            ${validation.variables.map(v => `<span class="badge bg-secondary">${v}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error validating template:', error);
        alert(`Error validating template: ${error.message}`);
    }
}

async function saveTemplate() {
    if (!currentTemplate || !templateEditor) return;
    
    // First validate
    await validateTemplate();
    
    // Check if there are errors
    const errorAlerts = document.querySelectorAll('#validationMessages .alert-danger');
    if (errorAlerts.length > 0) {
        if (!confirm('There are validation errors. Are you sure you want to save anyway?')) {
            return;
        }
    }
    
    try {
        const content = templateEditor.value;
        
        const response = await fetch(`/admin/api/templates/${encodeURIComponent(currentTemplate)}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to save template');
        }
        
        // Show success message
        const messagesDiv = document.getElementById('validationMessages');
        messagesDiv.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> ${result.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        ` + messagesDiv.innerHTML;
        
        // Reload template list to update backup count
        loadTemplateList();
        
        // Reload current template to refresh backup list
        setTimeout(() => loadTemplate(currentTemplate), 500);
        
    } catch (error) {
        console.error('Error saving template:', error);
        alert(`Error saving template: ${error.message}`);
    }
}

async function restoreBackup(templateName, backupFilename) {
    if (!confirm(`Are you sure you want to restore this backup?\n\nThis will replace the current template with the backup from:\n${backupFilename}`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/templates/${encodeURIComponent(templateName)}/restore`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ backup_filename: backupFilename })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to restore backup');
        }
        
        // Show success message
        alert(result.message);
        
        // Reload template
        loadTemplate(templateName);
        
    } catch (error) {
        console.error('Error restoring backup:', error);
        alert(`Error restoring backup: ${error.message}`);
    }
}

async function previewTemplate() {
    if (!currentTemplate) {
        alert('Please select a template first.');
        return;
    }
    
    try {
        // Open preview in a new window/tab
        const previewUrl = `/?preview_template=${encodeURIComponent(currentTemplate)}`;
        window.open(previewUrl, '_blank');
    } catch (error) {
        console.error('Error opening preview:', error);
        alert(`Error opening preview: ${error.message}`);
    }
}

async function clearTemplateCache() {
    if (!confirm('Are you sure you want to clear the template cache?\n\nThis will clear all cached templates across the site.')) {
        return;
    }
    
    try {
        const response = await fetch('/admin/api/templates/cache/clear', {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to clear cache');
        }
        
        const result = await response.json();
        alert(result.message || 'Template cache cleared successfully');
        
    } catch (error) {
        console.error('Error clearing cache:', error);
        alert(`Error clearing cache: ${error.message}`);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Tab event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up dynamic tab loading...');
    
    // Add event listeners for the three problematic tabs
    const tabButtons = {
        'logs-tab': { tabId: 'logs', url: '/admin/templates/logs' },
        'sql-tab': { tabId: 'sql', url: '/admin/templates/sql' },
        'status-tab': { tabId: 'status', url: '/admin/templates/system-status' }
    };
    
    console.log('Tab button configuration:', tabButtons);
    
    Object.keys(tabButtons).forEach(buttonId => {
        const button = document.getElementById(buttonId);
        console.log(`Checking for button: ${buttonId}`, button);
        
        if (button) {
            // Only use the shown.bs.tab event - this is the proper Bootstrap event
            button.addEventListener('shown.bs.tab', function(event) {
                console.log(`Tab event fired for: ${buttonId}`, event);
                const config = tabButtons[buttonId];
                console.log(`Loading config:`, config);
                loadTabContent(config.tabId, config.url);
            });
            
            console.log(`Event listeners added for: ${buttonId}`);
        } else {
            console.warn(`Tab button ${buttonId} not found`);
        }
    });
    
    console.log('Dynamic tab loading initialized');
});

</script>

<!-- AI Cost Modal -->
<div class="modal fade" id="addAICostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add/Edit AI Model Cost</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="aiCostForm">
                    <input type="hidden" id="aiCostId">
                    <div class="mb-3">
                        <label for="aiVendor" class="form-label">Vendor</label>
                        <select class="form-select" id="aiVendor" required>
                            <option value="">Select vendor</option>
                            <option value="openai">OpenAI</option>
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="google">Google</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="aiModel" class="form-label">Model Name</label>
                        <input type="text" class="form-control" id="aiModel" required 
                               placeholder="e.g., gpt-4, claude-3-sonnet">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inputCost" class="form-label">Input Cost (per 1M tokens)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="inputCost" 
                                           step="0.000001" min="0" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="outputCost" class="form-label">Output Cost (per 1M tokens)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="outputCost" 
                                           step="0.000001" min="0" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAICost()">Save</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}